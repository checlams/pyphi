

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyphi &mdash; PyPhi 4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=71af5d5d"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            PyPhi
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">pyphi-master</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PyPhi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyphi</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyphi</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Phi for Python (pyPhi)</span>

<span class="sd">By Sal Garcia (sgarciam@ic.ac.uk salvadorgarciamunoz@gmail.com)</span>
<span class="sd">Added Jan 30 2025</span>
<span class="sd">        * Added a pinv alternative protection in spectra_savgol for the case where</span>
<span class="sd">          inv fails</span>
<span class="sd">Added Jan 20 2025</span>
<span class="sd">        * Added the &#39;cca&#39; flag to the pls routine to calculate CCA between</span>
<span class="sd">          the Ts and each of the Ys (one by one), calculating loadings and scores </span>
<span class="sd">          equivalent to a perfectly orthogonalized OPLS model. The covariant scores (Tcv)</span>
<span class="sd">          the covariant Loadings (Pcv) and predictive weights (Wcv) are added</span>
<span class="sd">          as keys to the model object.</span>
<span class="sd">          [The covariant loadings(Pcv) are equivalent to the predictive loadings in OPLS]</span>
<span class="sd">          </span>
<span class="sd">        * Added cca and cca-multi routines to perform PLS-CCA (alternative to OPLS)</span>
<span class="sd">          as of now cca-multi remains unused.</span>

<span class="sd">Added Nov 18th, 2024</span>
<span class="sd">        * replaced interp2d with RectBivariateSpline </span>
<span class="sd">        * Protected SPE lim calculations for near zero residuals</span>
<span class="sd">        * Added build_polynomial function to create linear regression</span>
<span class="sd">          models with variable selection assited by PLS</span>

<span class="sd">by merge from James</span>
<span class="sd">        * Added spectra preprocessing methods</span>
<span class="sd">        * bootstrap PLS</span>
<span class="sd">        </span>
<span class="sd">by Salvador Garcia (sgarciam@ic.ac.uk salvadorgarciamunoz@gmail.com)</span>
<span class="sd">Added Dec 19th 2023</span>
<span class="sd">        * phi.clean_htmls  removes all html files in the working directory</span>
<span class="sd">        * clean_empty_rows returns also the names of the rows removed</span>
<span class="sd">Added May 1st</span>
<span class="sd">        * YMB is now added in the same structure as the XMB</span>
<span class="sd">        * Corrected the dimensionality of the lwpls prediction, it was a double-nested array.</span>
<span class="sd">        </span>
<span class="sd">Added Apr 30 {feliz día de los niños}</span>
<span class="sd">        * Modified Multi-block PLS to include the block name in the variable name</span>
<span class="sd">Added Apr 29</span>
<span class="sd">        * Included the unique routine and adjusted the parse_materials routine so materials </span>
<span class="sd">          and lots are in the same order as in the raw data</span>
<span class="sd">          </span>
<span class="sd">Added Apr 27</span>
<span class="sd">        * Enhanced adapt_pls_4_pyomo to use variable names as indices if flag is sent</span>
<span class="sd">Added Apr 25</span>
<span class="sd">        * Enhanced the varimax_rotation to adjust the r2 and r2pv to the rotated loadings</span>
<span class="sd">Added Apr 21</span>
<span class="sd">        * Re added varimax_rotation with complete model rotation for PCA and PLS</span>
<span class="sd">        </span>
<span class="sd">Added Apr 17 </span>
<span class="sd">        * Added tpls and tpls_pred</span>
<span class="sd">Added Apr 15 </span>
<span class="sd">        * Added jrpls model and jrpls_pred</span>
<span class="sd">        * Added routines to reconcile columns to rows identifier so that X and R materices</span>
<span class="sd">          correspond correctly</span>
<span class="sd">        * Added routines to reconcile rows across a list of dataframes and produces a list</span>
<span class="sd">          of dataframes containing only those observations present in all dataframes</span>
<span class="sd">          </span>
<span class="sd">Added on Apr 9 2023</span>
<span class="sd">        * Added lpls and lpls_pred routines</span>
<span class="sd">        * Added parse_materials to read linear table and produce R or Ri</span>
<span class="sd">        </span>
<span class="sd">Release as of Nov 23 2022</span>
<span class="sd">        * Added a function to export PLS model to gPROMS code</span>

<span class="sd">Release as of Aug 22 2022</span>
<span class="sd">What was done:</span>
<span class="sd">        *Fixed access to NEOS server and use of GAMS instead of IPOPT</span>
<span class="sd">        </span>
<span class="sd">Release as of Aug 12 2022</span>
<span class="sd">What was done:        </span>
<span class="sd">        * Fixed the SPE calculations in pls_pred and pca_pred</span>
<span class="sd">        * Changed to a more efficient inversion in pca_pred (=pls_pred)</span>
<span class="sd">        * Added a pseudo-inverse option in pmp for pca_pred</span>
<span class="sd">        </span>
<span class="sd">Relase as of now Aug 2 2022</span>
<span class="sd">What was done:</span>
<span class="sd">        *Added replicate_data</span>

<span class="sd">Release Unknown</span>
<span class="sd">What was done:</span>
<span class="sd">        * Fixed a bug in kernel PCA calculations</span>
<span class="sd">        * Changed the syntax of MBPLS arguments</span>
<span class="sd">        * Corrected a pretty severe error in pls_pred</span>
<span class="sd">        * Fixed a really bizzare one in mbpls</span>

<span class="sd">Release Dec 5, 2021</span>
<span class="sd">What was done:</span>
<span class="sd">        *Added some small documentation to utilities routines</span>

<span class="sd">Release Jan 15, 2021</span>
<span class="sd">What was done:</span>
<span class="sd">        * Added routine cat_2_matrix to conver categorical classifiers to matrices</span>
<span class="sd">        * Added Multi-block PLS model</span>

<span class="sd">Release Date: NOv 16, 2020</span>
<span class="sd">What was done:</span>
<span class="sd">        * Fixed small bug un clean_low_variances routine</span>

<span class="sd">Release Date: Sep 26 2020</span>
<span class="sd">What was done:</span>
<span class="sd">        * Added rotation of loadings so that var(t) for ti&gt;=0 is always larger</span>
<span class="sd">          than var(t) for ti&lt;0</span>

<span class="sd">Release Date: May 27 2020</span>
<span class="sd">What was done:</span>
<span class="sd">    * Added the estimation of PLS models with missind data using</span>
<span class="sd">    non-linear programming per  Journal of Chemometrics, 28(7), pp.575-584.</span>

<span class="sd">Release Date: March 30 2020</span>
<span class="sd">What was done:</span>
<span class="sd">    * Added the estimation of PCA models with missing data using</span>
<span class="sd">      non-linear programming per Lopez-Negrete et al. J. Chemometrics 2010; 24: 301–311</span>

<span class="sd">Release Date: Aug 22 2019</span>

<span class="sd">What was done:</span>
<span class="sd">    </span>
<span class="sd">    * This header is now included to track high level changes </span>
<span class="sd">    * fixed LWPLS it works now for scalar and multivariable  Y&#39;s</span>
<span class="sd">    * fixed minor bug in phi.pca and phi.pls when mcsX/Y = False</span>
<span class="sd">    </span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">factorial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span>  <span class="n">RectBivariateSpline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.distributions.empirical_distribution</span><span class="w"> </span><span class="kn">import</span> <span class="n">ECDF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">which</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">eye</span><span class="p">,</span> <span class="n">asarray</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">diag</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">svd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;NEOS_EMAIL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pyphisoftware@gmail.com&#39;</span> 

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
    <span class="n">pyomo_ok</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pyomo_ok</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;gams&#39;</span><span class="p">)):</span>
    <span class="n">gams_ok</span> <span class="o">=</span> <span class="kc">True</span>    
<span class="k">else</span><span class="p">:</span>
    <span class="n">gams_ok</span> <span class="o">=</span> <span class="kc">False</span>             <span class="c1"># GAMS is run via pyomo</span>

<span class="c1"># Check if an IPOPT binary available is availbale</span>
<span class="c1"># shutil was introduced in Python 3.2</span>
<span class="n">ipopt_ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">))</span>

<span class="c1"># Check for Pyomo/GAMS interface is available</span>
<span class="k">if</span> <span class="n">pyomo_ok</span> <span class="ow">and</span> <span class="n">gams_ok</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.solvers.plugins.solvers.GAMS</span><span class="w"> </span><span class="kn">import</span> <span class="n">GAMSDirect</span><span class="p">,</span> <span class="n">GAMSShell</span>
    <span class="c1"># exeption_flag = True (default) will throw an exception if GAMS</span>
    <span class="c1"># is not available</span>
    <span class="n">gams_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">GAMSDirect</span><span class="p">()</span><span class="o">.</span><span class="n">available</span><span class="p">(</span><span class="n">exception_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">GAMSShell</span><span class="p">()</span><span class="o">.</span><span class="n">available</span><span class="p">(</span><span class="n">exception_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<div class="viewcode-block" id="ma57_dummy_check">
<a class="viewcode-back" href="../pyphi.html#pyphi.ma57_dummy_check">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ma57_dummy_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiates a trivial NLP to solve with IPOPT and MA57.</span>
<span class="sd">    Returns:</span>
<span class="sd">          ma57_ok: boolean, True if IPOPT solved with SolverStaus.ok</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">Var</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">Obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ma57&#39;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
    <span class="n">pyomo_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pyomo.core&#39;</span><span class="p">)</span>
    <span class="n">LOG_DEFAULT</span> <span class="o">=</span> <span class="n">pyomo_logger</span><span class="o">.</span><span class="n">level</span>
    <span class="n">pyomo_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">pyomo_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">LOG_DEFAULT</span><span class="p">)</span>
    
    <span class="n">ma57_ok</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">ok</span>
    <span class="k">if</span> <span class="n">ma57_ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MA57 available to IPOPT&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ma57_ok</span></div>


<span class="k">if</span> <span class="n">pyomo_ok</span> <span class="ow">and</span> <span class="n">ipopt_ok</span><span class="p">:</span>
    <span class="n">ma57_ok</span> <span class="o">=</span> <span class="n">ma57_dummy_check</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ma57_ok</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">pyomo_ok</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">ipopt_ok</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">gams_ok</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Will be using the NEOS server in the absence of IPOPT and GAMS&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="clean_htmls">
<a class="viewcode-back" href="../pyphi.html#pyphi.clean_htmls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_htmls</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Routine to clean html files</span>
<span class="sd">    </span>
<span class="sd">    pyphi.clean_htmls()</span>
<span class="sd">    </span>
<span class="sd">    Deletes all .html files in the current directory</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        none</span>
<span class="sd">    Returns:</span>
<span class="sd">        none</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">files_here</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_here</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;html&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>      
    <span class="k">return</span></div>


<div class="viewcode-block" id="pca">
<a class="viewcode-back" href="../pyphi.html#pyphi.pca">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pca</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cross_val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to creat a  Principal Components Analysis model</span>
<span class="sd">    </span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    pca_object = pyphi.pca (X,A,&lt;mcs=True,md_algorithm=&#39;nipals&#39;,force_nipals=False,shush=False,cross_val=0&gt;)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        X (Dataframe or Numpy) : Data to train the model</span>
<span class="sd">        A (int): Number of Principal Components to calculate</span>
<span class="sd">        </span>
<span class="sd">    Other Parameters:</span>
<span class="sd">        </span>
<span class="sd">        mcs: &#39;True&#39;      : Meancenter + autoscale *default if not sent* </span>
<span class="sd">             &#39;False&#39;     : No pre-processing</span>
<span class="sd">             &#39;center&#39;    : Only center</span>
<span class="sd">             &#39;autoscale&#39; : Only autoscale</span>
<span class="sd">             </span>
<span class="sd">        md_algorithm: Missing Data algorithm to use</span>
<span class="sd">                      &#39;nipals&#39; *default if not sent*</span>
<span class="sd">                      &#39;nlp&#39;    Uses non-linear programming approach by Lopez-Negrete et al. J. Chemometrics 2010; 24: 301–311</span>
<span class="sd">                      </span>
<span class="sd">        force_nipals: If = True  will use NIPALS.</span>
<span class="sd">                         = False if X is complete will use SVD. *default if not sent*</span>
<span class="sd">                      </span>
<span class="sd">        shush: If = True supressess all printed output</span>
<span class="sd">                  =  False *default if not sent*</span>
<span class="sd">        </span>
<span class="sd">        cross_val: If sent a scalar between 0 and 100, will cross validate</span>
<span class="sd">                   element wise removing cross_val% of the data every round</span>
<span class="sd">                   </span>
<span class="sd">                   if ==   0:  Bypass cross-validation  *default if not sent*</span>
<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with all PCA loadings, scores and other diagnostics.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>      
        
    <span class="k">if</span> <span class="n">cross_val</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">pcaobj</span><span class="o">=</span> <span class="n">pca_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="n">mcs</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="n">md_algorithm</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="n">force_nipals</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="n">shush</span><span class="p">)</span>
        <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;pca&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">cross_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cross_val</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#Mean center and scale according to flags</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcs</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcs</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcs</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
            
        <span class="c1">#Generate Missing Data Map    </span>
        <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        

        <span class="c1">#Initialize TSS per var vector</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">TSS</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cross validating PC #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#Generate cross-val map starting from missing data</span>
            <span class="n">not_removed_map</span> <span class="o">=</span> <span class="n">not_Xmiss</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">not_removed_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">not_removed_map</span><span class="p">,(</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#Generate matrix of random numbers and zero out nans</span>
            <span class="n">Xrnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xrnd</span><span class="p">,(</span><span class="n">Xrnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Xrnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">elements_to_remove_per_round</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">cross_val</span><span class="o">/</span><span class="mi">100</span><span class="p">)))</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rounds</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">not_removed_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span><span class="c1">#While there are still elements to be removed</span>
                <span class="c1">#if not(shush):</span>
                <span class="c1">#   print(&#39;Removing samples round #&#39;+str(rounds)+&#39; for component :&#39;+str(a+1))</span>
                <span class="n">rounds</span><span class="o">=</span><span class="n">rounds</span><span class="o">+</span><span class="mi">1</span>          
                <span class="n">X_copy</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">indx</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">elements_to_remove_per_round</span><span class="p">:</span>
                    <span class="n">indx_this_round</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">elements_to_remove_per_round</span><span class="p">]</span>
                    <span class="n">indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">elements_to_remove_per_round</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">indx_this_round</span> <span class="o">=</span> <span class="n">indx</span>
                <span class="c1">#Place NaN&#39;s     </span>
                <span class="n">X_copy</span>                           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,(</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">elements_out</span>                     <span class="o">=</span> <span class="n">X_copy</span><span class="p">[</span><span class="n">indx_this_round</span><span class="p">]</span>
                <span class="n">X_copy</span><span class="p">[</span><span class="n">indx_this_round</span><span class="p">]</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">X_copy</span>                           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">))</span>
                <span class="c1">#update map</span>
                <span class="n">not_removed_map</span><span class="p">[</span><span class="n">indx_this_round</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1">#look rows of missing data</span>
                <span class="n">auxmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_copy</span><span class="p">)</span>
                <span class="n">auxmap</span><span class="o">=</span> <span class="p">(</span><span class="n">auxmap</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">auxmap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxmap</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">indx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">auxmap</span><span class="o">==</span><span class="n">X_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">indx2</span><span class="o">=</span><span class="n">indx2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">X_copy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">indx2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">pcaobj_</span> <span class="o">=</span> <span class="n">pca_</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">xhat</span>    <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">xhat</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xhat</span><span class="p">,</span> <span class="n">indx2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">xhat</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xhat</span><span class="p">,(</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">error</span><span class="p">[</span><span class="n">indx_this_round</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements_out</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">[</span><span class="n">indx_this_round</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">error</span><span class="p">,(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">))</span>
            <span class="n">error</span><span class="p">,</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">n2z</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">PRESSpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">PRESS</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">q2</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESS</span><span class="o">/</span><span class="n">TSS</span>
                <span class="n">q2pv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSpv</span><span class="o">/</span><span class="n">TSSpv</span>
                <span class="n">q2pv</span> <span class="o">=</span> <span class="n">q2pv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2</span><span class="p">,</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRESS</span><span class="o">/</span><span class="n">TSS</span><span class="p">))</span>
                <span class="n">aux_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">PRESSpv</span><span class="o">/</span><span class="n">TSSpv</span>
                <span class="n">aux_</span> <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">q2pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2pv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
            
            <span class="c1">#Deflate and go to next PC</span>
            <span class="n">X_copy</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">pcaobj_</span> <span class="o">=</span> <span class="n">pca_</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xhat</span>    <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">)</span> <span class="o">*</span> <span class="n">not_Xmiss</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span>
                <span class="n">r2pv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                <span class="n">r2pv</span> <span class="o">=</span> <span class="n">r2pv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span><span class="p">))</span>
                <span class="n">aux_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                <span class="n">aux_</span> <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2pv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="p">)</span>
            
        <span class="c1"># Fit full model</span>
        <span class="n">pcaobj</span> <span class="o">=</span> <span class="n">pca_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="n">mcs</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
             <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">q2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">q2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">q2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2pv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">q2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>
        <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;q2&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">q2</span>
        <span class="n">pcaobj</span> <span class="p">[</span><span class="s1">&#39;q2pv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2pv</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>   
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pca using NIPALS and cross validation (&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cross_val</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%) executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #          Eig      R2X     sum(R2X)      Q2X     sum(Q2X)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2xc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d3</span><span class="o">=</span><span class="n">q2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">d3</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>     
        <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;pca&#39;</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pcaobj</span><span class="o">=</span><span class="s1">&#39;Cannot cross validate  with those options&#39;</span>
    <span class="k">return</span> <span class="n">pcaobj</span></div>


<div class="viewcode-block" id="pca_">
<a class="viewcode-back" href="../pyphi.html#pyphi.pca_">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pca_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="n">obsidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mcs</span><span class="p">:</span>
            <span class="c1">#Mean center and autoscale  </span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">mcs</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1">#only center</span>
    <span class="k">elif</span> <span class="n">mcs</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
        <span class="c1">#only autoscale</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        
    <span class="c1">#Generate Missing Data Map    </span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">force_nipals</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">)):</span>
        <span class="c1">#no missing elements</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pca using SVD executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
        <span class="n">TSS</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">:</span>
             <span class="p">[</span><span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Th</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X_</span> <span class="o">@</span> <span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
             <span class="n">T</span>          <span class="o">=</span> <span class="n">Th</span><span class="o">.</span><span class="n">T</span> 
             <span class="n">T</span>          <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">A</span><span class="p">]</span>
             <span class="n">P</span>          <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">T</span>
             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                 <span class="n">P</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span><span class="n">a</span><span class="p">])</span>
             <span class="n">T</span>          <span class="o">=</span> <span class="n">X_</span> <span class="o">@</span> <span class="n">P</span>
        <span class="k">elif</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">:</span>
             <span class="p">[</span><span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Ph</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X_</span><span class="p">)</span>
             <span class="n">P</span>          <span class="o">=</span> <span class="n">Ph</span><span class="o">.</span><span class="n">T</span>
             <span class="n">P</span>          <span class="o">=</span> <span class="n">P</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">A</span><span class="p">]</span>
             <span class="n">T</span>          <span class="o">=</span> <span class="n">X_</span> <span class="o">@</span> <span class="n">P</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="n">X_</span><span class="o">-</span> <span class="n">T</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="nd">@P</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span>
                <span class="n">r2pv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                <span class="n">r2pv</span> <span class="o">=</span> <span class="n">r2pv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span>  <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span><span class="p">))</span>
                <span class="n">aux_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span><span class="p">)</span>
                <span class="n">r2pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2pv</span><span class="p">,</span><span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
             <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pca_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2pv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
        <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #      Eig        R2X       sum(R2X) &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">d2</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>      
        <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">pca_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
        <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
        <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
        <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T2</span>
        <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">T2_lim99</span>
        <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">T2_lim95</span>
        <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX</span>
        <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX_lim99</span>
        <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX_lim95</span>
        <span class="k">return</span> <span class="n">pca_obj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">md_algorithm</span><span class="o">==</span><span class="s1">&#39;nipals&#39;</span><span class="p">:</span>
             <span class="c1">#use nipals</span>
             <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pca using NIPALS executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
             <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
             <span class="n">epsilon</span><span class="o">=</span><span class="mf">1E-10</span>
             <span class="n">maxit</span><span class="o">=</span><span class="mi">5000</span>
             <span class="n">TSS</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
             <span class="n">TSSpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
             <span class="c1">#T=[];</span>
             <span class="c1">#P=[];</span>
             <span class="c1">#r2=[];</span>
             <span class="c1">#r2pv=[];</span>
             <span class="c1">#numIT=[];</span>
             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                 <span class="c1"># Select column with largest variance as initial guess</span>
                 <span class="n">ti</span> <span class="o">=</span> <span class="n">X_</span><span class="p">[:,[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">X_</span><span class="p">))]]</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">False</span>
                 <span class="n">num_it</span><span class="o">=</span><span class="mi">0</span>
                 <span class="k">while</span> <span class="n">Converged</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                      <span class="c1">#Step 1. p(i)=t&#39; x(i)/t&#39;t</span>
                      <span class="n">timat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ti</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                      <span class="n">pi</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">*</span><span class="n">timat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">timat</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                      <span class="c1">#Step 2. Normalize p to unit length.</span>
                      <span class="n">pi</span><span class="o">=</span><span class="n">pi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
                      <span class="c1">#Step 3. tnew= (x*p) / (p&#39;p);</span>
                      <span class="n">pimat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pi</span><span class="p">,(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
                      <span class="n">tn</span><span class="o">=</span> <span class="n">X_</span> <span class="o">@</span> <span class="n">pi</span><span class="o">.</span><span class="n">T</span>
                      <span class="n">ptp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pimat</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                      <span class="n">tn</span><span class="o">=</span><span class="n">tn</span><span class="o">/</span><span class="n">ptp</span>
                      <span class="n">pi</span><span class="o">=</span><span class="n">pi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                      <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tn</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                          <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                      <span class="k">if</span> <span class="n">num_it</span> <span class="o">&gt;</span> <span class="n">maxit</span><span class="p">:</span>
                          <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                      <span class="k">if</span> <span class="n">Converged</span><span class="p">:</span>
                          <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span> <span class="c1">#if scores are above and below zero</span>
                              <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                                 <span class="n">tn</span><span class="o">=-</span><span class="n">tn</span>
                                 <span class="n">ti</span><span class="o">=-</span><span class="n">ti</span>
                                 <span class="n">pi</span><span class="o">=-</span><span class="n">pi</span> 
                          <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# Iterations for PC #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num_it</span><span class="p">))</span>
                          <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                              <span class="n">T</span><span class="o">=</span><span class="n">tn</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                              <span class="n">P</span><span class="o">=</span><span class="n">pi</span>
                          <span class="k">else</span><span class="p">:</span>
                              <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">tn</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                              <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">pi</span><span class="p">))</span>                           
                          <span class="c1"># Deflate X leaving missing as zeros (important!)</span>
                          <span class="n">X_</span><span class="o">=</span><span class="p">(</span><span class="n">X_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
                          <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                              <span class="n">r2</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span>
                              <span class="n">r2pv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                              <span class="n">r2pv</span> <span class="o">=</span> <span class="n">r2pv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                          <span class="k">else</span><span class="p">:</span>
                              <span class="n">r2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span><span class="p">))</span>
                              <span class="n">aux_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                              <span class="n">aux_</span> <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                              <span class="n">r2pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2pv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                      <span class="k">else</span><span class="p">:</span>
                          <span class="n">num_it</span> <span class="o">=</span> <span class="n">num_it</span> <span class="o">+</span> <span class="mi">1</span>
                          <span class="n">ti</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">numIT</span><span class="o">=</span><span class="n">num_it</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">numIT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">numIT</span><span class="p">,</span><span class="n">num_it</span><span class="p">))</span>
                     
             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                 <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 
             <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
             <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>               
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #      Eig        R2X       sum(R2X) &#39;</span><span class="p">)</span>
 
                 <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">d2</span><span class="p">))</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>      
        
             <span class="n">pca_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2pv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">}</span>    
             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                 <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
                 <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
                 
             <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">pca_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
             <span class="n">n</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
             <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
             <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
             <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T2</span>
             <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">T2_lim99</span>
             <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">T2_lim95</span>
             <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX</span>
             <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX_lim99</span>
             <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX_lim95</span>
             <span class="k">return</span> <span class="n">pca_obj</span>                            
        <span class="k">elif</span> <span class="n">md_algorithm</span><span class="o">==</span><span class="s1">&#39;nlp&#39;</span> <span class="ow">and</span> <span class="n">pyomo_ok</span><span class="p">:</span>
            <span class="c1">#use NLP per Lopez-Negrete et al. J. Chemometrics 2010; 24: 301–311</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pca using NLP with Ipopt executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">pcaobj_</span><span class="o">=</span> <span class="n">pca_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="n">mcs</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pcaobj_</span><span class="o">=</span> <span class="n">prep_pca_4_MDbyNLP</span><span class="p">(</span><span class="n">pcaobj_</span><span class="p">,</span><span class="n">X_</span><span class="p">)</span>
          
            <span class="n">TSS</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">TSSpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#Set up the model in Pyomo</span>
            <span class="n">model</span>             <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">A</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">N</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">O</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_O&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">P</span>           <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_P_init&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">T</span>           <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_T_init&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">psi</span>         <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_psi&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">X</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_X&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">delta</span>       <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">a1</span><span class="o">==</span><span class="n">a2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Constraints 20b</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_c20b_con</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">a1</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">c20b</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">_c20b_con</span><span class="p">)</span>
    
            <span class="c1"># Constraints 20c</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_20c_con</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="n">a1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">a1</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>
            <span class="n">model</span><span class="o">.</span><span class="n">c20c</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">_20c_con</span><span class="p">)</span>

            <span class="c1"># Constraints 20d</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">mean_zero</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>  <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span> <span class="p">)</span><span class="o">==</span><span class="mi">0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eq3</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span><span class="n">rule</span><span class="o">=</span><span class="n">mean_zero</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_eq_20a_obj</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">]</span><span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">psi</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_eq_20a_obj</span><span class="p">)</span>            
            <span class="c1"># Setup our solver as either local ipopt, gams:ipopt, or neos ipopt:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ipopt_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using local IPOPT executable&quot;</span><span class="p">)</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ma57_ok</span><span class="p">):</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ma57&#39;</span>

                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">gams_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using GAMS/IPOPT interface&quot;</span><span class="p">)</span>
                <span class="c1"># &#39;just &#39;ipopt&#39; could work, if no binary in path</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;gams:ipopt&#39;</span><span class="p">)</span>

                <span class="c1"># It doesn&#39;t seem to notice the opt file when I write it</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using IPOPT on remote NEOS server&quot;</span><span class="p">)</span>
                <span class="n">solver_manager</span> <span class="o">=</span> <span class="n">SolverManagerFactory</span><span class="p">(</span><span class="s1">&#39;neos&#39;</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver_manager</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">T</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">:</span>
                 <span class="n">t</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
                 <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   
            <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>     
            <span class="n">P</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">:</span>
                 <span class="n">p</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
                 <span class="n">P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>   
            <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>   
            
            <span class="c1"># Calculate R2</span>
           
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">A</span><span class="p">)):</span>
                 <span class="n">ti</span><span class="o">=</span><span class="n">T</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                 <span class="n">pi</span><span class="o">=</span><span class="n">P</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                 <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ti</span><span class="o">=-</span><span class="n">ti</span>
                    <span class="n">pi</span><span class="o">=-</span><span class="n">pi</span> 
                    <span class="n">T</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">=-</span><span class="n">T</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                    <span class="n">P</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">=-</span><span class="n">P</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>                           
                 <span class="n">X_</span><span class="o">=</span><span class="p">(</span><span class="n">X_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">r2</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span>
                    <span class="n">r2pv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                    <span class="n">r2pv</span> <span class="o">=</span> <span class="n">r2pv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                 <span class="k">else</span><span class="p">:</span>
                    <span class="n">r2</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span><span class="p">))</span>
                    <span class="n">aux_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSpv</span>
                    <span class="n">aux_</span> <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">r2pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2pv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                    
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                 <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2pv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 
            <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>               
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #      Eig        R2X       sum(R2X) &#39;</span><span class="p">)</span>
 
                 <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">d2</span><span class="p">))</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>      
        
            <span class="n">pca_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2pv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">}</span>    
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                 <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
                 <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
                 
            <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">pca_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
            <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
            <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T2</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">T2_lim99</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">T2_lim95</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX_lim99</span>
            <span class="n">pca_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">speX_lim95</span>
            <span class="k">return</span> <span class="n">pca_obj</span>                  
            
        <span class="k">elif</span> <span class="n">md_algorithm</span><span class="o">==</span><span class="s1">&#39;nlp&#39;</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span> <span class="n">pyomo_ok</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pyomo was not found in your system sorry&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;visit  http://www.pyomo.org/ &#39;</span><span class="p">)</span>
            <span class="n">pca_obj</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">pca_obj</span></div>

  
<div class="viewcode-block" id="pls">
<a class="viewcode-back" href="../pyphi.html#pyphi.pls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cross_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cross_val_X</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cca</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to create a Projection to  Latent Structures model</span>
<span class="sd">    </span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    pls_object = pyphi.pls(X,Y,A,&lt;mcsX=True,mcsY=True,md_algorithm=&#39;nipals&#39;,force_nipals=True,shush=False,</span>
<span class="sd">            cross_val=0,cross_val_X=False,cca=False&gt;)</span>
<span class="sd">    Args:</span>
<span class="sd">        X,Y (DataFrame or Numpy) : Training Data</span>
<span class="sd">        </span>
<span class="sd">        A (int) : Number of Latent Variables to calculate</span>
<span class="sd">        </span>
<span class="sd">    Other Parameters:</span>
<span class="sd">        </span>
<span class="sd">        mcsX/mcsY:  &#39;True&#39;      : Will meancenter and autoscale the data *default if not sent*  </span>
<span class="sd">                    &#39;False&#39;     : No pre-processing</span>
<span class="sd">                    &#39;center&#39;    : Will only center</span>
<span class="sd">                    &#39;autoscale&#39; : Will only autoscale</span>
<span class="sd">             </span>
<span class="sd">        md_algorithm: &#39;nipals&#39; *default*</span>
<span class="sd">                      &#39;nlp&#39;    Uses  algorithm described in Journal of Chemometrics, 28(7), pp.575-584.</span>
<span class="sd">                      </span>
<span class="sd">        force_nipals: If set to True and if X is complete, will use NIPALS.</span>
<span class="sd">                      Otherwise, if X is complete will use SVD.</span>
<span class="sd">                      </span>
<span class="sd">        shush: If set to True supressess all printed output.</span>
<span class="sd">        </span>
<span class="sd">        cross_val: If sent a scalar between 0 and 100, will cross validate</span>
<span class="sd">                   element wise removing cross_val% of the data every round</span>
<span class="sd">                   </span>
<span class="sd">                   if ==   0:  Bypass cross-validation  *default if not sent*</span>
<span class="sd">                   </span>
<span class="sd">        cross_val_X: True : Calculates Q2 values for the X and Y matrices</span>
<span class="sd">                     False: Cross-validation strictly on Y matrix *default if not sent*</span>
<span class="sd">                     </span>
<span class="sd">        cca:         True : Calculates covariable space of X with Y (analog to the predictive space in OPLS)</span>
<span class="sd">                            &quot;Tcv&quot; and &quot;Pcv&quot; and the covariant scores and loadings if more than one Y, then</span>
<span class="sd">                            there will be as many Tcv and Pcv vectors as columns in Y</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with all PLS loadings, scores and other diagnostics.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">cross_val</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">plsobj</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="n">mcsX</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="n">mcsY</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="n">md_algorithm</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="n">force_nipals</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="n">shush</span><span class="p">,</span><span class="n">cca</span><span class="o">=</span><span class="n">cca</span><span class="p">)</span>  
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;pls&#39;</span> 
    <span class="k">elif</span> <span class="p">(</span><span class="n">cross_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cross_val</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#Mean center and scale according to flags</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcsX</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcsX</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcsX</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        <span class="c1">#Generate Missing Data Map    </span>
        <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#Mean center and scale according to flags</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcsY</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">y_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcsY</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcsY</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        <span class="c1">#Generate Missing Data Map    </span>
        <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
        <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        
        <span class="c1">#Initialize TSS per var vector</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">colsX</span> <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rowsX</span> <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="p">)</span>
        
        <span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
        <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">colsY</span> <span class="o">=</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rowsY</span> <span class="o">=</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Y_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="p">)</span>
        
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cross validating LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#Generate cross-val map starting from missing data</span>
            <span class="n">not_removed_mapY</span> <span class="o">=</span> <span class="n">not_Ymiss</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">not_removed_mapY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">not_removed_mapY</span><span class="p">,(</span><span class="n">rowsY</span><span class="o">*</span><span class="n">colsY</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#Generate matrix of random numbers and zero out nans</span>
            <span class="n">Yrnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
            <span class="n">indxY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Yrnd</span><span class="p">,(</span><span class="n">Yrnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Yrnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">elements_to_remove_per_roundY</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">cross_val</span><span class="o">/</span><span class="mi">100</span><span class="p">)))</span>
            <span class="n">errorY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rowsY</span><span class="o">*</span><span class="n">colsY</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                
            <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                <span class="c1">#Generate cross-val map starting from missing data</span>
                <span class="n">not_removed_mapX</span> <span class="o">=</span> <span class="n">not_Xmiss</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">not_removed_mapX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">not_removed_mapX</span><span class="p">,(</span><span class="n">rowsX</span><span class="o">*</span><span class="n">colsX</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="c1">#Generate matrix of random numbers and zero out nans</span>
                <span class="n">Xrnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
                <span class="n">indxX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xrnd</span><span class="p">,(</span><span class="n">Xrnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Xrnd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">elements_to_remove_per_roundX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">cross_val</span><span class="o">/</span><span class="mi">100</span><span class="p">)))</span>
                <span class="n">errorX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rowsX</span><span class="o">*</span><span class="n">colsX</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">not_removed_mapX</span><span class="o">=</span><span class="mi">0</span>
                
            <span class="n">number_of_rounds</span><span class="o">=</span><span class="mi">1</span>    
            <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">not_removed_mapX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">not_removed_mapY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span><span class="c1">#While there are still elements to be removed</span>
                <span class="c1">#if not(shush):</span>
                <span class="c1">#    print(&#39;Random removal round #&#39;+ str(number_of_rounds))</span>
                <span class="n">number_of_rounds</span><span class="o">=</span><span class="n">number_of_rounds</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">X_copy</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indxX</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">elements_to_remove_per_roundX</span><span class="p">:</span>
                        <span class="n">indx_this_roundX</span> <span class="o">=</span> <span class="n">indxX</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">elements_to_remove_per_roundX</span><span class="p">]</span>
                        <span class="n">indxX</span> <span class="o">=</span> <span class="n">indxX</span><span class="p">[</span><span class="n">elements_to_remove_per_roundX</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">indx_this_roundX</span> <span class="o">=</span> <span class="n">indxX</span>
                    <span class="c1">#Place NaN&#39;s     </span>
                    <span class="n">X_copy</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,(</span><span class="n">rowsX</span><span class="o">*</span><span class="n">colsX</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">elements_outX</span>                     <span class="o">=</span> <span class="n">X_copy</span><span class="p">[</span><span class="n">indx_this_roundX</span><span class="p">]</span>
                    <span class="n">X_copy</span><span class="p">[</span><span class="n">indx_this_roundX</span><span class="p">]</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">X_copy</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,(</span><span class="n">rowsX</span><span class="p">,</span><span class="n">colsX</span><span class="p">))</span>
                    <span class="c1">#update map</span>
                    <span class="n">not_removed_mapX</span><span class="p">[</span><span class="n">indx_this_roundX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1">#look rows of missing data</span>
                    <span class="n">auxmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_copy</span><span class="p">)</span>
                    <span class="n">auxmap</span><span class="o">=</span> <span class="p">(</span><span class="n">auxmap</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
                    <span class="n">auxmap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxmap</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">indx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">auxmap</span><span class="o">==</span><span class="n">X_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">indx2</span><span class="o">=</span><span class="n">indx2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indx2</span><span class="o">=</span><span class="p">[];</span>

                        
                <span class="n">Y_copy</span><span class="o">=</span><span class="n">Y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
                <span class="k">if</span> <span class="n">indxY</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">elements_to_remove_per_roundY</span><span class="p">:</span>
                    <span class="n">indx_this_roundY</span> <span class="o">=</span> <span class="n">indxY</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">elements_to_remove_per_roundY</span><span class="p">]</span>
                    <span class="n">indxY</span> <span class="o">=</span> <span class="n">indxY</span><span class="p">[</span><span class="n">elements_to_remove_per_roundY</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>                      
                    <span class="n">indx_this_roundY</span> <span class="o">=</span> <span class="n">indxY</span>
                <span class="c1">#Place NaN&#39;s     </span>
                <span class="n">Y_copy</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Y_copy</span><span class="p">,(</span><span class="n">rowsY</span><span class="o">*</span><span class="n">colsY</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">elements_outY</span>                     <span class="o">=</span> <span class="n">Y_copy</span><span class="p">[</span><span class="n">indx_this_roundY</span><span class="p">]</span>
                <span class="n">Y_copy</span><span class="p">[</span><span class="n">indx_this_roundY</span><span class="p">]</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">Y_copy</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Y_copy</span><span class="p">,(</span><span class="n">rowsY</span><span class="p">,</span><span class="n">colsY</span><span class="p">))</span>
                <span class="c1">#update map</span>
                <span class="n">not_removed_mapY</span><span class="p">[</span><span class="n">indx_this_roundY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1">#look rows of missing data</span>
                <span class="n">auxmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_copy</span><span class="p">)</span>
                <span class="n">auxmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">auxmap</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">auxmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxmap</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">indx3</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">auxmap</span><span class="o">==</span><span class="n">Y_copy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">indx3</span>  <span class="o">=</span> <span class="n">indx3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">indx4</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indx3</span><span class="o">+</span><span class="n">indx2</span><span class="p">)</span>
                <span class="n">indx4</span>  <span class="o">=</span> <span class="n">indx4</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">X_copy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">indx4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">Y_copy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Y_copy</span><span class="p">,</span><span class="n">indx4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1">#print(&#39;Running PLS&#39;)        </span>
                <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">Y_copy</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1">#print(&#39;Done with PLS&#39;)</span>
                <span class="n">plspred</span> <span class="o">=</span> <span class="n">pls_pred</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">plsobj_</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                    <span class="n">xhat</span>    <span class="o">=</span> <span class="n">plspred</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">xhat</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xhat</span><span class="p">,(</span><span class="n">rowsX</span><span class="o">*</span><span class="n">colsX</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">errorX</span><span class="p">[</span><span class="n">indx_this_roundX</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements_outX</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">[</span><span class="n">indx_this_roundX</span><span class="p">]</span>
                
                <span class="n">yhat</span>    <span class="o">=</span> <span class="n">plspred</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">yhat</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">yhat</span><span class="p">,(</span><span class="n">rowsY</span><span class="o">*</span><span class="n">colsY</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">errorY</span><span class="p">[</span><span class="n">indx_this_roundY</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements_outY</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">[</span><span class="n">indx_this_roundY</span><span class="p">]</span>
                
            <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                <span class="n">errorX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">errorX</span><span class="p">,(</span><span class="n">rowsX</span><span class="p">,</span><span class="n">colsX</span><span class="p">))</span>
                <span class="n">errorX</span><span class="p">,</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">n2z</span><span class="p">(</span><span class="n">errorX</span><span class="p">)</span>
                <span class="n">PRESSXpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorX</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">PRESSX</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorX</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="n">errorY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">errorY</span><span class="p">,(</span><span class="n">rowsY</span><span class="p">,</span><span class="n">colsY</span><span class="p">))</span>
            <span class="n">errorY</span><span class="p">,</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">n2z</span><span class="p">(</span><span class="n">errorY</span><span class="p">)</span>
            <span class="n">PRESSYpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorY</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">PRESSY</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">q2Y</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSY</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">q2Ypv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSYpv</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">q2Ypv</span> <span class="o">=</span> <span class="n">q2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                    <span class="n">q2X</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSX</span><span class="o">/</span><span class="n">TSSX</span>
                    <span class="n">q2Xpv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSXpv</span><span class="o">/</span><span class="n">TSSXpv</span>
                    <span class="n">q2Xpv</span> <span class="o">=</span> <span class="n">q2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q2Y</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2Y</span><span class="p">,</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSY</span><span class="o">/</span><span class="n">TSSY</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">PRESSYpv</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">q2Ypv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2Ypv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                    <span class="n">q2X</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2X</span><span class="p">,</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSX</span><span class="o">/</span><span class="n">TSSX</span><span class="p">))</span>
                    <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">PRESSXpv</span><span class="o">/</span><span class="n">TSSXpv</span>
                    <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">q2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2Xpv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span> 
            
            <span class="c1">#Deflate and go to next PC</span>
            <span class="n">X_copy</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">Y_copy</span><span class="o">=</span><span class="n">Y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">Y_copy</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xhat</span>    <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">yhat</span>    <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">)</span> <span class="o">*</span> <span class="n">not_Xmiss</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span> <span class="o">*</span> <span class="n">not_Ymiss</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2X</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>               
            <span class="n">X_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="p">)</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="p">)</span>
            
        <span class="c1"># Fit full model</span>
        <span class="n">plsobj</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="n">mcsX</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="n">mcsY</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cca</span><span class="o">=</span><span class="n">cca</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
             <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                 <span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">q2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">q2X</span>   <span class="o">=</span> <span class="kc">False</span>
                 <span class="n">q2Xpv</span> <span class="o">=</span> <span class="kc">False</span>
             
             <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">q2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             
        <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">)</span>
        <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
            <span class="n">q2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">q2X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q2xc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">q2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">q2Y</span><span class="p">)</span>    
        <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2Y&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">q2Y</span>
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2Ypv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Ypv</span>
        <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
            <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2X&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">q2X</span>
            <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2Xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Xpv</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pls using NIPALS and cross-validation (&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cross_val</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%) executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">cross_val_X</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #       Eig      R2X     sum(R2X)      R2Y     sum(R2Y)      Q2Y     sum(Q2Y)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d3</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d4</span><span class="o">=</span><span class="n">q2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">        </span><span class="si">{:.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">q2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------&#39;</span><span class="p">)</span>     
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #       Eig      R2X     sum(R2X)      Q2X     sum(Q2X)      R2Y     sum(R2Y)      Q2Y     sum(Q2Y)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d3</span><span class="o">=</span><span class="n">q2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d4</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d5</span><span class="o">=</span><span class="n">q2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">q2X</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">,</span><span class="n">q2Y</span><span class="p">,</span><span class="n">d5</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>   
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;pls&#39;</span>
    <span class="k">elif</span> <span class="n">cross_val</span><span class="o">==</span><span class="mi">100</span><span class="p">:</span>
    
          
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#Mean center and scale according to flags</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcsX</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcsX</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcsX</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        <span class="c1">#Generate Missing Data Map    </span>
        <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#Mean center and scale according to flags</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcsY</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">y_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcsY</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcsY</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        <span class="c1">#Generate Missing Data Map    </span>
        <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
        <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        
        <span class="c1">#Initialize TSS per var vector</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">colsX</span> <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rowsX</span> <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="p">)</span>
        
        <span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
        <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">colsY</span> <span class="o">=</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rowsY</span> <span class="o">=</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Y_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="p">)</span>
        
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
            <span class="n">errorY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rowsY</span><span class="o">*</span><span class="n">colsY</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>               
            <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                <span class="n">errorX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rowsX</span><span class="o">*</span><span class="n">colsX</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span> <span class="c1"># Removing one at a time</span>
                <span class="n">X_copy</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">Y_copy</span><span class="o">=</span><span class="n">Y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   
                
                <span class="n">elements_outX</span> <span class="o">=</span><span class="n">X_copy</span><span class="p">[</span><span class="n">o</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">elements_outY</span> <span class="o">=</span><span class="n">Y_copy</span><span class="p">[</span><span class="n">o</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">X_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">Y_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Y_copy</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        
                <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">Y_copy</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plspred</span> <span class="o">=</span> <span class="n">pls_pred</span><span class="p">(</span><span class="n">elements_outX</span><span class="p">,</span><span class="n">plsobj_</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">o</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                        <span class="n">errorX</span><span class="o">=</span> <span class="n">elements_outX</span> <span class="o">-</span> <span class="n">plspred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span>
                    <span class="n">errorY</span><span class="o">=</span> <span class="n">elements_outY</span> <span class="o">-</span> <span class="n">plspred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                        <span class="n">errorX</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">errorX</span><span class="p">,</span><span class="n">elements_outX</span> <span class="o">-</span> <span class="n">plspred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]))</span>
                    <span class="n">errorY</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">errorY</span><span class="p">,</span><span class="n">elements_outY</span> <span class="o">-</span> <span class="n">plspred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]))</span>
                  
            <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                <span class="n">errorX</span><span class="p">,</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">n2z</span><span class="p">(</span><span class="n">errorX</span><span class="p">)</span>
                <span class="n">PRESSXpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorX</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">PRESSX</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorX</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="n">errorY</span><span class="p">,</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">n2z</span><span class="p">(</span><span class="n">errorY</span><span class="p">)</span>
            <span class="n">PRESSYpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorY</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">PRESSY</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">errorY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">q2Y</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSY</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">q2Ypv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSYpv</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">q2Ypv</span> <span class="o">=</span> <span class="n">q2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                    <span class="n">q2X</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSX</span><span class="o">/</span><span class="n">TSSX</span>
                    <span class="n">q2Xpv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSXpv</span><span class="o">/</span><span class="n">TSSXpv</span>
                    <span class="n">q2Xpv</span> <span class="o">=</span> <span class="n">q2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q2Y</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2Y</span><span class="p">,</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSY</span><span class="o">/</span><span class="n">TSSY</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">PRESSYpv</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">q2Ypv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2Ypv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                    <span class="n">q2X</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2X</span><span class="p">,</span><span class="mi">1</span> <span class="o">-</span> <span class="n">PRESSX</span><span class="o">/</span><span class="n">TSSX</span><span class="p">))</span>
                    <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">PRESSXpv</span><span class="o">/</span><span class="n">TSSXpv</span>
                    <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">q2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q2Xpv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span> 
            
            <span class="c1">#Deflate and go to next PC</span>
            <span class="n">X_copy</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">Y_copy</span><span class="o">=</span><span class="n">Y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X_copy</span><span class="p">,</span><span class="n">Y_copy</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xhat</span>    <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">yhat</span>    <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span> <span class="o">-</span> <span class="n">xhat</span><span class="p">)</span> <span class="o">*</span> <span class="n">not_Xmiss</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span> <span class="o">*</span> <span class="n">not_Ymiss</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2X</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>               
            <span class="n">X_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">Xnanmap</span><span class="p">)</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="n">z2n</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">Ynanmap</span><span class="p">)</span>
            
        <span class="c1"># Fit full model</span>
        <span class="n">plsobj</span> <span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="n">mcsX</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="n">mcsY</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cca</span><span class="o">=</span><span class="n">cca</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
             <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
                 <span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">q2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">q2X</span>   <span class="o">=</span> <span class="kc">False</span>
                 <span class="n">q2Xpv</span> <span class="o">=</span> <span class="kc">False</span>
             
             <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             <span class="n">q2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">q2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             
        <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">)</span>
        <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
            <span class="n">q2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">q2X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q2xc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">q2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">q2Y</span><span class="p">)</span>    
        <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2Y&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">q2Y</span>
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2Ypv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Ypv</span>
        <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;pls&#39;</span>
        <span class="k">if</span> <span class="n">cross_val_X</span><span class="p">:</span>
            <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2X&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">q2X</span>
            <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;q2Xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2Xpv</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">cross_val_X</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #       Eig      R2X     sum(R2X)      R2Y     sum(R2Y)      Q2Y     sum(Q2Y)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d3</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d4</span><span class="o">=</span><span class="n">q2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">q2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------------------------------------------------&#39;</span><span class="p">)</span>     
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PC #       Eig      R2X     sum(R2X)      Q2X     sum(Q2X)      R2Y     sum(R2Y)      Q2Y     sum(Q2Y)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">q2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d3</span><span class="o">=</span><span class="n">q2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d4</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d5</span><span class="o">=</span><span class="n">q2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PC #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:</span><span class="si">{:8.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">       </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">q2X</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">,</span><span class="n">q2Y</span><span class="p">,</span><span class="n">d5</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------------------------------------------------------------------&#39;</span><span class="p">)</span>   
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plsobj</span><span class="o">=</span><span class="s1">&#39;Cannot cross validate  with those options&#39;</span>
    <span class="k">return</span> <span class="n">plsobj</span>    </div>


<div class="viewcode-block" id="pls_cca">
<a class="viewcode-back" href="../pyphi.html#pyphi.pls_cca">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pls_cca</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">,</span><span class="n">Xmcs</span><span class="p">,</span><span class="n">Ymcs</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="p">):</span>
    <span class="n">Tcv</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Pcv</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Wcv</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Betacv</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">firstone</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ymcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">y_</span>         <span class="o">=</span> <span class="n">Ymcs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">y_</span>         <span class="o">=</span> <span class="n">y_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">corr</span><span class="p">,</span><span class="n">wt</span><span class="p">,</span><span class="n">wy</span> <span class="o">=</span> <span class="n">cca</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">y_</span><span class="p">)</span>
        <span class="n">t_cv</span>       <span class="o">=</span> <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="nd">@wt</span>
        <span class="n">t_cv</span>       <span class="o">=</span> <span class="n">t_cv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">beta</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">t_cv</span><span class="p">,</span> <span class="n">y_</span><span class="p">,</span><span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">w_cv</span>       <span class="o">=</span> <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="nd">@wt</span>
        <span class="n">w_cv</span>       <span class="o">=</span> <span class="n">w_cv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tcvmat</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">t_cv</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">Xmcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">p_cv</span>       <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xmcs</span><span class="o">*</span><span class="n">tcvmat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tcvmat</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">p_cv</span>       <span class="o">=</span> <span class="n">p_cv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">firstone</span><span class="p">:</span>
            <span class="n">Tcv</span><span class="o">=</span><span class="n">t_cv</span>
            <span class="n">Pcv</span><span class="o">=</span><span class="n">p_cv</span>
            <span class="n">Wcv</span><span class="o">=</span><span class="n">w_cv</span>
            <span class="n">Betacv</span><span class="o">=</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">firstone</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Tcv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Tcv</span><span class="p">,</span><span class="n">t_cv</span><span class="p">))</span>
            <span class="n">Pcv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Pcv</span><span class="p">,</span><span class="n">p_cv</span><span class="p">))</span>
            <span class="n">Wcv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Wcv</span><span class="p">,</span><span class="n">w_cv</span><span class="p">))</span>
            <span class="n">Betacv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Betacv</span><span class="p">,</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span>  <span class="n">Tcv</span><span class="p">,</span><span class="n">Pcv</span><span class="p">,</span><span class="n">Wcv</span><span class="p">,</span><span class="n">Betacv</span></div>


<div class="viewcode-block" id="pls_">
<a class="viewcode-back" href="../pyphi.html#pyphi.pls_">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pls_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">cca</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="n">obsidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">obsidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>        
        
   
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mcsX</span><span class="p">:</span>
            <span class="c1">#Mean center and autoscale  </span>
            <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">mcsX</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1">#only center      </span>
    <span class="k">elif</span> <span class="n">mcsX</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
        <span class="c1">#only autoscale</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mcsY</span><span class="p">:</span>
            <span class="c1">#Mean center and autoscale  </span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">y_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">mcsY</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
        <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1">#only center      </span>
    <span class="k">elif</span> <span class="n">mcsY</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
        <span class="c1">#only autoscale</span>
        <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span> 
   
    <span class="c1">#Generate Missing Data Map    </span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">()))</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">force_nipals</span><span class="p">):</span>
       <span class="c1">#no missing elements</span>
        <span class="k">if</span> <span class="n">cca</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>    
           <span class="n">Xmcs</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
           <span class="n">Ymcs</span><span class="o">=</span><span class="n">Y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pls using SVD executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
        <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
            <span class="p">[</span><span class="n">U_</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Wh</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">((</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Y_</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">Y_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X_</span><span class="p">))</span>
            <span class="n">w</span>          <span class="o">=</span> <span class="n">Wh</span><span class="o">.</span><span class="n">T</span>
            <span class="n">w</span>          <span class="o">=</span> <span class="n">w</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">t</span>          <span class="o">=</span> <span class="n">X_</span> <span class="o">@</span> <span class="n">w</span>
            <span class="n">q</span>          <span class="o">=</span> <span class="n">Y_</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">t</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">u</span>          <span class="o">=</span> <span class="n">Y_</span> <span class="o">@</span> <span class="n">q</span> <span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">q</span><span class="p">)</span>
            <span class="n">p</span>          <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">T</span>  <span class="o">@</span> <span class="n">t</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">t</span><span class="p">)</span>
            
            <span class="n">X_</span> <span class="o">=</span> <span class="n">X_</span><span class="o">-</span> <span class="n">t</span> <span class="o">@</span> <span class="n">p</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="n">Y_</span><span class="o">-</span> <span class="n">t</span> <span class="o">@</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span>
            
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">W</span>     <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">T</span>     <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Q</span>     <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">U</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">P</span>     <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">W</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">W</span><span class="p">,</span><span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">T</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">Q</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span><span class="n">q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">U</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">P</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                
                <span class="n">r2X_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2X</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="n">r2X_</span><span class="p">))</span>
                <span class="n">r2Xpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">r2Xpv_</span><span class="p">))</span>
                
                <span class="n">r2Y_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="n">r2Ypv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="n">r2Y_</span><span class="p">))</span>
                <span class="n">r2Ypv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">r2Ypv_</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Ws</span><span class="o">=</span><span class="n">W</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span><span class="p">)</span>
        <span class="c1">#Adjustment</span>
        <span class="n">Ws</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">W</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">)</span>
        <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LV #     Eig       R2X       sum(R2X)   R2Y       sum(R2Y)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>    
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d3</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d3</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>   
        
        <span class="n">pls_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">:</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;Ws&#39;</span><span class="p">:</span><span class="n">Ws</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">,</span><span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2X</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2Xpv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">,</span><span class="s1">&#39;r2y&#39;</span><span class="p">:</span><span class="n">r2Y</span><span class="p">,</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">:</span><span class="n">r2Ypv</span><span class="p">,</span><span class="s1">&#39;my&#39;</span><span class="p">:</span><span class="n">y_mean</span><span class="p">,</span><span class="s1">&#39;sy&#39;</span><span class="p">:</span><span class="n">y_std</span><span class="p">}</span>  
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;obsidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidY</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidY</span>
            
        <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
        <span class="n">n</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
        <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
        <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
        <span class="n">speY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speY_lim95</span><span class="p">,</span><span class="n">speY_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speY</span><span class="p">)</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">T2</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim99</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim95</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speX</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim99</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim95</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speY</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim99</span>
        <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim95</span>
        <span class="k">if</span> <span class="n">cca</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">Tcv</span><span class="p">,</span><span class="n">Pcv</span><span class="p">,</span><span class="n">Wcv</span><span class="p">,</span><span class="n">Betacv</span><span class="o">=</span><span class="n">pls_cca</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">,</span><span class="n">Xmcs</span><span class="p">,</span><span class="n">Ymcs</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="p">)</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Tcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Tcv</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Pcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Pcv</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Wcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Wcv</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Betacv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Betacv</span>
        <span class="k">return</span> <span class="n">pls_obj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">md_algorithm</span><span class="o">==</span><span class="s1">&#39;nipals&#39;</span><span class="p">:</span>
             <span class="c1">#use nipals</span>
             <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pls using NIPALS executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
             <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
             <span class="n">Y_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
             <span class="n">epsilon</span><span class="o">=</span><span class="mf">1E-9</span>
             <span class="n">maxit</span><span class="o">=</span><span class="mi">2000</span>
             <span class="k">if</span> <span class="n">cca</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>    
                 <span class="n">Xmcs</span><span class="o">=</span><span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                 <span class="n">Ymcs</span><span class="o">=</span><span class="n">Y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

             <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
             <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
             <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
             <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
             
             <span class="c1">#T=[];</span>
             <span class="c1">#P=[];</span>
             <span class="c1">#r2=[];</span>
             <span class="c1">#r2pv=[];</span>
             <span class="c1">#numIT=[];</span>
             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                 <span class="c1"># Select column with largest variance in Y as initial guess</span>
                 <span class="n">ui</span> <span class="o">=</span> <span class="n">Y_</span><span class="p">[:,[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">Y_</span><span class="p">))]]</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">False</span>
                 <span class="n">num_it</span><span class="o">=</span><span class="mi">0</span>
                 <span class="k">while</span> <span class="n">Converged</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                      <span class="c1"># %Step 1. w=X&#39;u/u&#39;u</span>
                      <span class="n">uimat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ui</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                      <span class="n">wi</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">*</span><span class="n">uimat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">uimat</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                      <span class="c1">#Step 2. Normalize w to unit length.</span>
                      <span class="n">wi</span><span class="o">=</span><span class="n">wi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wi</span><span class="p">)</span>
                      <span class="c1">#Step 3. ti= (Xw)/(w&#39;w);</span>
                      <span class="n">wimat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">wi</span><span class="p">,(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
                      <span class="n">ti</span><span class="o">=</span> <span class="n">X_</span> <span class="o">@</span> <span class="n">wi</span><span class="o">.</span><span class="n">T</span>
                      <span class="n">wtw</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">wimat</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                      <span class="n">ti</span><span class="o">=</span><span class="n">ti</span><span class="o">/</span><span class="n">wtw</span>
                      <span class="n">ti</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                      <span class="n">wi</span><span class="o">=</span><span class="n">wi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                      <span class="c1">#Step 4 q=Y&#39;t/t&#39;t</span>
                      <span class="n">timat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ti</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                      <span class="n">qi</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">*</span><span class="n">timat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">timat</span><span class="o">*</span><span class="n">not_Ymiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                      <span class="c1">#Step 5 un=(Yq)/(q&#39;q)</span>
                      <span class="n">qimat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">qi</span><span class="p">,(</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
                      <span class="n">qi</span><span class="o">=</span><span class="n">qi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                      <span class="n">un</span><span class="o">=</span> <span class="n">Y_</span> <span class="o">@</span> <span class="n">qi</span>
                      <span class="n">qtq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">qimat</span><span class="o">*</span><span class="n">not_Ymiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                      <span class="n">qtq</span><span class="o">=</span><span class="n">qtq</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                      <span class="n">un</span><span class="o">=</span><span class="n">un</span><span class="o">/</span><span class="n">qtq</span>
                      <span class="n">un</span><span class="o">=</span><span class="n">un</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                      
                      <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">un</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                          <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                      <span class="k">if</span> <span class="n">num_it</span> <span class="o">&gt;</span> <span class="n">maxit</span><span class="p">:</span>
                          <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                      <span class="k">if</span> <span class="n">Converged</span><span class="p">:</span>
                          <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">ti</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]):</span>
                             <span class="n">ti</span><span class="o">=-</span><span class="n">ti</span>
                             <span class="n">wi</span><span class="o">=-</span><span class="n">wi</span>
                             <span class="n">un</span><span class="o">=-</span><span class="n">un</span>
                             <span class="n">qi</span><span class="o">=-</span><span class="n">qi</span>
                          <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# Iterations for LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num_it</span><span class="p">))</span>
                          <span class="c1"># Calculate P&#39;s for deflation p=Xt/(t&#39;t)      </span>
                          <span class="n">timat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ti</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                          <span class="n">pi</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">*</span><span class="n">timat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">timat</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                          <span class="n">pi</span><span class="o">=</span><span class="n">pi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                          <span class="c1"># Deflate X leaving missing as zeros (important!)</span>
                          <span class="n">X_</span><span class="o">=</span><span class="p">(</span><span class="n">X_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
                          <span class="n">Y_</span><span class="o">=</span><span class="p">(</span><span class="n">Y_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
                          
                          <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                              <span class="n">T</span><span class="o">=</span><span class="n">ti</span>
                              <span class="n">P</span><span class="o">=</span><span class="n">pi</span>
                              <span class="n">W</span><span class="o">=</span><span class="n">wi</span>
                              <span class="n">U</span><span class="o">=</span><span class="n">un</span>
                              <span class="n">Q</span><span class="o">=</span><span class="n">qi</span>
                              <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                              <span class="n">r2Xpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                              <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                              <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                              <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                              <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                          <span class="k">else</span><span class="p">:</span>
                              <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                              <span class="n">U</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">un</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                              <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">pi</span><span class="p">))</span>   
                              <span class="n">W</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">W</span><span class="p">,</span><span class="n">wi</span><span class="p">))</span>
                              <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span><span class="n">qi</span><span class="p">))</span>
                                             
                              <span class="n">r2X_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                              <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                              <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                              <span class="n">r2X</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="n">r2X_</span><span class="p">))</span>
                              <span class="n">r2Xpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">r2Xpv_</span><span class="p">))</span>
                
                              <span class="n">r2Y_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                              <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                              <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="n">r2Ypv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                              <span class="n">r2Y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="n">r2Y_</span><span class="p">))</span>
                              <span class="n">r2Ypv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">r2Ypv_</span><span class="p">))</span>
                      <span class="k">else</span><span class="p">:</span>
                          <span class="n">num_it</span> <span class="o">=</span> <span class="n">num_it</span> <span class="o">+</span> <span class="mi">1</span>
                          <span class="n">ui</span> <span class="o">=</span> <span class="n">un</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">numIT</span><span class="o">=</span><span class="n">num_it</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">numIT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">numIT</span><span class="p">,</span><span class="n">num_it</span><span class="p">))</span>
                     
             <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                 <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
             
             <span class="n">Ws</span><span class="o">=</span><span class="n">W</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span><span class="p">)</span>
             <span class="c1">#Adjustment</span>
             <span class="n">Ws</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">W</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
             <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
             <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">)</span>
             <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LV #     Eig       R2X       sum(R2X)   R2Y       sum(R2Y)&#39;</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>    
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                 <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d3</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d3</span><span class="p">))</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>   
                       
             <span class="n">pls_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">:</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;Ws&#39;</span><span class="p">:</span><span class="n">Ws</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">,</span><span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2X</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2Xpv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">,</span><span class="s1">&#39;r2y&#39;</span><span class="p">:</span><span class="n">r2Y</span><span class="p">,</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">:</span><span class="n">r2Ypv</span><span class="p">,</span><span class="s1">&#39;my&#39;</span><span class="p">:</span><span class="n">y_mean</span><span class="p">,</span><span class="s1">&#39;sy&#39;</span><span class="p">:</span><span class="n">y_std</span><span class="p">}</span>  
             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                 <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
                 <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;obsidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidY</span>
                <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidY</span>    
                
             <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
             <span class="n">n</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
             <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
             <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
             <span class="n">speY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">speY_lim95</span><span class="p">,</span><span class="n">speY_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speY</span><span class="p">)</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">T2</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim99</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim95</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speX</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim99</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim95</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speY</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim99</span>
             <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim95</span>
             <span class="k">if</span> <span class="n">cca</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                 <span class="n">Tcv</span><span class="p">,</span><span class="n">Pcv</span><span class="p">,</span><span class="n">Wcv</span><span class="p">,</span><span class="n">Betacv</span><span class="o">=</span><span class="n">pls_cca</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">,</span><span class="n">Xmcs</span><span class="p">,</span><span class="n">Ymcs</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="p">)</span>
                 <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Tcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Tcv</span>
                 <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Pcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Pcv</span>
                 <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Wcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Wcv</span>
                 <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Betacv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Betacv</span>
             <span class="k">return</span> <span class="n">pls_obj</span>   
                         
        <span class="k">elif</span> <span class="n">md_algorithm</span><span class="o">==</span><span class="s1">&#39;nlp&#39;</span><span class="p">:</span>
            <span class="c1">#use NLP per Journal of Chemometrics, 28(7), pp.575-584. and a modification from Sal.</span>
            <span class="n">shush</span><span class="o">=</span><span class="kc">False</span>         
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.pls using NLP with Ipopt executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
            <span class="n">Y_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
            <span class="n">plsobj_</span><span class="o">=</span> <span class="n">pls_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="n">mcsX</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="n">mcsY</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plsobj_</span><span class="o">=</span> <span class="n">prep_pls_4_MDbyNLP</span><span class="p">(</span><span class="n">plsobj_</span><span class="p">,</span><span class="n">X_</span><span class="p">,</span><span class="n">Y_</span><span class="p">)</span>
              
            <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#Set up the model in Pyomo</span>
            <span class="n">model</span>             <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">A</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">N</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">M</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_M&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">O</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_O&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">P</span>           <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_P_init&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">T</span>           <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_T_init&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">psi</span>         <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_psi&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">X</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_X&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">theta</span>       <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_theta&#39;</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Y</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Y&#39;</span><span class="p">])</span>           
            <span class="n">model</span><span class="o">.</span><span class="n">delta</span>       <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">a1</span><span class="o">==</span><span class="n">a2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Constraints 27b and 27c</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_c27bc_con</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">a1</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">c27bc</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">_c27bc_con</span><span class="p">)</span>
            
            <span class="c1"># Constraints 27d</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_27d_con</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="n">a1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">a1</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>
            <span class="n">model</span><span class="o">.</span><span class="n">c27d</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">_27d_con</span><span class="p">)</span>
            
            <span class="c1"># Constraints 27e</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_27e_con</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>  <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span> <span class="p">)</span><span class="o">==</span><span class="mi">0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">c27e</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span><span class="n">rule</span><span class="o">=</span><span class="n">_27e_con</span><span class="p">)</span>
            
            <span class="k">def</span><span class="w"> </span><span class="nf">_eq_27a_obj</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">]</span><span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">psi</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_eq_27a_obj</span><span class="p">)</span>
            
            <span class="c1"># Setup our solver as either local ipopt, gams:ipopt, or neos ipopt:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ipopt_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using local IPOPT executable&quot;</span><span class="p">)</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
            
                <span class="k">if</span> <span class="p">(</span><span class="n">ma57_ok</span><span class="p">):</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ma57&#39;</span>
            
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">gams_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using GAMS/IPOPT interface&quot;</span><span class="p">)</span>
                <span class="c1"># &#39;just &#39;ipopt&#39; could work, if no binary in path</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;gams:ipopt&#39;</span><span class="p">)</span>
            
                <span class="c1"># It doesn&#39;t seem to notice the opt file when I write it</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using IPOPT on remote NEOS server&quot;</span><span class="p">)</span>
                <span class="n">solver_manager</span> <span class="o">=</span> <span class="n">SolverManagerFactory</span><span class="p">(</span><span class="s1">&#39;neos&#39;</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver_manager</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">T</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">:</span>
                 <span class="n">t</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
                 <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   
            <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>     
            <span class="n">P</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">:</span>
                 <span class="n">p</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
                 <span class="n">P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>   
            <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>   
            
           <span class="c1"># Obtain a Ws with NLP</span>
           <span class="c1">#Set up the model in Pyomo</span>
            <span class="n">Taux</span>               <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
            <span class="n">modelb</span>             <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">A</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">N</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">O</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_O&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">Ws</span>          <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Ws_init&#39;</span><span class="p">])</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">T</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">Taux</span><span class="p">)</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">psi</span>         <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_psi&#39;</span><span class="p">])</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">X</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_X&#39;</span><span class="p">])</span>
       
            <span class="k">def</span><span class="w"> </span><span class="nf">_eq_obj</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">psi</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Ws</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>  <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">)</span>
            <span class="n">modelb</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_eq_obj</span><span class="p">)</span>
            <span class="c1"># Setup our solver as either local ipopt, gams:ipopt, or neos ipopt:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ipopt_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using local IPOPT executable&quot;</span><span class="p">)</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
            
                <span class="k">if</span> <span class="p">(</span><span class="n">ma57_ok</span><span class="p">):</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ma57&#39;</span>
            
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">modelb</span><span class="p">,</span><span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">gams_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using GAMS/IPOPT interface&quot;</span><span class="p">)</span>
                <span class="c1"># &#39;just &#39;ipopt&#39; could work, if no binary in path</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;gams:ipopt&#39;</span><span class="p">)</span>
            
                <span class="c1"># It doesn&#39;t seem to notice the opt file when I write it</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">modelb</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using IPOPT on remote NEOS server&quot;</span><span class="p">)</span>
                <span class="n">solver_manager</span> <span class="o">=</span> <span class="n">SolverManagerFactory</span><span class="p">(</span><span class="s1">&#39;neos&#39;</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver_manager</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">modelb</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">Ws</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">modelb</span><span class="o">.</span><span class="n">N</span><span class="p">:</span>
                 <span class="n">ws</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">modelb</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
                    <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">modelb</span><span class="o">.</span><span class="n">Ws</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
                 <span class="n">Ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>   
            <span class="n">Ws</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ws</span><span class="p">)</span>               
            
            
            <span class="n">Xhat</span>              <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Xaux</span>              <span class="o">=</span> <span class="n">X_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">Xaux</span><span class="p">[</span><span class="n">X_nan_map</span><span class="p">]</span>   <span class="o">=</span> <span class="n">Xhat</span><span class="p">[</span><span class="n">X_nan_map</span><span class="p">]</span>
            <span class="n">Xaux</span>              <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">Xaux</span><span class="p">)</span>
            <span class="n">Taux</span>              <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
            
            <span class="c1">#Set up the model in Pyomo</span>
            <span class="n">model2</span>             <span class="o">=</span> <span class="n">ConcreteModel</span><span class="p">()</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">A</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">N</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">M</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_M&#39;</span><span class="p">])</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">O</span>           <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_O&#39;</span><span class="p">]</span> <span class="p">)</span>
            
            <span class="n">model2</span><span class="o">.</span><span class="n">T</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">Taux</span><span class="p">)</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">Q</span>           <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">within</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Q_init&#39;</span><span class="p">])</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">X</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_X&#39;</span><span class="p">])</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">theta</span>       <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_theta&#39;</span><span class="p">])</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">Y</span>           <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Y&#39;</span><span class="p">])</span>           
            <span class="n">model2</span><span class="o">.</span><span class="n">delta</span>       <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">model</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">a1</span><span class="o">==</span><span class="n">a2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            
            
            <span class="k">def</span><span class="w"> </span><span class="nf">_eq_36a_mod_obj</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">n</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">m</span><span class="p">]</span><span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">A</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">O</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">Objective</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">_eq_36a_mod_obj</span><span class="p">)</span>
            
            <span class="c1"># Setup our solver as either local ipopt, gams:ipopt, or neos ipopt:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ipopt_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using local IPOPT executable&quot;</span><span class="p">)</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
            
                <span class="k">if</span> <span class="p">(</span><span class="n">ma57_ok</span><span class="p">):</span>
                    <span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ma57&#39;</span>
            
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span><span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">gams_ok</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using GAMS/IPOPT interface&quot;</span><span class="p">)</span>
                <span class="c1"># &#39;just &#39;ipopt&#39; could work, if no binary in path</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;gams:ipopt&#39;</span><span class="p">)</span>
            
                <span class="c1"># It doesn&#39;t seem to notice the opt file when I write it</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving NLP using IPOPT on remote NEOS server&quot;</span><span class="p">)</span>
                <span class="n">solver_manager</span> <span class="o">=</span> <span class="n">SolverManagerFactory</span><span class="p">(</span><span class="s1">&#39;neos&#39;</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">solver_manager</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
               
            <span class="n">Q</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model2</span><span class="o">.</span><span class="n">M</span><span class="p">:</span>
                 <span class="n">q</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">model2</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
                 <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>   
            <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>  
            
         
            <span class="c1"># Calculate R2</span>
               
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">A</span><span class="p">)):</span>
                 <span class="n">ti</span><span class="o">=</span><span class="n">T</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                 <span class="n">pi</span><span class="o">=</span><span class="n">P</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                 <span class="n">qi</span><span class="o">=</span><span class="n">Q</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                 <span class="n">X_</span><span class="o">=</span><span class="p">(</span><span class="n">X_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
                 <span class="n">Y_</span><span class="o">=</span><span class="p">(</span><span class="n">Y_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>        
                    <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                    <span class="n">r2Xpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                    <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>        
                    <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                    <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                    <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                 <span class="k">else</span><span class="p">:</span>        
                    <span class="n">r2X_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                    <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                    <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">r2X</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="n">r2X_</span><span class="p">))</span>
                    <span class="n">r2Xpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">r2Xpv_</span><span class="p">))</span>
                    <span class="n">r2Y_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                    <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                    <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="n">r2Ypv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">r2Y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="n">r2Y_</span><span class="p">))</span>
                    <span class="n">r2Ypv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">r2Ypv_</span><span class="p">))</span>
                            
                    
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                 
            <span class="c1">#Ws=W @ np.linalg.pinv(P.T @ W)</span>
            <span class="c1">#Ws=P</span>
            <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">)</span>
            <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LV #     Eig       R2X       sum(R2X)   R2Y       sum(R2Y)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>    
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d3</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d3</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>   
            <span class="n">W</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">U</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">pls_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">:</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;Ws&#39;</span><span class="p">:</span><span class="n">Ws</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">,</span><span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2X</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2Xpv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">,</span><span class="s1">&#39;r2y&#39;</span><span class="p">:</span><span class="n">r2Y</span><span class="p">,</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">:</span><span class="n">r2Ypv</span><span class="p">,</span><span class="s1">&#39;my&#39;</span><span class="p">:</span><span class="n">y_mean</span><span class="p">,</span><span class="s1">&#39;sy&#39;</span><span class="p">:</span><span class="n">y_std</span><span class="p">}</span>  
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
                <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;obsidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidY</span>
                <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidY</span>
                
            <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
            <span class="n">n</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
            <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
            <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
            <span class="n">speY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">speY_lim95</span><span class="p">,</span><span class="n">speY_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speY</span><span class="p">)</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">T2</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim99</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim95</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speX</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim99</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim95</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speY</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim99</span>
            <span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim95</span>
            <span class="k">return</span> <span class="n">pls_obj</span> </div>


<div class="viewcode-block" id="lwpls">
<a class="viewcode-back" href="../pyphi.html#pyphi.lwpls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lwpls</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">loc_par</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; LWPLS algorithm as in: International Journal of Pharmaceutics 421 (2011) 269– 274</span>
<span class="sd">    </span>
<span class="sd">    Implemented by Salvador Garcia-Munoz</span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    yhat = pyphi.lwpls(xnew,loc_par,mvmobj,X,Y,&lt;shush=False&gt;)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        xnew (Numpy vector): Regressor vector to make prediction</span>
<span class="sd">        loc_par (scalar): Localization parameter</span>
<span class="sd">        mvmobj : PLS model between X and Y built with PLS routine</span>
<span class="sd">        X,Y (DataFrame or Numpy): Training set for mvmobj (PLS model) </span>
<span class="sd">        </span>
<span class="sd">    Other Parameters:</span>
<span class="sd">        shush  : =&#39;True&#39;  will silent outpuit</span>
<span class="sd">                  &#39;False&#39; will display outpuit  *default if not sent*</span>
<span class="sd">    Returns:</span>
<span class="sd">        y prediction from xnew</span>
<span class="sd">        </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.lwpls executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
    <span class="n">xnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xnew</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>     
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        
    <span class="n">vip</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2y&#39;</span><span class="p">],(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vip</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vip</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">vip</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">vip</span><span class="p">;</span> <span class="c1">#Using element wise operations for speed, no need for matrix notation</span>

    <span class="n">D</span>     <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xnew</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">d2</span>    <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">D</span>
    <span class="n">d2</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_par</span><span class="p">))</span>
    <span class="n">OMEGA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">omega</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">X_weighted_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">omega</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">X</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">Y_weighted_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">omega</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">Y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    
    <span class="n">X_weighted_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_weighted_mean</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_weighted_mean</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Y_weighted_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Y_weighted_mean</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_weighted_mean</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">Xi</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">X_weighted_mean</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Yi</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_weighted_mean</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">xnewi</span> <span class="o">=</span> <span class="n">xnew</span> <span class="o">-</span> <span class="n">X_weighted_mean</span>
    <span class="n">yhat</span><span class="o">=</span><span class="n">Y_weighted_mean</span>
    
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="p">[</span><span class="n">U_</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Wh</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Xi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">OMEGA</span> <span class="o">@</span> <span class="n">Yi</span> <span class="o">@</span> <span class="n">Yi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">OMEGA</span> <span class="o">@</span> <span class="n">Xi</span><span class="p">)</span>
        <span class="n">w</span>           <span class="o">=</span> <span class="n">Wh</span><span class="o">.</span><span class="n">T</span>
        <span class="n">w</span>           <span class="o">=</span> <span class="n">w</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Xi</span> <span class="o">@</span> <span class="n">w</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Xi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">OMEGA</span> <span class="o">@</span> <span class="n">t</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">OMEGA</span> <span class="o">@</span> <span class="n">t</span><span class="p">)</span>        
        <span class="n">q</span> <span class="o">=</span> <span class="n">Yi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">OMEGA</span> <span class="o">@</span> <span class="n">t</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">OMEGA</span> <span class="o">@</span> <span class="n">t</span><span class="p">)</span>
        
        <span class="n">tnew</span> <span class="o">=</span> <span class="n">xnewi</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">w</span>
        <span class="n">yhat</span>  <span class="o">=</span> <span class="n">yhat</span> <span class="o">+</span> <span class="n">q</span> <span class="o">@</span> <span class="n">tnew</span>         
        <span class="n">Xi</span>    <span class="o">=</span> <span class="n">Xi</span> <span class="o">-</span> <span class="n">t</span> <span class="o">@</span> <span class="n">p</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Yi</span>    <span class="o">=</span> <span class="n">Yi</span> <span class="o">-</span> <span class="n">t</span> <span class="o">@</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span>
        <span class="n">xnewi</span> <span class="o">=</span> <span class="n">xnewi</span> <span class="o">-</span> <span class="n">p</span> <span class="o">@</span> <span class="n">tnew</span>
    <span class="k">return</span> <span class="n">yhat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span></div>

    
    
<div class="viewcode-block" id="pca_pred">
<a class="viewcode-back" href="../pyphi.html#pyphi.pca_pred">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pca_pred</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">pcaobj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;p2mp&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to evaluate new data using an already built PCA model</span>
<span class="sd">    </span>
<span class="sd">    pred = pyphi.pca_pred(Xnew,pcaobj)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        X (DataFrame): Data to be evaluated with the given PCA model</span>
<span class="sd">        pcaobj: PCA object created by pyphi.pca routine</span>
<span class="sd">    Returns:</span>
<span class="sd">        pred: Dictionary with reconstructed values for X, Scores, Hotellings T2 and SPE for Xnew</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">Xnew</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">X_</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xnew</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
        <span class="n">X_mcs</span><span class="o">=</span> <span class="n">X_</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">X_mcs</span><span class="o">=</span> <span class="n">X_mcs</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>      
        <span class="n">tnew</span> <span class="o">=</span>  <span class="n">X_mcs</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>
        <span class="n">xhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">htt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spe</span>   <span class="o">=</span> <span class="n">X_mcs</span> <span class="o">-</span><span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">spe</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spe</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">xpred</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">xhat</span><span class="p">,</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span> <span class="s1">&#39;speX&#39;</span><span class="p">:</span><span class="n">spe</span><span class="p">,</span><span class="s1">&#39;T2&#39;</span><span class="p">:</span><span class="n">htt2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">algorithm</span><span class="o">==</span><span class="s1">&#39;p2mp&#39;</span><span class="p">:</span>  <span class="c1"># Using Projection to the model plane method for missing data    </span>
        <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        
        <span class="n">Xmcs</span><span class="o">=</span><span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">Xmcs</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Xmcs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Xmcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">row_missing_map</span><span class="o">=</span><span class="n">not_Xmiss</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">tempP</span> <span class="o">=</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">row_missing_map</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">PTP</span> <span class="o">=</span> <span class="n">tempP</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">tempP</span>  
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#tnew_ =    np.linalg.inv(PTP) @ tempP.T         @ Xmcs[[i],:].T                #inneficient  </span>
                <span class="n">tnew_</span><span class="p">,</span><span class="n">resid</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">PTP</span><span class="p">,(</span><span class="n">tempP</span><span class="o">.</span><span class="n">T</span>  <span class="o">@</span> <span class="n">Xmcs</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#better </span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">tnew_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">PTP</span><span class="p">)</span> <span class="o">@</span> <span class="n">tempP</span><span class="o">.</span><span class="n">T</span>  <span class="o">@</span> <span class="n">Xmcs</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span><span class="o">.</span><span class="n">T</span>                          <span class="c1">#if the sh** hits the fan</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">tnew</span> <span class="o">=</span> <span class="n">tnew_</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tnew</span><span class="p">,</span><span class="n">tnew_</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">xhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>        
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">htt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spe</span>   <span class="o">=</span> <span class="n">Xmcs</span> <span class="o">-</span><span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">spe</span>  <span class="o">=</span> <span class="n">spe</span> <span class="o">*</span> <span class="n">not_Xmiss</span>
        <span class="n">spe</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spe</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">xpred</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">xhat</span><span class="p">,</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span> <span class="s1">&#39;speX&#39;</span><span class="p">:</span><span class="n">spe</span><span class="p">,</span><span class="s1">&#39;T2&#39;</span><span class="p">:</span><span class="n">htt2</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">xpred</span></div>


<div class="viewcode-block" id="pls_pred">
<a class="viewcode-back" href="../pyphi.html#pyphi.pls_pred">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pls_pred</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">plsobj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to evaluate new data using an already built PLS model</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    pred = pyphi.pls_pred(Xnew,plsobj)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        X: Dataframe with new data to be project onto the PCA model</span>
<span class="sd">        plsobj: PLS object created by pyphi.pls routine</span>
<span class="sd">    Returns:</span>
<span class="sd">        pred: Dictionary with predicted values for X and Y, Scores  Hotellings T2 and SPE for Xnew</span>
<span class="sd">        if CCA = True in plsobj, then Tcv is also calculated</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;p2mp&#39;</span>
    <span class="n">force_deflation</span><span class="o">=</span><span class="kc">False</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">Xnew</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">X_</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xnew</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">data_</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">names_</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">data_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xnew</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">names_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">XMB</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">data_</span><span class="p">,</span><span class="s1">&#39;blknames&#39;</span><span class="p">:</span><span class="n">names_</span><span class="p">}</span>

        <span class="n">c</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]):</span>        
            <span class="n">x_</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>                     
            <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">X_</span><span class="o">=</span><span class="n">x_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X_</span><span class="p">,</span><span class="n">x_</span><span class="p">))</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>        
       
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">force_deflation</span><span class="p">):</span>
        <span class="n">tnew</span> <span class="o">=</span> <span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">xhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">htt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speX</span>  <span class="o">=</span> <span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span><span class="o">-</span><span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">speX</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">speX</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">ypred</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;Yhat&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">,</span><span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">xhat</span><span class="p">,</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span><span class="s1">&#39;speX&#39;</span><span class="p">:</span><span class="n">speX</span><span class="p">,</span><span class="s1">&#39;T2&#39;</span><span class="p">:</span><span class="n">htt2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">algorithm</span><span class="o">==</span><span class="s1">&#39;p2mp&#39;</span><span class="p">:</span>
        <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">Xmcs</span><span class="o">=</span><span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">Xmcs</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Xmcs</span><span class="p">)</span>        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Xmcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">row_missing_map</span><span class="o">=</span><span class="n">not_Xmiss</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span>
            <span class="n">tempW</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">row_missing_map</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">WTW</span>    <span class="o">=</span> <span class="n">tempW</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">tempW</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
                <span class="c1">#tnew_aux = np.linalg.inv(WTW) @ tempW[:,[a]].T  @ Xmcs[[i],:].T</span>
                <span class="n">tnew_aux</span><span class="p">,</span><span class="n">resid</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">WTW</span><span class="p">,(</span><span class="n">tempW</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>  <span class="o">@</span> <span class="n">Xmcs</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">Xmcs</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xmcs</span><span class="p">[[</span><span class="n">i</span><span class="p">],:]</span> <span class="o">-</span> <span class="n">tnew_aux</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">row_missing_map</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tnew_</span><span class="o">=</span><span class="n">tnew_aux</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tnew_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tnew_</span><span class="p">,</span><span class="n">tnew_aux</span><span class="p">))</span>
                    
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">tnew</span> <span class="o">=</span> <span class="n">tnew_</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tnew</span><span class="p">,</span><span class="n">tnew_</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">xhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">htt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">speX</span>  <span class="o">=</span> <span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span><span class="o">-</span><span class="p">(</span><span class="n">tnew</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">speX</span>  <span class="o">=</span> <span class="n">speX</span><span class="o">*</span><span class="n">not_Xmiss</span>
        <span class="n">speX</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">speX</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">ypred</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;Yhat&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">,</span><span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">xhat</span><span class="p">,</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span><span class="s1">&#39;speX&#39;</span><span class="p">:</span><span class="n">speX</span><span class="p">,</span><span class="s1">&#39;T2&#39;</span><span class="p">:</span><span class="n">htt2</span><span class="p">}</span> 
        <span class="k">if</span> <span class="s1">&#39;Wcv&#39;</span> <span class="ow">in</span> <span class="n">plsobj</span><span class="p">:</span>
            <span class="n">Tcv</span><span class="o">=</span><span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span> <span class="o">@</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Wcv&#39;</span><span class="p">]</span>
            <span class="n">ypred</span><span class="p">[</span><span class="s1">&#39;Tcv&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Tcv</span>
    <span class="k">return</span> <span class="n">ypred</span></div>


<div class="viewcode-block" id="hott2">
<a class="viewcode-back" href="../pyphi.html#pyphi.hott2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hott2</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">Xnew</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Tnew</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hott2_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">Tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Tnew</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">:</span>  
            <span class="n">xpred</span> <span class="o">=</span> <span class="n">pls_pred</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xpred</span> <span class="o">=</span> <span class="n">pca_pred</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">)</span>  
        <span class="n">Tnew</span><span class="o">=</span><span class="n">xpred</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">]</span>    
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hott2_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">Tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Tnew</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Tnew</span> <span class="o">=</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">hott2_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Tnew</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">var_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">Tnew</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hott2_</span></div>


<div class="viewcode-block" id="spe">
<a class="viewcode-back" href="../pyphi.html#pyphi.spe">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spe</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">,</span><span class="n">Xnew</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">Ynew</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">:</span>  
            <span class="n">xpred</span> <span class="o">=</span> <span class="n">pls_pred</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xpred</span> <span class="o">=</span> <span class="n">pca_pred</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">)</span>  
        <span class="n">Tnew</span><span class="o">=</span><span class="n">xpred</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">Xnew</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xnew</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ynew</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">Ynew</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ynew</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ynew</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="n">Xnewhat</span><span class="o">=</span> <span class="n">Tnew</span> <span class="o">@</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Xres</span> <span class="o">=</span> <span class="n">X_</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Xres</span> <span class="o">=</span> <span class="n">Xres</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Xres</span> <span class="o">=</span> <span class="n">Xres</span> <span class="o">-</span> <span class="n">Xnewhat</span>
        <span class="n">spex_</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xres</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Ynew</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">):</span>
            <span class="n">Ynewhat</span><span class="o">=</span> <span class="n">Tnew</span> <span class="o">@</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Yres</span> <span class="o">=</span> <span class="n">Y_</span>   <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],(</span><span class="n">Ynew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">Yres</span> <span class="o">=</span> <span class="n">Yres</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],(</span><span class="n">Ynew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">Yres</span> <span class="o">=</span> <span class="n">Yres</span> <span class="o">-</span> <span class="n">Ynewhat</span>
            <span class="n">spey_</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Yres</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">spex_</span><span class="p">,</span><span class="n">spey_</span>
        <span class="k">else</span><span class="p">:</span>      
            <span class="k">return</span> <span class="n">spex_</span></div>



<div class="viewcode-block" id="z2n">
<a class="viewcode-back" href="../pyphi.html#pyphi.z2n">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">z2n</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">X_nan_map</span><span class="p">):</span>
    <span class="n">X</span><span class="p">[</span><span class="n">X_nan_map</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="n2z">
<a class="viewcode-back" href="../pyphi.html#pyphi.n2z">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">n2z</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>            
    <span class="k">if</span> <span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">X_nan_map</span>       <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">X</span><span class="p">[</span><span class="n">X_nan_map</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_nan_map</span>       <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">X_nan_map</span></div>


<div class="viewcode-block" id="mean">
<a class="viewcode-back" href="../pyphi.html#pyphi.mean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">X_nan_map</span>       <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">X_</span><span class="p">[</span><span class="n">X_nan_map</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">aux</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#Calculate mean without accounting for NaN&#39;</span>
        <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">aux</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_mean</span></div>


<div class="viewcode-block" id="std">
<a class="viewcode-back" href="../pyphi.html#pyphi.std">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">std</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">x_mean</span><span class="o">=</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">x_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_mean</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">X_nan_map</span>             <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">X_</span>                    <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_</span><span class="p">[</span><span class="n">X_nan_map</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">0</span>
        <span class="n">aux_mat</span>               <span class="o">=</span> <span class="p">(</span><span class="n">X_</span><span class="o">-</span><span class="n">x_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">aux_mat</span><span class="p">[</span><span class="n">X_nan_map</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">aux</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#Calculate mean without accounting for NaN&#39;s</span>
        <span class="n">x_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">aux_mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">aux</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">x_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">x_std</span></div>

   
<div class="viewcode-block" id="meancenterscale">
<a class="viewcode-back" href="../pyphi.html#pyphi.meancenterscale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">meancenterscale</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to mean center and scale a matrix</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    X,xmean,xstd= pyphi.meancenterscale(X,&lt;mcs=Flag&gt;)</span>
<span class="sd">    Args:</span>
<span class="sd">        X: Matrix to be meancenterd this call ONLY works with Numpy matrices</span>
<span class="sd">        mcs = True | &#39;center&#39; | &#39;autoscale&#39;    </span>
<span class="sd">    Returns:</span>
<span class="sd">        X: Post-processed X matrix</span>
<span class="sd">        xmean: Mean values per column</span>
<span class="sd">        xstd: Standard Deviation values per column</span>
<span class="sd">    &#39;&#39;&#39;</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mcs</span><span class="p">:</span>
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">x_std</span>  <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">X</span>      <span class="o">=</span> <span class="n">X</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_mean</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">X</span>      <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_std</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">mcs</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
         <span class="n">x_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
         <span class="n">X</span>      <span class="o">=</span> <span class="n">X</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_mean</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
         <span class="n">x_std</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">mcs</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
         <span class="n">x_std</span>  <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> 
         <span class="n">X</span>      <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_std</span><span class="p">,(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
         <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">x_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span></div>


<div class="viewcode-block" id="spectra_snv">
<a class="viewcode-back" href="../pyphi.html#pyphi.spectra_snv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectra_snv</span> <span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to do row wise SNV transform for spectroscopic data</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    X=pyphi.spectra_snv(X)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        x: Spectra dataframe</span>
<span class="sd">    Returns:</span>
<span class="sd">        x: Post-processed Spectra dataframe</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">x_columns</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">x_values</span><span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>
        <span class="n">x_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">spectra_snv</span><span class="p">(</span><span class="n">x_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">xpd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">x_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xpd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">mean_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     
            <span class="n">mean_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mean_x</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">x</span>      <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mean_x</span>
            <span class="n">std_x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">std_x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_x</span><span class="p">)</span>
            <span class="n">std_x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">std_x</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">std_x</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">std_x</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">std_x</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">x</span>      <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">std_x</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">stdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">stdx</span>
            <span class="k">return</span> <span class="n">x</span></div>

    
<div class="viewcode-block" id="spectra_savgol">
<a class="viewcode-back" href="../pyphi.html#pyphi.spectra_savgol">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectra_savgol</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">od</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">Dm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to do row wise Savitzky-Golay filter for spectra</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    Dm_sg, M = pyphi.spectra_savgol(ws,od,op,Dm)</span>
<span class="sd">    Args:</span>
<span class="sd">        ws : Window Size</span>
<span class="sd">        od: Order of the derivative</span>
<span class="sd">        op: Order of the polynomial</span>
<span class="sd">        Dm: Spectra</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dm_sg: Processed Spectra</span>
<span class="sd">        M:     Transformation Matrix for new vector samples</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">x_columns</span><span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">FirstElement</span><span class="o">=</span><span class="p">[</span><span class="n">x_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">x_columns</span><span class="o">=</span><span class="n">x_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">FirstElement</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_columns</span><span class="p">[</span><span class="n">ws</span><span class="p">:</span><span class="o">-</span><span class="n">ws</span><span class="p">])</span>
        <span class="n">x_values</span><span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Col1</span><span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">Col1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Col1</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">aux</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">spectra_savgol</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">od</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">x_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">data_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Col1</span><span class="p">,</span><span class="n">aux</span><span class="p">))</span>
        <span class="n">xpd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">FirstElement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xpd</span><span class="p">,</span><span class="n">M</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
            <span class="n">l</span> <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">x_vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">ws</span><span class="p">,</span><span class="n">ws</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x_vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">ws</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">op</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">x_vec</span><span class="o">**</span><span class="n">oo</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>    
            <span class="n">XtXiXt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">XtXiXt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span>
        <span class="n">coeffs</span><span class="o">=</span><span class="n">XtXiXt</span><span class="p">[</span><span class="n">od</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">od</span><span class="p">)</span>
        <span class="n">coeffs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ws</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coeffs</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ws</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ws</span><span class="p">:</span>
                <span class="n">m_</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">coeffs</span><span class="p">))</span>
                <span class="n">m_</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">m_</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ws</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">m_</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ws</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="n">coeffs</span><span class="p">))</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">m_</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
            <span class="n">Dm_sg</span><span class="o">=</span>  <span class="n">M</span> <span class="o">@</span> <span class="n">Dm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Dm_sg</span><span class="o">=</span> <span class="n">Dm</span> <span class="o">@</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">Dm_sg</span><span class="p">,</span><span class="n">M</span></div>


<div class="viewcode-block" id="np2D2pyomo">
<a class="viewcode-back" href="../pyphi.html#pyphi.np2D2pyomo">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">np2D2pyomo</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">varids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Routine to convert a Numpy matrix in to a 2D dictionary for Pyomo</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    Xdic=pyphi.np2D2pyomo(X,&lt;varids=varId_list&gt;)</span>
<span class="sd">    Args:</span>
<span class="sd">        X (Numpy): Matrix to be converted</span>
<span class="sd">        varids: False | table of ids to be assigned as indexes</span>
<span class="sd">    Returns:</span>
<span class="sd">        Xdic: Matrix in dictionary format (as Pyomo likes it)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">varids</span><span class="p">):</span>
        <span class="n">output</span><span class="o">=</span><span class="nb">dict</span><span class="p">(((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">=</span><span class="nb">dict</span><span class="p">(((</span><span class="n">varids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="np1D2pyomo">
<a class="viewcode-back" href="../pyphi.html#pyphi.np1D2pyomo">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">np1D2pyomo</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">indexes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Routine to convert a vector in to a 1D dictionary for Pyomo</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    Xdic=pyphi.np1D2pyomo(X,&lt;varids=varId_list&gt;)</span>
<span class="sd">    Args:</span>
<span class="sd">        X (Numpy): Vector to be converted</span>
<span class="sd">        varids: False | table of ids to be assigned as indexes</span>
<span class="sd">    Returns:</span>
<span class="sd">        Xdic: Vector in dictionary format (as Pyomo likes it)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">arr</span><span class="o">=</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="n">output</span><span class="o">=</span><span class="nb">dict</span><span class="p">(((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">output</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="adapt_pls_4_pyomo">
<a class="viewcode-back" href="../pyphi.html#pyphi.adapt_pls_4_pyomo">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adapt_pls_4_pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">use_var_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Routine to create all the parameters in a PLS object </span>
<span class="sd">    to the structure needed by Pyomo</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    All parameters are added to the original plsobj with the prefix pyo_</span>

<span class="sd">    plsobj_pyomo = pyphi.adapt_pls_4_pyomo(plsobj, &lt;use_var_ids=False&gt;)</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        plsobj: A PLS object created with pyphi.pls</span>
<span class="sd">        </span>
<span class="sd">        use_var_ids: If True then al Variable IDs from plsobj are used as</span>
<span class="sd">                     indexes for the dictionaries requried by Pyomo</span>
<span class="sd">    Returns:</span>
<span class="sd">        plsobj_pyomo: A dictionary augmented with all parameters in dictionary format</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">plsobj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for LV&#39;s</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of X</span>
    <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of Y</span>
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">pyo_A</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">use_var_ids</span><span class="p">):</span>
        <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">pyo_N</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">pyo_M</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>    
        <span class="n">pyo_Ws</span> <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">])</span>
        <span class="n">pyo_Q</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">])</span>
        <span class="n">pyo_P</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>    
        <span class="n">var_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
        <span class="n">pyo_var_t</span> <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">var_t</span><span class="p">)</span>
        <span class="n">pyo_mx</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span>
        <span class="n">pyo_sx</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">])</span>
        <span class="n">pyo_my</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">])</span>
        <span class="n">pyo_sy</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span>
        <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span>
        <span class="n">pyo_Ws</span> <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">],</span><span class="n">varids</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">])</span>
        <span class="n">pyo_Q</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="p">,</span><span class="n">varids</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span>
        <span class="n">pyo_P</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="p">,</span><span class="n">varids</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">])</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
        <span class="n">pyo_var_t</span> <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">var_t</span><span class="p">)</span>
        <span class="n">pyo_mx</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],</span><span class="n">indexes</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">])</span>
        <span class="n">pyo_sx</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],</span><span class="n">indexes</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">])</span>
        <span class="n">pyo_my</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],</span><span class="n">indexes</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span>
        <span class="n">pyo_sy</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],</span><span class="n">indexes</span><span class="o">=</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span>
            
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_A</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_N</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_M&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_M</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Ws&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_Ws</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Q&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_Q</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_P&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_P</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_var_t&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pyo_var_t</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_mx&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_mx</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_sx&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_sx</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_my&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_my</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_sy&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_sy</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">plsobj_</span></div>


<div class="viewcode-block" id="spe_ci">
<a class="viewcode-back" href="../pyphi.html#pyphi.spe_ci">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spe_ci</span><span class="p">(</span><span class="n">spe</span><span class="p">):</span>    
    <span class="n">chi</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mf">1.6900</span><span class="p">,</span>    <span class="mf">4.0500</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">1.0000</span><span class="p">,</span>    <span class="mf">3.8400</span><span class="p">,</span>    <span class="mf">6.6300</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">2.0000</span><span class="p">,</span>    <span class="mf">5.9900</span><span class="p">,</span>    <span class="mf">9.2100</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">3.0000</span><span class="p">,</span>    <span class="mf">7.8100</span><span class="p">,</span>   <span class="mf">11.3400</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">4.0000</span><span class="p">,</span>    <span class="mf">9.4900</span><span class="p">,</span>   <span class="mf">13.2800</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">5.0000</span><span class="p">,</span>   <span class="mf">11.0700</span><span class="p">,</span>   <span class="mf">15.0900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">6.0000</span><span class="p">,</span>   <span class="mf">12.5900</span><span class="p">,</span>   <span class="mf">16.8100</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">7.0000</span><span class="p">,</span>   <span class="mf">14.0700</span><span class="p">,</span>   <span class="mf">18.4800</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">8.0000</span><span class="p">,</span>   <span class="mf">15.5100</span><span class="p">,</span>   <span class="mf">20.0900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">9.0000</span><span class="p">,</span>   <span class="mf">16.9200</span><span class="p">,</span>   <span class="mf">21.6700</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">10.0000</span><span class="p">,</span>   <span class="mf">18.3100</span><span class="p">,</span>   <span class="mf">23.2100</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">11.0000</span><span class="p">,</span>   <span class="mf">19.6800</span><span class="p">,</span>   <span class="mf">24.7200</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">12.0000</span><span class="p">,</span>   <span class="mf">21.0300</span><span class="p">,</span>   <span class="mf">26.2200</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">13.0000</span><span class="p">,</span>   <span class="mf">22.3600</span><span class="p">,</span>   <span class="mf">27.6900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">14.0000</span><span class="p">,</span>   <span class="mf">23.6800</span><span class="p">,</span>   <span class="mf">29.1400</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">15.0000</span><span class="p">,</span>   <span class="mf">25.0000</span><span class="p">,</span>   <span class="mf">30.5800</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">16.0000</span><span class="p">,</span>   <span class="mf">26.3000</span><span class="p">,</span>   <span class="mf">32.0000</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">17.0000</span><span class="p">,</span>   <span class="mf">27.5900</span><span class="p">,</span>   <span class="mf">33.4100</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">18.0000</span><span class="p">,</span>  <span class="mf">28.8700</span> <span class="p">,</span>  <span class="mf">34.8100</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">19.0000</span><span class="p">,</span>   <span class="mf">30.1400</span><span class="p">,</span>   <span class="mf">36.1900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">20.0000</span><span class="p">,</span>   <span class="mf">31.4100</span><span class="p">,</span>   <span class="mf">37.5700</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">21.0000</span><span class="p">,</span>   <span class="mf">32.6700</span><span class="p">,</span>   <span class="mf">38.9300</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">22.0000</span><span class="p">,</span>   <span class="mf">33.9200</span><span class="p">,</span>   <span class="mf">40.2900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">23.0000</span><span class="p">,</span>   <span class="mf">35.1700</span><span class="p">,</span>   <span class="mf">41.6400</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">24.0000</span><span class="p">,</span>   <span class="mf">36.4200</span><span class="p">,</span>   <span class="mf">42.9800</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">25.0000</span><span class="p">,</span>   <span class="mf">37.6500</span><span class="p">,</span>   <span class="mf">44.3100</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">26.0000</span><span class="p">,</span>   <span class="mf">38.8900</span><span class="p">,</span>   <span class="mf">45.6400</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">27.0000</span><span class="p">,</span>   <span class="mf">40.1100</span><span class="p">,</span>   <span class="mf">46.9600</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">28.0000</span><span class="p">,</span>   <span class="mf">41.3400</span><span class="p">,</span>   <span class="mf">48.2800</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">29.0000</span><span class="p">,</span>   <span class="mf">42.5600</span><span class="p">,</span>   <span class="mf">49.5900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">30.0000</span><span class="p">,</span>   <span class="mf">43.7700</span><span class="p">,</span>   <span class="mf">50.8900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">40.0000</span><span class="p">,</span>   <span class="mf">55.7600</span><span class="p">,</span>   <span class="mf">63.6900</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">50.0000</span><span class="p">,</span>   <span class="mf">67.5000</span><span class="p">,</span>   <span class="mf">76.1500</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">60.0000</span><span class="p">,</span>   <span class="mf">79.0800</span><span class="p">,</span>   <span class="mf">88.3800</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">70.0000</span><span class="p">,</span>   <span class="mf">90.5300</span><span class="p">,</span>  <span class="mf">100.4000</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">80.0000</span><span class="p">,</span>  <span class="mf">101.9000</span><span class="p">,</span>  <span class="mf">112.3000</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">90.0000</span><span class="p">,</span>  <span class="mf">113.1000</span><span class="p">,</span>  <span class="mf">124.1000</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">100.0000</span><span class="p">,</span>  <span class="mf">124.3000</span><span class="p">,</span>  <span class="mf">135.8000</span> <span class="p">]])</span>

    <span class="n">spem</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spem</span> <span class="o">&gt;</span> <span class="mf">1E-16</span><span class="p">:</span>
        <span class="n">spev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">spe</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span><span class="o">=</span><span class="p">(</span><span class="n">spev</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">spem</span><span class="p">))</span>
        <span class="n">h</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">spem</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">spev</span>
    
        <span class="n">lim95</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">chi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">chi</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lim99</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">chi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">chi</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">lim95</span><span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">lim95</span>
        <span class="n">lim99</span><span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">lim99</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lim95</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">lim99</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">return</span> <span class="n">lim95</span><span class="p">,</span><span class="n">lim99</span></div>


<div class="viewcode-block" id="single_score_conf_int">
<a class="viewcode-back" href="../pyphi.html#pyphi.single_score_conf_int">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">single_score_conf_int</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">tstud</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span>       <span class="mf">12.706</span><span class="p">,</span>       <span class="mf">63.657</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">2</span><span class="p">,</span>        <span class="mf">4.303</span><span class="p">,</span>        <span class="mf">9.925</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">3</span><span class="p">,</span>        <span class="mf">3.182</span><span class="p">,</span>        <span class="mf">5.841</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">4</span><span class="p">,</span>        <span class="mf">2.776</span><span class="p">,</span>        <span class="mf">4.604</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">5</span><span class="p">,</span>        <span class="mf">2.571</span><span class="p">,</span>        <span class="mf">4.032</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">6</span><span class="p">,</span>        <span class="mf">2.447</span><span class="p">,</span>        <span class="mf">3.707</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">7</span><span class="p">,</span>        <span class="mf">2.365</span><span class="p">,</span>        <span class="mf">3.499</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">8</span><span class="p">,</span>        <span class="mf">2.306</span><span class="p">,</span>        <span class="mf">3.355</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">9</span><span class="p">,</span>        <span class="mf">2.262</span><span class="p">,</span>        <span class="mf">3.250</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">10</span><span class="p">,</span>       <span class="mf">2.228</span><span class="p">,</span>        <span class="mf">3.169</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">11</span><span class="p">,</span>       <span class="mf">2.201</span><span class="p">,</span>        <span class="mf">3.106</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">12</span><span class="p">,</span>       <span class="mf">2.179</span><span class="p">,</span>        <span class="mf">3.055</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">13</span><span class="p">,</span>       <span class="mf">2.160</span><span class="p">,</span>        <span class="mf">3.012</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">14</span><span class="p">,</span>       <span class="mf">2.145</span><span class="p">,</span>        <span class="mf">2.977</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">15</span><span class="p">,</span>       <span class="mf">2.131</span><span class="p">,</span>        <span class="mf">2.947</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">16</span><span class="p">,</span>       <span class="mf">2.120</span><span class="p">,</span>        <span class="mf">2.921</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">17</span><span class="p">,</span>       <span class="mf">2.110</span><span class="p">,</span>        <span class="mf">2.898</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">18</span><span class="p">,</span>       <span class="mf">2.101</span><span class="p">,</span>        <span class="mf">2.878</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">19</span><span class="p">,</span>       <span class="mf">2.093</span><span class="p">,</span>        <span class="mf">2.861</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">20</span><span class="p">,</span>       <span class="mf">2.086</span><span class="p">,</span>        <span class="mf">2.845</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">21</span><span class="p">,</span>       <span class="mf">2.080</span><span class="p">,</span>        <span class="mf">2.831</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">22</span><span class="p">,</span>       <span class="mf">2.074</span><span class="p">,</span>        <span class="mf">2.819</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">23</span><span class="p">,</span>       <span class="mf">2.069</span><span class="p">,</span>        <span class="mf">2.807</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">24</span><span class="p">,</span>       <span class="mf">2.064</span><span class="p">,</span>        <span class="mf">2.797</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">25</span><span class="p">,</span>       <span class="mf">2.060</span><span class="p">,</span>        <span class="mf">2.787</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">26</span><span class="p">,</span>       <span class="mf">2.056</span><span class="p">,</span>        <span class="mf">2.779</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">27</span><span class="p">,</span>       <span class="mf">2.052</span><span class="p">,</span>        <span class="mf">2.771</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">28</span><span class="p">,</span>       <span class="mf">2.048</span><span class="p">,</span>        <span class="mf">2.763</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">29</span><span class="p">,</span>       <span class="mf">2.045</span><span class="p">,</span>        <span class="mf">2.756</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">30</span><span class="p">,</span>       <span class="mf">2.042</span><span class="p">,</span>        <span class="mf">2.750</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">40</span><span class="p">,</span>       <span class="mf">2.021</span><span class="p">,</span>        <span class="mf">2.704</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">60</span><span class="p">,</span>       <span class="mf">2.000</span><span class="p">,</span>        <span class="mf">2.660</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">120</span><span class="p">,</span>      <span class="mf">1.980</span><span class="p">,</span>        <span class="mf">2.617</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">1000</span><span class="p">,</span>     <span class="mf">1.960</span><span class="p">,</span>        <span class="mf">2.576</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">1E6</span><span class="p">,</span>      <span class="mf">1.960</span><span class="p">,</span>        <span class="mf">2.576</span><span class="p">]])</span>

    <span class="n">st</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lim95</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tstud</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">tstud</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">lim99</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tstud</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">tstud</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">lim95</span><span class="o">=</span><span class="n">lim95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="n">lim99</span><span class="o">=</span><span class="n">lim99</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lim95</span><span class="p">,</span><span class="n">lim99</span></div>


<div class="viewcode-block" id="f99">
<a class="viewcode-back" href="../pyphi.html#pyphi.f99">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">f99</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="n">tab1</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">6.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">9.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">11.0</span><span class="p">,</span><span class="mf">12.0</span><span class="p">,</span><span class="mf">13.0</span><span class="p">,</span><span class="mf">14.0</span><span class="p">,</span><span class="mf">15.0</span><span class="p">,</span><span class="mf">16.0</span><span class="p">,</span><span class="mf">17.0</span><span class="p">,</span><span class="mf">18.0</span><span class="p">,</span><span class="mf">19.0</span><span class="p">,</span><span class="mf">20.0</span><span class="p">,</span><span class="mf">21.0</span><span class="p">,</span><span class="mf">22.0</span><span class="p">,</span><span class="mf">23.0</span><span class="p">,</span><span class="mf">24.0</span><span class="p">,</span><span class="mf">25.0</span><span class="p">,</span><span class="mf">26.0</span><span class="p">,</span><span class="mf">27.0</span><span class="p">,</span><span class="mf">28.0</span><span class="p">,</span><span class="mf">29.0</span><span class="p">,</span><span class="mf">30.0</span><span class="p">,</span><span class="mf">40.0</span><span class="p">,</span><span class="mf">60.0</span><span class="p">,</span><span class="mf">120.0</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">4052</span><span class="p">,</span><span class="mf">98.5</span><span class="p">,</span><span class="mf">34.12</span><span class="p">,</span><span class="mf">21.2</span><span class="p">,</span><span class="mf">16.26</span><span class="p">,</span><span class="mf">13.75</span><span class="p">,</span><span class="mf">12.25</span><span class="p">,</span><span class="mf">11.26</span><span class="p">,</span><span class="mf">10.56</span><span class="p">,</span><span class="mf">10.04</span><span class="p">,</span><span class="mf">9.65</span><span class="p">,</span><span class="mf">9.33</span><span class="p">,</span><span class="mf">9.07</span><span class="p">,</span><span class="mf">8.86</span><span class="p">,</span><span class="mf">8.68</span><span class="p">,</span><span class="mf">8.53</span><span class="p">,</span><span class="mf">8.4</span><span class="p">,</span><span class="mf">8.29</span><span class="p">,</span><span class="mf">8.18</span><span class="p">,</span><span class="mf">8.1</span><span class="p">,</span><span class="mf">8.02</span><span class="p">,</span><span class="mf">7.95</span><span class="p">,</span><span class="mf">7.88</span><span class="p">,</span><span class="mf">7.82</span><span class="p">,</span><span class="mf">7.77</span><span class="p">,</span><span class="mf">7.72</span><span class="p">,</span><span class="mf">7.68</span><span class="p">,</span><span class="mf">7.64</span><span class="p">,</span><span class="mf">7.6</span><span class="p">,</span><span class="mf">7.56</span><span class="p">,</span><span class="mf">7.31</span><span class="p">,</span><span class="mf">7.08</span><span class="p">,</span><span class="mf">6.85</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">4999.5</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mf">30.82</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mf">13.27</span><span class="p">,</span><span class="mf">10.92</span><span class="p">,</span><span class="mf">9.55</span><span class="p">,</span><span class="mf">8.65</span><span class="p">,</span><span class="mf">8.02</span><span class="p">,</span><span class="mf">7.56</span><span class="p">,</span><span class="mf">7.21</span><span class="p">,</span><span class="mf">6.93</span><span class="p">,</span><span class="mf">6.7</span><span class="p">,</span><span class="mf">6.51</span><span class="p">,</span><span class="mf">6.36</span><span class="p">,</span><span class="mf">6.23</span><span class="p">,</span><span class="mf">6.11</span><span class="p">,</span><span class="mf">6.01</span><span class="p">,</span><span class="mf">5.93</span><span class="p">,</span><span class="mf">5.85</span><span class="p">,</span><span class="mf">5.78</span><span class="p">,</span><span class="mf">5.72</span><span class="p">,</span><span class="mf">5.66</span><span class="p">,</span><span class="mf">5.61</span><span class="p">,</span><span class="mf">5.57</span><span class="p">,</span><span class="mf">5.53</span><span class="p">,</span><span class="mf">5.49</span><span class="p">,</span><span class="mf">5.45</span><span class="p">,</span><span class="mf">5.42</span><span class="p">,</span><span class="mf">5.39</span><span class="p">,</span><span class="mf">5.18</span><span class="p">,</span><span class="mf">4.98</span><span class="p">,</span><span class="mf">4.79</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span><span class="mi">5403</span><span class="p">,</span><span class="mf">99.17</span><span class="p">,</span><span class="mf">29.46</span><span class="p">,</span><span class="mf">16.69</span><span class="p">,</span><span class="mf">12.06</span><span class="p">,</span><span class="mf">9.78</span><span class="p">,</span><span class="mf">8.45</span><span class="p">,</span><span class="mf">7.59</span><span class="p">,</span><span class="mf">6.99</span><span class="p">,</span><span class="mf">6.55</span><span class="p">,</span><span class="mf">6.22</span><span class="p">,</span><span class="mf">5.95</span><span class="p">,</span><span class="mf">5.74</span><span class="p">,</span><span class="mf">5.56</span><span class="p">,</span><span class="mf">5.42</span><span class="p">,</span><span class="mf">5.29</span><span class="p">,</span><span class="mf">5.18</span><span class="p">,</span><span class="mf">5.09</span><span class="p">,</span><span class="mf">5.01</span><span class="p">,</span><span class="mf">4.94</span><span class="p">,</span><span class="mf">4.87</span><span class="p">,</span><span class="mf">4.82</span><span class="p">,</span><span class="mf">4.76</span><span class="p">,</span><span class="mf">4.72</span><span class="p">,</span><span class="mf">4.68</span><span class="p">,</span><span class="mf">4.64</span><span class="p">,</span><span class="mf">4.6</span><span class="p">,</span><span class="mf">4.57</span><span class="p">,</span><span class="mf">4.54</span><span class="p">,</span><span class="mf">4.51</span><span class="p">,</span><span class="mf">4.31</span><span class="p">,</span><span class="mf">4.13</span><span class="p">,</span><span class="mf">3.95</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span><span class="mi">5625</span><span class="p">,</span><span class="mf">99.25</span><span class="p">,</span><span class="mf">28.71</span><span class="p">,</span><span class="mf">15.98</span><span class="p">,</span><span class="mf">11.39</span><span class="p">,</span><span class="mf">9.15</span><span class="p">,</span><span class="mf">7.85</span><span class="p">,</span><span class="mf">7.01</span><span class="p">,</span><span class="mf">6.42</span><span class="p">,</span><span class="mf">5.99</span><span class="p">,</span><span class="mf">5.67</span><span class="p">,</span><span class="mf">5.4</span><span class="p">,</span><span class="mf">5.21</span><span class="p">,</span><span class="mf">5.04</span><span class="p">,</span><span class="mf">4.89</span><span class="p">,</span><span class="mf">4.77</span><span class="p">,</span><span class="mf">4.67</span><span class="p">,</span><span class="mf">4.58</span><span class="p">,</span><span class="mf">4.5</span><span class="p">,</span><span class="mf">4.43</span><span class="p">,</span><span class="mf">4.37</span><span class="p">,</span><span class="mf">4.31</span><span class="p">,</span><span class="mf">4.26</span><span class="p">,</span><span class="mf">4.22</span><span class="p">,</span><span class="mf">4.18</span><span class="p">,</span><span class="mf">4.14</span><span class="p">,</span><span class="mf">4.11</span><span class="p">,</span><span class="mf">4.07</span><span class="p">,</span><span class="mf">4.04</span><span class="p">,</span><span class="mf">4.02</span><span class="p">,</span><span class="mf">3.83</span><span class="p">,</span><span class="mf">3.65</span><span class="p">,</span><span class="mf">3.48</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span><span class="mi">5764</span><span class="p">,</span><span class="mf">99.3</span><span class="p">,</span><span class="mf">28.24</span><span class="p">,</span><span class="mf">15.52</span><span class="p">,</span><span class="mf">10.97</span><span class="p">,</span><span class="mf">8.75</span><span class="p">,</span><span class="mf">7.46</span><span class="p">,</span><span class="mf">6.63</span><span class="p">,</span><span class="mf">6.06</span><span class="p">,</span><span class="mf">5.64</span><span class="p">,</span><span class="mf">5.32</span><span class="p">,</span><span class="mf">5.06</span><span class="p">,</span><span class="mf">4.86</span><span class="p">,</span><span class="mf">4.69</span><span class="p">,</span><span class="mf">4.56</span><span class="p">,</span><span class="mf">4.44</span><span class="p">,</span><span class="mf">4.34</span><span class="p">,</span><span class="mf">4.25</span><span class="p">,</span><span class="mf">4.17</span><span class="p">,</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">4.04</span><span class="p">,</span><span class="mf">3.99</span><span class="p">,</span><span class="mf">3.94</span><span class="p">,</span><span class="mf">3.9</span><span class="p">,</span><span class="mf">3.85</span><span class="p">,</span><span class="mf">3.82</span><span class="p">,</span><span class="mf">3.78</span><span class="p">,</span><span class="mf">3.75</span><span class="p">,</span><span class="mf">3.73</span><span class="p">,</span><span class="mf">3.7</span><span class="p">,</span><span class="mf">3.51</span><span class="p">,</span><span class="mf">3.34</span><span class="p">,</span><span class="mf">3.17</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span><span class="mi">5859</span><span class="p">,</span><span class="mf">99.33</span><span class="p">,</span><span class="mf">27.91</span><span class="p">,</span><span class="mf">15.21</span><span class="p">,</span><span class="mf">10.67</span><span class="p">,</span><span class="mf">8.47</span><span class="p">,</span><span class="mf">7.19</span><span class="p">,</span><span class="mf">6.37</span><span class="p">,</span><span class="mf">5.8</span><span class="p">,</span><span class="mf">5.39</span><span class="p">,</span><span class="mf">5.07</span><span class="p">,</span><span class="mf">4.82</span><span class="p">,</span><span class="mf">4.62</span><span class="p">,</span><span class="mf">4.46</span><span class="p">,</span><span class="mf">4.32</span><span class="p">,</span><span class="mf">4.2</span><span class="p">,</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">4.01</span><span class="p">,</span><span class="mf">3.94</span><span class="p">,</span><span class="mf">3.87</span><span class="p">,</span><span class="mf">3.81</span><span class="p">,</span><span class="mf">3.76</span><span class="p">,</span><span class="mf">3.71</span><span class="p">,</span><span class="mf">3.67</span><span class="p">,</span><span class="mf">3.63</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.56</span><span class="p">,</span><span class="mf">3.53</span><span class="p">,</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">3.47</span><span class="p">,</span><span class="mf">3.29</span><span class="p">,</span><span class="mf">3.12</span><span class="p">,</span><span class="mf">2.96</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">7.0</span><span class="p">,</span><span class="mi">5928</span><span class="p">,</span><span class="mf">99.36</span><span class="p">,</span><span class="mf">27.67</span><span class="p">,</span><span class="mf">14.98</span><span class="p">,</span><span class="mf">10.46</span><span class="p">,</span><span class="mf">8.26</span><span class="p">,</span><span class="mf">6.99</span><span class="p">,</span><span class="mf">6.18</span><span class="p">,</span><span class="mf">5.61</span><span class="p">,</span><span class="mf">5.2</span><span class="p">,</span><span class="mf">4.89</span><span class="p">,</span><span class="mf">4.64</span><span class="p">,</span><span class="mf">4.44</span><span class="p">,</span><span class="mf">4.28</span><span class="p">,</span><span class="mf">4.14</span><span class="p">,</span><span class="mf">4.03</span><span class="p">,</span><span class="mf">3.93</span><span class="p">,</span><span class="mf">3.84</span><span class="p">,</span><span class="mf">3.77</span><span class="p">,</span><span class="mf">3.7</span><span class="p">,</span><span class="mf">3.64</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.54</span><span class="p">,</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">3.46</span><span class="p">,</span><span class="mf">3.42</span><span class="p">,</span><span class="mf">3.39</span><span class="p">,</span><span class="mf">3.36</span><span class="p">,</span><span class="mf">3.33</span><span class="p">,</span><span class="mf">3.3</span><span class="p">,</span><span class="mf">3.12</span><span class="p">,</span><span class="mf">2.95</span><span class="p">,</span><span class="mf">2.79</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span><span class="mi">5982</span><span class="p">,</span><span class="mf">99.37</span><span class="p">,</span><span class="mf">27.49</span><span class="p">,</span><span class="mf">14.8</span><span class="p">,</span><span class="mf">10.29</span><span class="p">,</span><span class="mf">8.1</span><span class="p">,</span><span class="mf">6.84</span><span class="p">,</span><span class="mf">6.03</span><span class="p">,</span><span class="mf">5.47</span><span class="p">,</span><span class="mf">5.06</span><span class="p">,</span><span class="mf">4.74</span><span class="p">,</span><span class="mf">4.5</span><span class="p">,</span><span class="mf">4.3</span><span class="p">,</span><span class="mf">4.14</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">3.89</span><span class="p">,</span><span class="mf">3.79</span><span class="p">,</span><span class="mf">3.71</span><span class="p">,</span><span class="mf">3.63</span><span class="p">,</span><span class="mf">3.56</span><span class="p">,</span><span class="mf">3.51</span><span class="p">,</span><span class="mf">3.45</span><span class="p">,</span><span class="mf">3.41</span><span class="p">,</span><span class="mf">3.36</span><span class="p">,</span><span class="mf">3.32</span><span class="p">,</span><span class="mf">3.29</span><span class="p">,</span><span class="mf">3.26</span><span class="p">,</span><span class="mf">3.23</span><span class="p">,</span><span class="mf">3.2</span><span class="p">,</span><span class="mf">3.17</span><span class="p">,</span><span class="mf">2.99</span><span class="p">,</span><span class="mf">2.82</span><span class="p">,</span><span class="mf">2.66</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">9.0</span><span class="p">,</span><span class="mi">6022</span><span class="p">,</span><span class="mf">99.39</span><span class="p">,</span><span class="mf">27.35</span><span class="p">,</span><span class="mf">14.66</span><span class="p">,</span><span class="mf">10.16</span><span class="p">,</span><span class="mf">7.98</span><span class="p">,</span><span class="mf">6.72</span><span class="p">,</span><span class="mf">5.91</span><span class="p">,</span><span class="mf">5.35</span><span class="p">,</span><span class="mf">4.94</span><span class="p">,</span><span class="mf">4.63</span><span class="p">,</span><span class="mf">4.39</span><span class="p">,</span><span class="mf">4.19</span><span class="p">,</span><span class="mf">4.03</span><span class="p">,</span><span class="mf">3.89</span><span class="p">,</span><span class="mf">3.78</span><span class="p">,</span><span class="mf">3.68</span><span class="p">,</span><span class="mf">3.6</span><span class="p">,</span><span class="mf">3.52</span><span class="p">,</span><span class="mf">3.46</span><span class="p">,</span><span class="mf">3.4</span><span class="p">,</span><span class="mf">3.35</span><span class="p">,</span><span class="mf">3.3</span><span class="p">,</span><span class="mf">3.26</span><span class="p">,</span><span class="mf">3.11</span><span class="p">,</span><span class="mf">3.18</span><span class="p">,</span><span class="mf">3.15</span><span class="p">,</span><span class="mf">3.12</span><span class="p">,</span><span class="mf">3.09</span><span class="p">,</span><span class="mf">3.07</span><span class="p">,</span><span class="mf">2.89</span><span class="p">,</span><span class="mf">2.72</span><span class="p">,</span><span class="mf">2.56</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span><span class="mi">6056</span><span class="p">,</span><span class="mf">99.4</span><span class="p">,</span><span class="mf">27.23</span><span class="p">,</span><span class="mf">14.55</span><span class="p">,</span><span class="mf">10.05</span><span class="p">,</span><span class="mf">7.87</span><span class="p">,</span><span class="mf">6.62</span><span class="p">,</span><span class="mf">5.81</span><span class="p">,</span><span class="mf">5.26</span><span class="p">,</span><span class="mf">4.85</span><span class="p">,</span><span class="mf">4.54</span><span class="p">,</span><span class="mf">4.3</span><span class="p">,</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">3.94</span><span class="p">,</span><span class="mf">3.8</span><span class="p">,</span><span class="mf">3.69</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.51</span><span class="p">,</span><span class="mf">3.43</span><span class="p">,</span><span class="mf">3.37</span><span class="p">,</span><span class="mf">3.31</span><span class="p">,</span><span class="mf">3.26</span><span class="p">,</span><span class="mf">3.21</span><span class="p">,</span><span class="mf">3.17</span><span class="p">,</span><span class="mf">3.13</span><span class="p">,</span><span class="mf">3.09</span><span class="p">,</span><span class="mf">3.06</span><span class="p">,</span><span class="mf">3.03</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.98</span><span class="p">,</span><span class="mf">2.8</span><span class="p">,</span><span class="mf">2.63</span><span class="p">,</span><span class="mf">2.47</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">12.0</span><span class="p">,</span><span class="mi">6106</span><span class="p">,</span><span class="mf">99.42</span><span class="p">,</span><span class="mf">27.05</span><span class="p">,</span><span class="mf">14.37</span><span class="p">,</span><span class="mf">9.89</span><span class="p">,</span><span class="mf">7.72</span><span class="p">,</span><span class="mf">6.47</span><span class="p">,</span><span class="mf">5.67</span><span class="p">,</span><span class="mf">5.11</span><span class="p">,</span><span class="mf">4.71</span><span class="p">,</span><span class="mf">4.4</span><span class="p">,</span><span class="mf">4.16</span><span class="p">,</span><span class="mf">3.96</span><span class="p">,</span><span class="mf">3.8</span><span class="p">,</span><span class="mf">3.67</span><span class="p">,</span><span class="mf">3.55</span><span class="p">,</span><span class="mf">3.46</span><span class="p">,</span><span class="mf">3.37</span><span class="p">,</span><span class="mf">3.3</span><span class="p">,</span><span class="mf">3.23</span><span class="p">,</span><span class="mf">3.17</span><span class="p">,</span><span class="mf">3.12</span><span class="p">,</span><span class="mf">3.07</span><span class="p">,</span><span class="mf">3.03</span><span class="p">,</span><span class="mf">2.99</span><span class="p">,</span><span class="mf">2.96</span><span class="p">,</span><span class="mf">2.93</span><span class="p">,</span><span class="mf">2.9</span><span class="p">,</span><span class="mf">2.87</span><span class="p">,</span><span class="mf">2.84</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">2.34</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">15.0</span><span class="p">,</span><span class="mi">6157</span><span class="p">,</span><span class="mf">99.43</span><span class="p">,</span><span class="mf">26.87</span><span class="p">,</span><span class="mf">14.2</span><span class="p">,</span><span class="mf">9.72</span><span class="p">,</span><span class="mf">7.56</span><span class="p">,</span><span class="mf">6.31</span><span class="p">,</span><span class="mf">5.52</span><span class="p">,</span><span class="mf">4.96</span><span class="p">,</span><span class="mf">4.56</span><span class="p">,</span><span class="mf">4.25</span><span class="p">,</span><span class="mf">4.01</span><span class="p">,</span><span class="mf">3.82</span><span class="p">,</span><span class="mf">3.66</span><span class="p">,</span><span class="mf">3.52</span><span class="p">,</span><span class="mf">3.41</span><span class="p">,</span><span class="mf">3.31</span><span class="p">,</span><span class="mf">3.23</span><span class="p">,</span><span class="mf">3.15</span><span class="p">,</span><span class="mf">3.09</span><span class="p">,</span><span class="mf">3.03</span><span class="p">,</span><span class="mf">2.98</span><span class="p">,</span><span class="mf">2.93</span><span class="p">,</span><span class="mf">2.89</span><span class="p">,</span><span class="mf">2.85</span><span class="p">,</span><span class="mf">2.81</span><span class="p">,</span><span class="mf">2.78</span><span class="p">,</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">2.73</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.52</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.19</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span><span class="mi">6209</span><span class="p">,</span><span class="mf">99.45</span><span class="p">,</span><span class="mf">26.69</span><span class="p">,</span><span class="mf">14.02</span><span class="p">,</span><span class="mf">9.55</span><span class="p">,</span><span class="mf">7.4</span><span class="p">,</span><span class="mf">6.16</span><span class="p">,</span><span class="mf">5.36</span><span class="p">,</span><span class="mf">4.81</span><span class="p">,</span><span class="mf">4.41</span><span class="p">,</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">3.86</span><span class="p">,</span><span class="mf">3.66</span><span class="p">,</span><span class="mf">3.51</span><span class="p">,</span><span class="mf">3.37</span><span class="p">,</span><span class="mf">3.26</span><span class="p">,</span><span class="mf">3.16</span><span class="p">,</span><span class="mf">3.08</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.94</span><span class="p">,</span><span class="mf">2.88</span><span class="p">,</span><span class="mf">2.83</span><span class="p">,</span><span class="mf">2.78</span><span class="p">,</span><span class="mf">2.74</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.63</span><span class="p">,</span><span class="mf">2.6</span><span class="p">,</span><span class="mf">2.57</span><span class="p">,</span><span class="mf">2.55</span><span class="p">,</span><span class="mf">2.37</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.03</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span><span class="mi">6235</span><span class="p">,</span><span class="mf">99.46</span><span class="p">,</span><span class="mf">26.6</span><span class="p">,</span><span class="mf">13.93</span><span class="p">,</span><span class="mf">9.47</span><span class="p">,</span><span class="mf">7.31</span><span class="p">,</span><span class="mf">6.07</span><span class="p">,</span><span class="mf">5.28</span><span class="p">,</span><span class="mf">4.73</span><span class="p">,</span><span class="mf">4.33</span><span class="p">,</span><span class="mf">4.02</span><span class="p">,</span><span class="mf">3.78</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.43</span><span class="p">,</span><span class="mf">3.29</span><span class="p">,</span><span class="mf">3.18</span><span class="p">,</span><span class="mf">3.08</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.92</span><span class="p">,</span><span class="mf">2.86</span><span class="p">,</span><span class="mf">2.8</span><span class="p">,</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.62</span><span class="p">,</span><span class="mf">2.58</span><span class="p">,</span><span class="mf">2.55</span><span class="p">,</span><span class="mf">2.52</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.47</span><span class="p">,</span><span class="mf">2.29</span><span class="p">,</span><span class="mf">2.12</span><span class="p">,</span><span class="mf">1.95</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">30.0</span><span class="p">,</span><span class="mi">6261</span><span class="p">,</span><span class="mf">99.47</span><span class="p">,</span><span class="mf">26.5</span><span class="p">,</span><span class="mf">13.84</span><span class="p">,</span><span class="mf">9.38</span><span class="p">,</span><span class="mf">7.23</span><span class="p">,</span><span class="mf">5.99</span><span class="p">,</span><span class="mf">5.2</span><span class="p">,</span><span class="mf">4.65</span><span class="p">,</span><span class="mf">4.25</span><span class="p">,</span><span class="mf">3.94</span><span class="p">,</span><span class="mf">3.7</span><span class="p">,</span><span class="mf">3.51</span><span class="p">,</span><span class="mf">3.35</span><span class="p">,</span><span class="mf">3.21</span><span class="p">,</span><span class="mf">3.1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.92</span><span class="p">,</span><span class="mf">2.84</span><span class="p">,</span><span class="mf">2.78</span><span class="p">,</span><span class="mf">2.72</span><span class="p">,</span><span class="mf">2.67</span><span class="p">,</span><span class="mf">2.62</span><span class="p">,</span><span class="mf">2.58</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">2.47</span><span class="p">,</span><span class="mf">2.44</span><span class="p">,</span><span class="mf">2.41</span><span class="p">,</span><span class="mf">2.39</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.03</span><span class="p">,</span><span class="mf">1.86</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">40.0</span><span class="p">,</span><span class="mi">6287</span><span class="p">,</span><span class="mf">99.47</span><span class="p">,</span><span class="mf">26.41</span><span class="p">,</span><span class="mf">13.75</span><span class="p">,</span><span class="mf">9.29</span><span class="p">,</span><span class="mf">7.14</span><span class="p">,</span><span class="mf">5.91</span><span class="p">,</span><span class="mf">5.12</span><span class="p">,</span><span class="mf">4.57</span><span class="p">,</span><span class="mf">4.17</span><span class="p">,</span><span class="mf">3.86</span><span class="p">,</span><span class="mf">3.62</span><span class="p">,</span><span class="mf">3.43</span><span class="p">,</span><span class="mf">3.27</span><span class="p">,</span><span class="mf">3.13</span><span class="p">,</span><span class="mf">3.02</span><span class="p">,</span><span class="mf">2.92</span><span class="p">,</span><span class="mf">2.84</span><span class="p">,</span><span class="mf">2.76</span><span class="p">,</span><span class="mf">2.69</span><span class="p">,</span><span class="mf">2.64</span><span class="p">,</span><span class="mf">2.58</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.38</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.33</span><span class="p">,</span><span class="mf">2.3</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">1.94</span><span class="p">,</span><span class="mf">1.76</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">60.0</span><span class="p">,</span><span class="mi">6313</span><span class="p">,</span><span class="mf">99.48</span><span class="p">,</span><span class="mf">26.32</span><span class="p">,</span><span class="mf">13.65</span><span class="p">,</span><span class="mf">9.2</span><span class="p">,</span><span class="mf">7.06</span><span class="p">,</span><span class="mf">5.82</span><span class="p">,</span><span class="mf">5.03</span><span class="p">,</span><span class="mf">4.48</span><span class="p">,</span><span class="mf">4.08</span><span class="p">,</span><span class="mf">3.78</span><span class="p">,</span><span class="mf">3.54</span><span class="p">,</span><span class="mf">3.34</span><span class="p">,</span><span class="mf">3.18</span><span class="p">,</span><span class="mf">3.05</span><span class="p">,</span><span class="mf">2.93</span><span class="p">,</span><span class="mf">2.83</span><span class="p">,</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">2.67</span><span class="p">,</span><span class="mf">2.61</span><span class="p">,</span><span class="mf">2.55</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.4</span><span class="p">,</span><span class="mf">2.36</span><span class="p">,</span><span class="mf">2.33</span><span class="p">,</span><span class="mf">2.29</span><span class="p">,</span><span class="mf">2.26</span><span class="p">,</span><span class="mf">2.23</span><span class="p">,</span><span class="mf">2.21</span><span class="p">,</span><span class="mf">2.02</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.66</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">120.0</span><span class="p">,</span><span class="mi">6339</span><span class="p">,</span><span class="mf">99.49</span><span class="p">,</span><span class="mf">26.22</span><span class="p">,</span><span class="mf">13.56</span><span class="p">,</span><span class="mf">9.11</span><span class="p">,</span><span class="mf">6.97</span><span class="p">,</span><span class="mf">5.74</span><span class="p">,</span><span class="mf">4.95</span><span class="p">,</span><span class="mf">4.4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">3.69</span><span class="p">,</span><span class="mf">3.45</span><span class="p">,</span><span class="mf">3.25</span><span class="p">,</span><span class="mf">3.09</span><span class="p">,</span><span class="mf">2.96</span><span class="p">,</span><span class="mf">2.84</span><span class="p">,</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.58</span><span class="p">,</span><span class="mf">2.52</span><span class="p">,</span><span class="mf">2.46</span><span class="p">,</span><span class="mf">2.4</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.31</span><span class="p">,</span><span class="mf">2.27</span><span class="p">,</span><span class="mf">2.23</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.17</span><span class="p">,</span><span class="mf">2.14</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">1.92</span><span class="p">,</span><span class="mf">1.73</span><span class="p">,</span><span class="mf">1.53</span><span class="p">]])</span>
    <span class="c1"># F-statistic where v2=infinity</span>
    <span class="n">tab2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
             <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">6.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">9.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">12.0</span><span class="p">,</span><span class="mf">15.0</span><span class="p">,</span><span class="mf">20.0</span><span class="p">,</span><span class="mf">24.0</span><span class="p">,</span><span class="mf">30.0</span><span class="p">,</span><span class="mf">40.0</span><span class="p">,</span><span class="mf">60.0</span><span class="p">,</span><span class="mf">120.0</span><span class="p">],</span>
             <span class="p">[</span> <span class="mf">6.63</span> <span class="p">,</span><span class="mf">4.61</span> <span class="p">,</span><span class="mf">3.78</span> <span class="p">,</span><span class="mf">3.32</span> <span class="p">,</span><span class="mf">3.02</span> <span class="p">,</span><span class="mf">2.80</span> <span class="p">,</span><span class="mf">2.64</span> <span class="p">,</span><span class="mf">2.51</span> <span class="p">,</span><span class="mf">2.41</span> <span class="p">,</span><span class="mf">2.32</span> <span class="p">,</span><span class="mf">2.18</span> <span class="p">,</span><span class="mf">2.04</span> <span class="p">,</span><span class="mf">1.88</span> <span class="p">,</span><span class="mf">1.79</span><span class="p">,</span> <span class="mf">1.70</span><span class="p">,</span> <span class="mf">1.59</span><span class="p">,</span> <span class="mf">1.47</span><span class="p">,</span> <span class="mf">1.32</span><span class="p">]])</span>
    <span class="n">tab2</span><span class="o">=</span><span class="n">tab2</span><span class="o">.</span><span class="n">T</span>
    <span class="n">tab3</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">13.0</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">21.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">23.0</span><span class="p">,</span> <span class="mf">24.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">26.0</span><span class="p">,</span> <span class="mf">27.0</span><span class="p">,</span> <span class="mf">28.0</span><span class="p">,</span> <span class="mf">29.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">],</span>
             <span class="p">[</span><span class="mi">6366</span><span class="p">,</span> <span class="mf">99.50</span><span class="p">,</span> <span class="mf">26.13</span><span class="p">,</span> <span class="mf">13.46</span><span class="p">,</span> <span class="mf">9.02</span><span class="p">,</span> <span class="mf">6.88</span><span class="p">,</span> <span class="mf">5.65</span><span class="p">,</span> <span class="mf">4.86</span><span class="p">,</span> <span class="mf">4.31</span><span class="p">,</span> <span class="mf">3.91</span><span class="p">,</span> <span class="mf">3.60</span><span class="p">,</span> <span class="mf">3.36</span><span class="p">,</span> <span class="mf">3.17</span><span class="p">,</span> <span class="mf">3.00</span><span class="p">,</span> <span class="mf">2.87</span><span class="p">,</span> <span class="mf">2.75</span><span class="p">,</span> <span class="mf">2.65</span><span class="p">,</span> <span class="mf">2.57</span><span class="p">,</span> <span class="mf">2.49</span><span class="p">,</span> <span class="mf">2.42</span><span class="p">,</span> <span class="mf">2.36</span><span class="p">,</span> <span class="mf">2.31</span><span class="p">,</span> <span class="mf">2.26</span><span class="p">,</span> <span class="mf">2.21</span><span class="p">,</span> <span class="mf">2.17</span><span class="p">,</span> <span class="mf">2.13</span><span class="p">,</span> <span class="mf">2.10</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">,</span> <span class="mf">2.03</span><span class="p">,</span> <span class="mf">2.01</span><span class="p">,</span> <span class="mf">1.80</span><span class="p">,</span> <span class="mf">1.60</span><span class="p">,</span> <span class="mf">1.38</span><span class="p">]])</span>
    <span class="n">tab3</span><span class="o">=</span><span class="n">tab3</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">if</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">Y</span><span class="o">=</span><span class="n">tab1</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X</span><span class="o">=</span><span class="n">tab1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">Z</span><span class="o">=</span><span class="n">tab1</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]</span>
       <span class="c1"># f = interpolate.interp2d(X, Y, Z, kind=&#39;cubic&#39;)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">f99_</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">f99_</span><span class="o">=</span><span class="n">f99_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">f99_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">tab3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">tab3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">f99_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">tab2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">tab2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">f99_</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">f99_</span></div>


<div class="viewcode-block" id="f95">
<a class="viewcode-back" href="../pyphi.html#pyphi.f95">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">f95</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
    <span class="n">tab1</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">6.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">9.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">11.0</span><span class="p">,</span><span class="mf">12.0</span><span class="p">,</span><span class="mf">13.0</span><span class="p">,</span><span class="mf">14.0</span><span class="p">,</span><span class="mf">15.0</span><span class="p">,</span><span class="mf">16.0</span><span class="p">,</span><span class="mf">17.0</span><span class="p">,</span><span class="mf">18.0</span><span class="p">,</span><span class="mf">19.0</span><span class="p">,</span><span class="mf">20.0</span><span class="p">,</span><span class="mf">21.0</span><span class="p">,</span><span class="mf">22.0</span><span class="p">,</span><span class="mf">23.0</span><span class="p">,</span><span class="mf">24.0</span><span class="p">,</span><span class="mf">25.0</span><span class="p">,</span><span class="mf">26.0</span><span class="p">,</span><span class="mf">27.0</span><span class="p">,</span><span class="mf">28.0</span><span class="p">,</span><span class="mf">29.0</span><span class="p">,</span><span class="mf">30.0</span><span class="p">,</span><span class="mf">40.0</span><span class="p">,</span><span class="mf">60.0</span><span class="p">,</span><span class="mf">120.0</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">161.4</span><span class="p">,</span><span class="mf">18.51</span><span class="p">,</span><span class="mf">10.13</span><span class="p">,</span><span class="mf">7.71</span><span class="p">,</span><span class="mf">6.61</span><span class="p">,</span><span class="mf">5.99</span><span class="p">,</span><span class="mf">5.59</span><span class="p">,</span><span class="mf">5.32</span><span class="p">,</span><span class="mf">5.12</span><span class="p">,</span><span class="mf">4.96</span><span class="p">,</span><span class="mf">4.84</span><span class="p">,</span><span class="mf">4.75</span><span class="p">,</span><span class="mf">4.67</span><span class="p">,</span><span class="mf">4.6</span><span class="p">,</span><span class="mf">4.54</span><span class="p">,</span><span class="mf">4.49</span><span class="p">,</span><span class="mf">4.45</span><span class="p">,</span><span class="mf">4.41</span><span class="p">,</span><span class="mf">4.38</span><span class="p">,</span><span class="mf">4.35</span><span class="p">,</span><span class="mf">4.32</span><span class="p">,</span><span class="mf">4.3</span><span class="p">,</span><span class="mf">4.28</span><span class="p">,</span><span class="mf">4.26</span><span class="p">,</span><span class="mf">4.24</span><span class="p">,</span><span class="mf">4.23</span><span class="p">,</span><span class="mf">4.21</span><span class="p">,</span><span class="mf">4.2</span><span class="p">,</span><span class="mf">4.18</span><span class="p">,</span><span class="mf">4.17</span><span class="p">,</span><span class="mf">4.08</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">3.92</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">199.5</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mf">9.55</span><span class="p">,</span><span class="mf">6.94</span><span class="p">,</span><span class="mf">5.79</span><span class="p">,</span><span class="mf">5.14</span><span class="p">,</span><span class="mf">4.74</span><span class="p">,</span><span class="mf">4.46</span><span class="p">,</span><span class="mf">4.26</span><span class="p">,</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">3.98</span><span class="p">,</span><span class="mf">3.89</span><span class="p">,</span><span class="mf">3.81</span><span class="p">,</span><span class="mf">3.74</span><span class="p">,</span><span class="mf">3.68</span><span class="p">,</span><span class="mf">3.63</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.55</span><span class="p">,</span><span class="mf">3.52</span><span class="p">,</span><span class="mf">3.49</span><span class="p">,</span><span class="mf">3.47</span><span class="p">,</span><span class="mf">3.44</span><span class="p">,</span><span class="mf">3.42</span><span class="p">,</span><span class="mf">3.4</span><span class="p">,</span><span class="mf">3.39</span><span class="p">,</span><span class="mf">3.37</span><span class="p">,</span><span class="mf">3.35</span><span class="p">,</span><span class="mf">3.34</span><span class="p">,</span><span class="mf">3.33</span><span class="p">,</span><span class="mf">3.32</span><span class="p">,</span><span class="mf">3.23</span><span class="p">,</span><span class="mf">3.15</span><span class="p">,</span><span class="mf">3.07</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">215.7</span><span class="p">,</span><span class="mf">19.16</span><span class="p">,</span><span class="mf">9.28</span><span class="p">,</span><span class="mf">6.59</span><span class="p">,</span><span class="mf">5.41</span><span class="p">,</span><span class="mf">4.76</span><span class="p">,</span><span class="mf">4.35</span><span class="p">,</span><span class="mf">4.07</span><span class="p">,</span><span class="mf">3.86</span><span class="p">,</span><span class="mf">3.71</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.49</span><span class="p">,</span><span class="mf">3.41</span><span class="p">,</span><span class="mf">3.34</span><span class="p">,</span><span class="mf">3.29</span><span class="p">,</span><span class="mf">3.24</span><span class="p">,</span><span class="mf">3.2</span><span class="p">,</span><span class="mf">3.16</span><span class="p">,</span><span class="mf">3.13</span><span class="p">,</span><span class="mf">3.1</span><span class="p">,</span><span class="mf">3.07</span><span class="p">,</span><span class="mf">3.05</span><span class="p">,</span><span class="mf">3.03</span><span class="p">,</span><span class="mf">3.01</span><span class="p">,</span><span class="mf">2.99</span><span class="p">,</span><span class="mf">2.98</span><span class="p">,</span><span class="mf">2.96</span><span class="p">,</span><span class="mf">2.95</span><span class="p">,</span><span class="mf">2.93</span><span class="p">,</span><span class="mf">2.92</span><span class="p">,</span><span class="mf">2.84</span><span class="p">,</span><span class="mf">2.76</span><span class="p">,</span><span class="mf">2.68</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">224.6</span><span class="p">,</span><span class="mf">19.25</span><span class="p">,</span><span class="mf">9.12</span><span class="p">,</span><span class="mf">6.39</span><span class="p">,</span><span class="mf">5.19</span><span class="p">,</span><span class="mf">4.53</span><span class="p">,</span><span class="mf">4.12</span><span class="p">,</span><span class="mf">3.84</span><span class="p">,</span><span class="mf">3.63</span><span class="p">,</span><span class="mf">3.48</span><span class="p">,</span><span class="mf">3.36</span><span class="p">,</span><span class="mf">3.26</span><span class="p">,</span><span class="mf">3.18</span><span class="p">,</span><span class="mf">3.11</span><span class="p">,</span><span class="mf">3.06</span><span class="p">,</span><span class="mf">3.01</span><span class="p">,</span><span class="mf">2.96</span><span class="p">,</span><span class="mf">2.93</span><span class="p">,</span><span class="mf">2.9</span><span class="p">,</span><span class="mf">2.87</span><span class="p">,</span><span class="mf">2.84</span><span class="p">,</span><span class="mf">2.82</span><span class="p">,</span><span class="mf">2.8</span><span class="p">,</span><span class="mf">2.78</span><span class="p">,</span><span class="mf">2.76</span><span class="p">,</span><span class="mf">2.74</span><span class="p">,</span><span class="mf">2.73</span><span class="p">,</span><span class="mf">2.71</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.69</span><span class="p">,</span><span class="mf">2.61</span><span class="p">,</span><span class="mf">2.53</span><span class="p">,</span><span class="mf">2.45</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">230.2</span><span class="p">,</span><span class="mf">19.3</span><span class="p">,</span><span class="mf">9.01</span><span class="p">,</span><span class="mf">6.26</span><span class="p">,</span><span class="mf">5.05</span><span class="p">,</span><span class="mf">4.39</span><span class="p">,</span><span class="mf">3.97</span><span class="p">,</span><span class="mf">3.69</span><span class="p">,</span><span class="mf">3.48</span><span class="p">,</span><span class="mf">3.33</span><span class="p">,</span><span class="mf">3.2</span><span class="p">,</span><span class="mf">3.11</span><span class="p">,</span><span class="mf">3.03</span><span class="p">,</span><span class="mf">2.96</span><span class="p">,</span><span class="mf">2.9</span><span class="p">,</span><span class="mf">2.85</span><span class="p">,</span><span class="mf">2.81</span><span class="p">,</span><span class="mf">2.77</span><span class="p">,</span><span class="mf">2.74</span><span class="p">,</span><span class="mf">2.71</span><span class="p">,</span><span class="mf">2.68</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.64</span><span class="p">,</span><span class="mf">2.62</span><span class="p">,</span><span class="mf">2.6</span><span class="p">,</span><span class="mf">2.59</span><span class="p">,</span><span class="mf">2.57</span><span class="p">,</span><span class="mf">2.56</span><span class="p">,</span><span class="mf">2.55</span><span class="p">,</span><span class="mf">2.53</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.37</span><span class="p">,</span><span class="mf">2.29</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span><span class="mi">234</span><span class="p">,</span><span class="mf">19.33</span><span class="p">,</span><span class="mf">8.94</span><span class="p">,</span><span class="mf">6.16</span><span class="p">,</span><span class="mf">4.95</span><span class="p">,</span><span class="mf">4.28</span><span class="p">,</span><span class="mf">3.87</span><span class="p">,</span><span class="mf">3.58</span><span class="p">,</span><span class="mf">3.37</span><span class="p">,</span><span class="mf">3.22</span><span class="p">,</span><span class="mf">3.09</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.92</span><span class="p">,</span><span class="mf">2.85</span><span class="p">,</span><span class="mf">2.79</span><span class="p">,</span><span class="mf">2.74</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.63</span><span class="p">,</span><span class="mf">2.6</span><span class="p">,</span><span class="mf">2.57</span><span class="p">,</span><span class="mf">2.55</span><span class="p">,</span><span class="mf">2.53</span><span class="p">,</span><span class="mf">2.51</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.47</span><span class="p">,</span><span class="mf">2.46</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.43</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.34</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.17</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">7.0</span><span class="p">,</span><span class="mf">236.8</span><span class="p">,</span><span class="mf">19.35</span><span class="p">,</span><span class="mf">8.89</span><span class="p">,</span><span class="mf">6.09</span><span class="p">,</span><span class="mf">4.88</span><span class="p">,</span><span class="mf">4.21</span><span class="p">,</span><span class="mf">3.79</span><span class="p">,</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">3.29</span><span class="p">,</span><span class="mf">3.14</span><span class="p">,</span><span class="mf">3.01</span><span class="p">,</span><span class="mf">2.91</span><span class="p">,</span><span class="mf">2.83</span><span class="p">,</span><span class="mf">2.76</span><span class="p">,</span><span class="mf">2.71</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.61</span><span class="p">,</span><span class="mf">2.58</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.51</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.46</span><span class="p">,</span><span class="mf">2.44</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.4</span><span class="p">,</span><span class="mf">2.39</span><span class="p">,</span><span class="mf">2.37</span><span class="p">,</span><span class="mf">2.36</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.33</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.17</span><span class="p">,</span><span class="mf">2.09</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span><span class="mf">238.9</span><span class="p">,</span><span class="mf">19.37</span><span class="p">,</span><span class="mf">8.85</span><span class="p">,</span><span class="mf">6.04</span><span class="p">,</span><span class="mf">4.82</span><span class="p">,</span><span class="mf">4.15</span><span class="p">,</span><span class="mf">3.73</span><span class="p">,</span><span class="mf">3.44</span><span class="p">,</span><span class="mf">3.23</span><span class="p">,</span><span class="mf">3.07</span><span class="p">,</span><span class="mf">2.95</span><span class="p">,</span><span class="mf">2.85</span><span class="p">,</span><span class="mf">2.77</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.64</span><span class="p">,</span><span class="mf">2.59</span><span class="p">,</span><span class="mf">2.55</span><span class="p">,</span><span class="mf">2.51</span><span class="p">,</span><span class="mf">2.48</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.4</span><span class="p">,</span><span class="mf">2.37</span><span class="p">,</span><span class="mf">2.36</span><span class="p">,</span><span class="mf">2.34</span><span class="p">,</span><span class="mf">2.32</span><span class="p">,</span><span class="mf">2.31</span><span class="p">,</span><span class="mf">2.29</span><span class="p">,</span><span class="mf">2.28</span><span class="p">,</span><span class="mf">2.27</span><span class="p">,</span><span class="mf">2.18</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="mf">2.02</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">9.0</span><span class="p">,</span><span class="mf">240.5</span><span class="p">,</span><span class="mf">19.38</span><span class="p">,</span><span class="mf">8.81</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mf">4.77</span><span class="p">,</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">3.68</span><span class="p">,</span><span class="mf">3.39</span><span class="p">,</span><span class="mf">3.18</span><span class="p">,</span><span class="mf">3.02</span><span class="p">,</span><span class="mf">2.9</span><span class="p">,</span><span class="mf">2.8</span><span class="p">,</span><span class="mf">2.71</span><span class="p">,</span><span class="mf">2.65</span><span class="p">,</span><span class="mf">2.59</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.46</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.39</span><span class="p">,</span><span class="mf">2.37</span><span class="p">,</span><span class="mf">2.34</span><span class="p">,</span><span class="mf">2.32</span><span class="p">,</span><span class="mf">2.3</span><span class="p">,</span><span class="mf">2.28</span><span class="p">,</span><span class="mf">2.27</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.24</span><span class="p">,</span><span class="mf">2.22</span><span class="p">,</span><span class="mf">2.21</span><span class="p">,</span><span class="mf">2.12</span><span class="p">,</span><span class="mf">2.04</span><span class="p">,</span><span class="mf">1.96</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">241.9</span><span class="p">,</span><span class="mf">19.4</span><span class="p">,</span><span class="mf">8.79</span><span class="p">,</span><span class="mf">5.96</span><span class="p">,</span><span class="mf">4.74</span><span class="p">,</span><span class="mf">4.06</span><span class="p">,</span><span class="mf">3.64</span><span class="p">,</span><span class="mf">3.35</span><span class="p">,</span><span class="mf">3.14</span><span class="p">,</span><span class="mf">2.98</span><span class="p">,</span><span class="mf">2.85</span><span class="p">,</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">2.67</span><span class="p">,</span><span class="mf">2.6</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.41</span><span class="p">,</span><span class="mf">2.38</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.32</span><span class="p">,</span><span class="mf">2.3</span><span class="p">,</span><span class="mf">2.27</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.24</span><span class="p">,</span><span class="mf">2.22</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.19</span><span class="p">,</span><span class="mf">2.18</span><span class="p">,</span><span class="mf">2.16</span><span class="p">,</span><span class="mf">2.08</span><span class="p">,</span><span class="mf">1.99</span><span class="p">,</span><span class="mf">1.91</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">12.0</span><span class="p">,</span><span class="mf">243.9</span><span class="p">,</span><span class="mf">19.41</span><span class="p">,</span><span class="mf">8.74</span><span class="p">,</span><span class="mf">5.91</span><span class="p">,</span><span class="mf">4.68</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">3.57</span><span class="p">,</span><span class="mf">3.28</span><span class="p">,</span><span class="mf">3.07</span><span class="p">,</span><span class="mf">2.91</span><span class="p">,</span><span class="mf">2.79</span><span class="p">,</span><span class="mf">2.69</span><span class="p">,</span><span class="mf">2.6</span><span class="p">,</span><span class="mf">2.53</span><span class="p">,</span><span class="mf">2.48</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.38</span><span class="p">,</span><span class="mf">2.34</span><span class="p">,</span><span class="mf">2.31</span><span class="p">,</span><span class="mf">2.28</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.23</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.18</span><span class="p">,</span><span class="mf">2.16</span><span class="p">,</span><span class="mf">2.15</span><span class="p">,</span><span class="mf">2.13</span><span class="p">,</span><span class="mf">2.12</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="mf">2.09</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">1.92</span><span class="p">,</span><span class="mf">1.83</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">15.0</span><span class="p">,</span><span class="mf">245.9</span><span class="p">,</span><span class="mf">19.43</span><span class="p">,</span><span class="mf">8.7</span><span class="p">,</span><span class="mf">5.86</span><span class="p">,</span><span class="mf">4.62</span><span class="p">,</span><span class="mf">3.94</span><span class="p">,</span><span class="mf">3.51</span><span class="p">,</span><span class="mf">3.22</span><span class="p">,</span><span class="mf">3.01</span><span class="p">,</span><span class="mf">2.85</span><span class="p">,</span><span class="mf">2.72</span><span class="p">,</span><span class="mf">2.62</span><span class="p">,</span><span class="mf">2.53</span><span class="p">,</span><span class="mf">2.46</span><span class="p">,</span><span class="mf">2.4</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.31</span><span class="p">,</span><span class="mf">2.27</span><span class="p">,</span><span class="mf">2.23</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.18</span><span class="p">,</span><span class="mf">2.15</span><span class="p">,</span><span class="mf">2.13</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">2.09</span><span class="p">,</span><span class="mf">2.07</span><span class="p">,</span><span class="mf">2.06</span><span class="p">,</span><span class="mf">2.04</span><span class="p">,</span><span class="mf">2.03</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.92</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span><span class="mi">248</span><span class="p">,</span><span class="mf">19.45</span><span class="p">,</span><span class="mf">8.66</span><span class="p">,</span><span class="mf">5.8</span><span class="p">,</span><span class="mf">4.56</span><span class="p">,</span><span class="mf">3.87</span><span class="p">,</span><span class="mf">3.44</span><span class="p">,</span><span class="mf">3.15</span><span class="p">,</span><span class="mf">2.94</span><span class="p">,</span><span class="mf">2.77</span><span class="p">,</span><span class="mf">2.65</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.46</span><span class="p">,</span><span class="mf">2.39</span><span class="p">,</span><span class="mf">2.33</span><span class="p">,</span><span class="mf">2.28</span><span class="p">,</span><span class="mf">2.23</span><span class="p">,</span><span class="mf">2.19</span><span class="p">,</span><span class="mf">2.16</span><span class="p">,</span><span class="mf">2.12</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="mf">2.07</span><span class="p">,</span><span class="mf">2.05</span><span class="p">,</span><span class="mf">2.03</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.99</span><span class="p">,</span><span class="mf">1.97</span><span class="p">,</span><span class="mf">1.96</span><span class="p">,</span><span class="mf">1.94</span><span class="p">,</span><span class="mf">1.93</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.66</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span><span class="mf">249.1</span><span class="p">,</span><span class="mf">19.45</span><span class="p">,</span><span class="mf">8.64</span><span class="p">,</span><span class="mf">5.77</span><span class="p">,</span><span class="mf">4.53</span><span class="p">,</span><span class="mf">3.84</span><span class="p">,</span><span class="mf">3.41</span><span class="p">,</span><span class="mf">3.12</span><span class="p">,</span><span class="mf">2.9</span><span class="p">,</span><span class="mf">2.74</span><span class="p">,</span><span class="mf">2.61</span><span class="p">,</span><span class="mf">2.51</span><span class="p">,</span><span class="mf">2.42</span><span class="p">,</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">2.29</span><span class="p">,</span><span class="mf">2.24</span><span class="p">,</span><span class="mf">2.19</span><span class="p">,</span><span class="mf">2.15</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">2.08</span><span class="p">,</span><span class="mf">2.05</span><span class="p">,</span><span class="mf">2.03</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.98</span><span class="p">,</span><span class="mf">1.96</span><span class="p">,</span><span class="mf">1.95</span><span class="p">,</span><span class="mf">1.93</span><span class="p">,</span><span class="mf">1.91</span><span class="p">,</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">1.89</span><span class="p">,</span><span class="mf">1.79</span><span class="p">,</span><span class="mf">1.7</span><span class="p">,</span><span class="mf">1.61</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">30.0</span><span class="p">,</span><span class="mf">250.1</span><span class="p">,</span><span class="mf">19.46</span><span class="p">,</span><span class="mf">8.62</span><span class="p">,</span><span class="mf">5.75</span><span class="p">,</span><span class="mf">4.5</span><span class="p">,</span><span class="mf">3.81</span><span class="p">,</span><span class="mf">3.38</span><span class="p">,</span><span class="mf">3.08</span><span class="p">,</span><span class="mf">2.86</span><span class="p">,</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">2.57</span><span class="p">,</span><span class="mf">2.47</span><span class="p">,</span><span class="mf">2.38</span><span class="p">,</span><span class="mf">2.31</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.19</span><span class="p">,</span><span class="mf">2.15</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">2.07</span><span class="p">,</span><span class="mf">2.04</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.98</span><span class="p">,</span><span class="mf">1.96</span><span class="p">,</span><span class="mf">1.94</span><span class="p">,</span><span class="mf">1.92</span><span class="p">,</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">1.88</span><span class="p">,</span><span class="mf">1.87</span><span class="p">,</span><span class="mf">1.85</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.74</span><span class="p">,</span><span class="mf">1.65</span><span class="p">,</span><span class="mf">1.55</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">40.0</span><span class="p">,</span><span class="mf">251.1</span><span class="p">,</span><span class="mf">19.47</span><span class="p">,</span><span class="mf">8.59</span><span class="p">,</span><span class="mf">5.72</span><span class="p">,</span><span class="mf">4.46</span><span class="p">,</span><span class="mf">3.77</span><span class="p">,</span><span class="mf">3.34</span><span class="p">,</span><span class="mf">3.04</span><span class="p">,</span><span class="mf">2.83</span><span class="p">,</span><span class="mf">2.66</span><span class="p">,</span><span class="mf">2.53</span><span class="p">,</span><span class="mf">2.43</span><span class="p">,</span><span class="mf">2.34</span><span class="p">,</span><span class="mf">2.27</span><span class="p">,</span><span class="mf">2.2</span><span class="p">,</span><span class="mf">2.15</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="mf">2.06</span><span class="p">,</span><span class="mf">2.03</span><span class="p">,</span><span class="mf">1.99</span><span class="p">,</span><span class="mf">1.96</span><span class="p">,</span><span class="mf">1.94</span><span class="p">,</span><span class="mf">1.91</span><span class="p">,</span><span class="mf">1.89</span><span class="p">,</span><span class="mf">1.87</span><span class="p">,</span><span class="mf">1.85</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.82</span><span class="p">,</span><span class="mf">1.81</span><span class="p">,</span><span class="mf">1.79</span><span class="p">,</span><span class="mf">1.69</span><span class="p">,</span><span class="mf">1.59</span><span class="p">,</span><span class="mf">1.5</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">60.0</span><span class="p">,</span><span class="mf">252.2</span><span class="p">,</span><span class="mf">19.48</span><span class="p">,</span><span class="mf">8.57</span><span class="p">,</span><span class="mf">5.69</span><span class="p">,</span><span class="mf">4.43</span><span class="p">,</span><span class="mf">3.74</span><span class="p">,</span><span class="mf">3.3</span><span class="p">,</span><span class="mf">3.01</span><span class="p">,</span><span class="mf">2.79</span><span class="p">,</span><span class="mf">2.62</span><span class="p">,</span><span class="mf">2.49</span><span class="p">,</span><span class="mf">2.38</span><span class="p">,</span><span class="mf">2.3</span><span class="p">,</span><span class="mf">2.22</span><span class="p">,</span><span class="mf">2.16</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">2.06</span><span class="p">,</span><span class="mf">2.02</span><span class="p">,</span><span class="mf">1.98</span><span class="p">,</span><span class="mf">1.95</span><span class="p">,</span><span class="mf">1.92</span><span class="p">,</span><span class="mf">1.89</span><span class="p">,</span><span class="mf">1.86</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.82</span><span class="p">,</span><span class="mf">1.8</span><span class="p">,</span><span class="mf">1.79</span><span class="p">,</span><span class="mf">1.77</span><span class="p">,</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.74</span><span class="p">,</span><span class="mf">1.64</span><span class="p">,</span><span class="mf">1.53</span><span class="p">,</span><span class="mf">1.43</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">120.0</span><span class="p">,</span><span class="mf">253.3</span><span class="p">,</span><span class="mf">19.49</span><span class="p">,</span><span class="mf">8.55</span><span class="p">,</span><span class="mf">5.66</span><span class="p">,</span><span class="mf">4.4</span><span class="p">,</span><span class="mf">3.7</span><span class="p">,</span><span class="mf">3.27</span><span class="p">,</span><span class="mf">2.97</span><span class="p">,</span><span class="mf">2.75</span><span class="p">,</span><span class="mf">2.58</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.34</span><span class="p">,</span><span class="mf">2.25</span><span class="p">,</span><span class="mf">2.18</span><span class="p">,</span><span class="mf">2.11</span><span class="p">,</span><span class="mf">2.06</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.97</span><span class="p">,</span><span class="mf">1.93</span><span class="p">,</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">1.87</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.81</span><span class="p">,</span><span class="mf">1.79</span><span class="p">,</span><span class="mf">1.77</span><span class="p">,</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.73</span><span class="p">,</span><span class="mf">1.71</span><span class="p">,</span><span class="mf">1.7</span><span class="p">,</span><span class="mf">1.68</span><span class="p">,</span><span class="mf">1.58</span><span class="p">,</span><span class="mf">1.47</span><span class="p">,</span><span class="mf">1.35</span><span class="p">]])</span>
    <span class="n">tab2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">24.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">3.84</span><span class="p">,</span> <span class="mf">3.00</span><span class="p">,</span> <span class="mf">2.60</span><span class="p">,</span> <span class="mf">2.37</span><span class="p">,</span> <span class="mf">2.21</span><span class="p">,</span> <span class="mf">2.10</span><span class="p">,</span> <span class="mf">2.01</span><span class="p">,</span> <span class="mf">1.94</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">,</span> <span class="mf">1.83</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">1.67</span><span class="p">,</span> <span class="mf">1.57</span><span class="p">,</span> <span class="mf">1.52</span><span class="p">,</span> <span class="mf">1.46</span><span class="p">,</span> <span class="mf">1.39</span><span class="p">,</span> <span class="mf">1.32</span><span class="p">,</span> <span class="mf">1.22</span><span class="p">]])</span>
    <span class="n">tab2</span><span class="o">=</span><span class="n">tab2</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">tab3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">13.0</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">,</span> <span class="mf">17.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">19.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">21.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">23.0</span><span class="p">,</span> <span class="mf">24.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">26.0</span><span class="p">,</span> <span class="mf">27.0</span><span class="p">,</span> <span class="mf">28.0</span><span class="p">,</span> <span class="mf">29.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">40.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">245.3</span><span class="p">,</span> <span class="mf">19.50</span><span class="p">,</span> <span class="mf">8.53</span> <span class="p">,</span><span class="mf">5.63</span><span class="p">,</span> <span class="mf">4.36</span><span class="p">,</span> <span class="mf">3.67</span><span class="p">,</span> <span class="mf">3.23</span><span class="p">,</span> <span class="mf">2.93</span><span class="p">,</span> <span class="mf">2.71</span><span class="p">,</span> <span class="mf">2.54</span><span class="p">,</span> <span class="mf">2.40</span><span class="p">,</span> <span class="mf">2.30</span><span class="p">,</span> <span class="mf">2.21</span><span class="p">,</span> <span class="mf">2.13</span><span class="p">,</span> <span class="mf">2.07</span><span class="p">,</span> <span class="mf">2.01</span><span class="p">,</span> <span class="mf">1.96</span><span class="p">,</span> <span class="mf">1.92</span><span class="p">,</span> <span class="mf">1.88</span><span class="p">,</span> <span class="mf">1.84</span><span class="p">,</span> <span class="mf">1.81</span><span class="p">,</span> <span class="mf">1.78</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">,</span> <span class="mf">1.73</span><span class="p">,</span> <span class="mf">1.71</span><span class="p">,</span> <span class="mf">1.69</span><span class="p">,</span> <span class="mf">1.67</span><span class="p">,</span> <span class="mf">1.65</span><span class="p">,</span> <span class="mf">1.64</span><span class="p">,</span> <span class="mf">1.62</span><span class="p">,</span> <span class="mf">1.51</span><span class="p">,</span> <span class="mf">1.39</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">]])</span>
    <span class="n">tab3</span><span class="o">=</span><span class="n">tab3</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">Y</span><span class="o">=</span><span class="n">tab1</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">X</span><span class="o">=</span><span class="n">tab1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">Z</span><span class="o">=</span><span class="n">tab1</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]</span>
       <span class="c1"># f = interpolate.interp2d(X, Y, Z, kind=&#39;cubic&#39;)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">f95_</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">f95_</span><span class="o">=</span><span class="n">f95_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">f95_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">tab3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">tab3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">f95_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">tab2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">tab2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">120</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">120</span><span class="p">:</span>
        <span class="n">f95_</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">f95_</span></div>

    

<div class="viewcode-block" id="scores_conf_int_calc">
<a class="viewcode-back" href="../pyphi.html#pyphi.scores_conf_int_calc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scores_conf_int_calc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
    <span class="n">n_points</span><span class="o">=</span><span class="mi">100</span>
    <span class="n">cte2</span><span class="o">=</span><span class="p">((</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">f95_</span><span class="o">=</span><span class="n">cte2</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">f99_</span><span class="o">=</span><span class="n">cte2</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xd95</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f95_</span><span class="o">*</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xd99</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f99_</span><span class="o">*</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xd95</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">xd95</span><span class="p">,</span><span class="n">xd95</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">n_points</span><span class="p">)</span>
    <span class="n">xd99</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">xd99</span><span class="p">,</span><span class="n">xd99</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">n_points</span><span class="p">)</span>
    
    <span class="n">st</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="n">s11</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s22</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s12</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s21</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s22</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span>
    <span class="n">b</span><span class="o">=</span><span class="n">xd95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s12</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span><span class="o">+</span><span class="n">xd95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s21</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span>
    <span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="n">xd95</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s11</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span><span class="o">-</span><span class="n">f95_</span>
    <span class="n">safe_chk</span><span class="o">=</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span>
    <span class="n">safe_chk</span><span class="p">[</span><span class="n">safe_chk</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">yd95p</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">safe_chk</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="n">yd95n</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">safe_chk</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    
    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s22</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span>
    <span class="n">b</span><span class="o">=</span><span class="n">xd99</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s12</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span><span class="o">+</span><span class="n">xd99</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s21</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span>
    <span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="n">xd99</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">s11</span><span class="p">,</span><span class="n">n_points</span><span class="p">)</span><span class="o">-</span><span class="n">f99_</span>
    <span class="n">safe_chk</span><span class="o">=</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span>
    <span class="n">safe_chk</span><span class="p">[</span><span class="n">safe_chk</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">yd99p</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">safe_chk</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="n">yd99n</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">safe_chk</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">xd95</span><span class="p">,</span><span class="n">xd99</span><span class="p">,</span><span class="n">yd95p</span><span class="p">,</span><span class="n">yd95n</span><span class="p">,</span><span class="n">yd99p</span><span class="p">,</span><span class="n">yd99n</span></div>


<div class="viewcode-block" id="contributions">
<a class="viewcode-back" href="../pyphi.html#pyphi.contributions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">contributions</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">cont_type</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">from_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">to_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lv_space</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to calculate contributions to diagnostics</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    contrib =  pyphi.contributions(mvmobj,X,cont_type,&lt;Y=False,from_obs=False,to_obs=False,lv_space=False&gt;)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mvmobj : A dictionary created by phi.pls or phi.pca</span>
<span class="sd">        </span>
<span class="sd">        X/Y:     Data [numpy arrays or pandas dataframes] - Y space is optional</span>
<span class="sd">        </span>
<span class="sd">        cont_type: &#39;ht2&#39; - Contributions to Hotelling&#39;s T2</span>
<span class="sd">                   &#39;spe&#39; - Contributions to SPE space</span>
<span class="sd">                   &#39;scores&#39; - Contribution to scores</span>
<span class="sd">                   </span>
<span class="sd">        to_obs: Scalar or list of scalars with observation(s) number(s) to calculate contributions (TO)          </span>
<span class="sd">                *Note: from_obs is ignored when cont_type=&#39;spe&#39;*</span>
<span class="sd">                </span>
<span class="sd">                </span>
<span class="sd">        from_obs: Scalar or list of scalars with observation(s) number(s) to offset (FROM) if not sent,</span>
<span class="sd">                  contribution are calculated with respect to the mean.</span>
<span class="sd">                  </span>
<span class="sd">        lv_space: Latent spaces over which to do the calculations [applicable to &#39;ht2&#39; and &#39;scores&#39;] if not sent</span>
<span class="sd">                  all dimensions are considered.</span>
<span class="sd">    Returns:</span>
<span class="sd">        contrib: A vector of scalars with the corresponding contributions</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lv_space</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="n">lv_space</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lv_space</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">lv_space</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lv_space</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">lv_space</span><span class="o">=</span><span class="n">lv_space</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lv_space</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">lv_space</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lv_space</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">lv_space</span><span class="o">=</span><span class="n">lv_space</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_obs</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">to_obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">to_obs</span><span class="p">])</span>
        <span class="n">to_obs</span><span class="o">=</span><span class="n">to_obs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_obs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">to_obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_obs</span><span class="p">)</span>
        <span class="n">to_obs</span><span class="o">=</span><span class="n">to_obs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>    
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
           <span class="n">from_obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">from_obs</span><span class="p">])</span>
           <span class="n">from_obs</span><span class="o">=</span><span class="n">from_obs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">from_obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">from_obs</span><span class="p">)</span>
            <span class="n">from_obs</span><span class="o">=</span><span class="n">from_obs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>      
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;ht2&#39;</span> <span class="ow">or</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;scores&#39;</span><span class="p">:</span>
        <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">X_</span><span class="o">=</span><span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">t_stdevs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">:</span>
            <span class="n">loadings</span><span class="o">=</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loadings</span><span class="o">=</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>    
        <span class="n">to_obs_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_</span><span class="p">[</span><span class="n">to_obs</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
        <span class="n">to_cont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lv_space</span><span class="p">:</span>    
                <span class="n">aux_</span><span class="o">=</span><span class="p">(</span><span class="n">to_obs_mean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">loadings</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">/</span><span class="n">t_stdevs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;scores&#39;</span><span class="p">:</span>
                    <span class="n">to_cont</span><span class="o">=</span><span class="n">to_cont</span> <span class="o">+</span> <span class="n">aux_</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_cont</span><span class="o">=</span><span class="n">to_cont</span> <span class="o">+</span> <span class="n">aux_</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">from_obs_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_</span><span class="p">[</span><span class="n">from_obs</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
            <span class="n">from_cont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lv_space</span><span class="p">:</span>    
                    <span class="n">aux_</span><span class="o">=</span><span class="p">(</span><span class="n">from_obs_mean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">loadings</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">/</span><span class="n">t_stdevs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;scores&#39;</span><span class="p">:</span>
                        <span class="n">from_cont</span><span class="o">=</span><span class="n">from_cont</span> <span class="o">+</span> <span class="n">aux_</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">from_cont</span><span class="o">=</span><span class="n">from_cont</span> <span class="o">+</span> <span class="n">aux_</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">calc_contribution</span> <span class="o">=</span> <span class="n">to_cont</span> <span class="o">-</span> <span class="n">from_cont</span>
            <span class="k">return</span> <span class="n">calc_contribution</span>            
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">to_cont</span>

    <span class="k">elif</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;spe&#39;</span><span class="p">:</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">X_</span><span class="p">[</span><span class="n">to_obs</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">:</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">pca_pred</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">mvmobj</span><span class="p">)</span>
        <span class="n">Xhat</span><span class="o">=</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span>       
        <span class="n">Xhatmcs</span><span class="o">=</span><span class="p">((</span><span class="n">Xhat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">Xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">Xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">X_</span><span class="o">=</span><span class="p">((</span><span class="n">X_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">Xerror</span><span class="o">=</span><span class="p">(</span><span class="n">X_</span><span class="o">-</span><span class="n">Xhatmcs</span><span class="p">)</span>
        <span class="n">Xerror</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Xerror</span><span class="p">)</span>
        <span class="n">contsX</span><span class="o">=</span><span class="p">((</span><span class="n">Xerror</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Xerror</span><span class="p">)</span>
        <span class="n">contsX</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">contsX</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">Y_</span><span class="o">=</span><span class="n">Y_</span><span class="p">[</span><span class="n">to_obs</span><span class="p">,:]</span>
            <span class="n">Yhat</span><span class="o">=</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>
            <span class="n">Yhatmcs</span><span class="o">=</span><span class="p">((</span><span class="n">Yhat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],(</span><span class="n">Yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],(</span><span class="n">Yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
            <span class="n">Y_</span><span class="o">=</span><span class="p">((</span><span class="n">Y_</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],(</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],(</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))))</span>
            <span class="n">Yerror</span><span class="o">=</span><span class="p">(</span><span class="n">Y_</span><span class="o">-</span><span class="n">Yhatmcs</span><span class="p">)</span>
            <span class="n">Yerror</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Yerror</span><span class="p">)</span>
            <span class="n">contsY</span><span class="o">=</span><span class="p">((</span><span class="n">Yerror</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Yerror</span><span class="p">)</span>
            <span class="n">contsY</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">contsY</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">contsX</span><span class="p">,</span><span class="n">contsY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">contsX</span></div>


<div class="viewcode-block" id="clean_empty_rows">
<a class="viewcode-back" href="../pyphi.html#pyphi.clean_empty_rows">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_empty_rows</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Routine to clean a matrix from rows containing all missing data</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    X,rows_removed = pyphi.clean_empty_rows(X)</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        X: Matrix to be cleaned of empty rows (all np.nan)</span>
<span class="sd">    Returns:</span>
<span class="sd">        X: Matrix without observations removed</span>
<span class="sd">        rows_removed: List of rows removed from X</span>
<span class="sd">        </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span>     <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ObsID_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ObsID_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Obs #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>  
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">ObsID_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">ObsID_</span> <span class="o">=</span> <span class="n">ObsID_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                     
    <span class="c1">#find rows with all data missing</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">Xmiss</span> <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Xmiss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xmiss</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">Xmiss</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">rows_rem</span><span class="o">=</span><span class="p">[]</span>   
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing row &#39;</span><span class="p">,</span> <span class="n">ObsID_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39; due to 100% missing data&#39;</span><span class="p">)</span>
            <span class="n">rows_rem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ObsID_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_</span><span class="p">,</span><span class="n">rows_rem</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">rows_rem</span></div>

    
<div class="viewcode-block" id="clean_low_variances">
<a class="viewcode-back" href="../pyphi.html#pyphi.clean_low_variances">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_low_variances</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">min_var</span><span class="o">=</span><span class="mf">1E-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Routine to remove columns of neglegible variance</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    X,columns_removed = pyphi.clean_low_variances(X,&lt;min_var=1E-10,shush=False&gt;)</span>

<span class="sd">    Args:</span>
<span class="sd">         X: Matrix to be cleaned for columns of low variance</span>
<span class="sd">         min_var: minimum required variance to keep a colum (default = 1E-10)</span>
<span class="sd">         shush: &#39;True&#39; disables output to console</span>
<span class="sd">    Returns:     </span>
<span class="sd">        X_clean:  Matrix without low variance columns</span>
<span class="sd">        cols_removed:  Columns removed</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cols_removed</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">varidX</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">varidX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Var #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>   
            
    <span class="c1">#find columns with all data missing, a column must have at least 3 samples</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">Xmiss</span> <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Xmiss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xmiss</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#indx = find(Xmiss, lambda x: x==X_.shape[0])</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">Xmiss</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="p">)))</span>
    
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing variable &#39;</span><span class="p">,</span> <span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39; due to 100% missing data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">cols_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">X_pd</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_pd</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">cols_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_pd</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="n">new_cols</span><span class="o">=</span><span class="n">X_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
    <span class="n">std_x</span><span class="o">=</span><span class="n">std</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">std_x</span><span class="o">=</span><span class="n">std_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="n">indx</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">std_x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">&lt;</span><span class="n">min_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing variable &#39;</span><span class="p">,</span> <span class="n">new_cols</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39; due to low variance&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_pd</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">cols_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cols</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">X_pd</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">X_pd</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#cols_removed.extend(varidX[indx])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">cols_removed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidX</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    
        <span class="k">return</span> <span class="n">X_</span><span class="p">,</span><span class="n">cols_removed</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">X_pd</span><span class="p">,</span><span class="n">cols_removed</span></div>

    
<div class="viewcode-block" id="find">
<a class="viewcode-back" href="../pyphi.html#pyphi.find">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span></div>



<div class="viewcode-block" id="conv_pls_2_eiot">
<a class="viewcode-back" href="../pyphi.html#pyphi.conv_pls_2_eiot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">conv_pls_2_eiot</span><span class="p">(</span><span class="n">plsobj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">r_length</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">plsobj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for LV&#39;s</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of X</span>
    <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of Y</span>
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">pyo_A</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">pyo_N</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">pyo_M</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="n">pyo_Ws</span> <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">])</span>
    <span class="n">pyo_Q</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">])</span>
    <span class="n">pyo_P</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
    
    <span class="n">var_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">pyo_var_t</span> <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">var_t</span><span class="p">)</span>
    <span class="n">pyo_mx</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span>
    <span class="n">pyo_sx</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">])</span>
    <span class="n">pyo_my</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">])</span>
    <span class="n">pyo_sy</span>    <span class="o">=</span> <span class="n">np1D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">])</span>
    
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r_length</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r_length</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>   
            <span class="n">indx_r</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">r_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">indx_rk_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r_length</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">indx_r</span>     <span class="o">=</span> <span class="n">indx_r</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">indx_rk_eq</span> <span class="o">=</span> <span class="n">indx_rk_eq</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">r_length</span> <span class="o">==</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">indx_r</span>  <span class="o">=</span> <span class="n">pyo_N</span>
            <span class="n">indx_rk_eq</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;r_length &gt;&gt; N !!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Forcing r_length=N&#39;</span><span class="p">)</span>
            <span class="n">indx_r</span>  <span class="o">=</span> <span class="n">pyo_N</span>
            <span class="n">indx_rk_eq</span><span class="o">=</span><span class="mi">0</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r_length</span><span class="p">:</span>
           <span class="n">indx_r</span>  <span class="o">=</span> <span class="n">pyo_N</span> 
           <span class="n">indx_rk_eq</span> <span class="o">=</span> <span class="mi">0</span>
            
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_A</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_N</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_M&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_M</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Ws&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_Ws</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Q&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_Q</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_P&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_P</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_var_t&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pyo_var_t</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;indx_r&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">indx_r</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;indx_rk_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx_rk_eq</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_mx&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_mx</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_sx&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_sx</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_my&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_my</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_sy&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_sy</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;S_I&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_S_I&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;var_t&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">var_t</span>
    <span class="k">return</span> <span class="n">plsobj_</span>    </div>

        
<div class="viewcode-block" id="prep_pca_4_MDbyNLP">
<a class="viewcode-back" href="../pyphi.html#pyphi.prep_pca_4_MDbyNLP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prep_pca_4_MDbyNLP</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
    <span class="n">pcaobj_</span> <span class="o">=</span> <span class="n">pcaobj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">X</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
   
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for LV&#39;s</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of X (rows of P)</span>
    <span class="n">pyo_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">O</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for rows of X </span>
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">pyo_A</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">pyo_N</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_O</span> <span class="o">=</span> <span class="n">pyo_O</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="n">pyo_P_init</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
    <span class="n">pyo_T_init</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">pcaobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>
    <span class="n">pyo_X</span>       <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">pyo_psi</span>     <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>

    
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_A</span>
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_N</span>
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_O&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_O</span>
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_P_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo_P_init</span>
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_T_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo_T_init</span>
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_X&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">pyo_X</span>
    <span class="n">pcaobj_</span><span class="p">[</span><span class="s1">&#39;pyo_psi&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">pyo_psi</span>

    <span class="k">return</span> <span class="n">pcaobj_</span>    </div>

    

<div class="viewcode-block" id="prep_pls_4_MDbyNLP">
<a class="viewcode-back" href="../pyphi.html#pyphi.prep_pls_4_MDbyNLP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prep_pls_4_MDbyNLP</span><span class="p">(</span><span class="n">plsobj</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">):</span>
    <span class="n">plsobj_</span> <span class="o">=</span> <span class="n">plsobj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">X</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Y</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    
    <span class="n">A</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for LV&#39;s</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of X (rows of P)</span>
    <span class="n">pyo_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">O</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for rows of X </span>
    <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#index for columns of Y (rows of Q)</span>
    <span class="n">pyo_A</span> <span class="o">=</span> <span class="n">pyo_A</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_N</span> <span class="o">=</span> <span class="n">pyo_N</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_O</span> <span class="o">=</span> <span class="n">pyo_O</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pyo_M</span> <span class="o">=</span> <span class="n">pyo_M</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="n">pyo_P_init</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
    <span class="n">pyo_Ws_init</span> <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">])</span>
    <span class="n">pyo_T_init</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>
    <span class="n">pyo_Q_init</span>  <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">plsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">])</span>
    <span class="n">pyo_X</span>       <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">pyo_Y</span>       <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">pyo_psi</span>     <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
    <span class="n">pyo_theta</span>   <span class="o">=</span> <span class="n">np2D2pyomo</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_A&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">pyo_A</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_N&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">pyo_N</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_O&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">pyo_O</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_M&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">pyo_M</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_P_init&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pyo_P_init</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Ws_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyo_Ws_init</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_T_init&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pyo_T_init</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Q_init&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pyo_Q_init</span>    
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_X&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">pyo_X</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_psi&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">pyo_psi</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_Y&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">pyo_Y</span>
    <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;pyo_theta&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pyo_theta</span>

    <span class="k">return</span> <span class="n">plsobj_</span>   </div>


<div class="viewcode-block" id="cat_2_matrix">
<a class="viewcode-back" href="../pyphi.html#pyphi.cat_2_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cat_2_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to convert categorical data into binary matrices for regression</span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk) / (salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    Xmat,XmatMB = cat_2_matrix(X)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        X is a Pandas Data Frame with categorical descriptors for each observation</span>
<span class="sd">    </span>
<span class="sd">    Returns: </span>
<span class="sd">        Xmat   :  matrix of binary coded data, </span>
<span class="sd">        XmatMB :  binary coded data orgainzed as a list of matrices for Multi-block modeling</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">FirstOne</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">Xmat</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Xcat</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">XcatMB</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">XmatMB</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">blknames</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">FirstOne</span><span class="p">):</span>
            <span class="n">blknames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">categories</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="n">XcatMB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
            <span class="n">Xmat_</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="n">Xcat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">xmat_</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">==</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">Xmat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xmat_</span><span class="p">)</span>
                <span class="n">Xmat_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xmat_</span><span class="p">)</span>
                
            <span class="n">Xmat_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xmat_</span><span class="p">)</span>
            <span class="n">Xmat_</span><span class="o">=</span><span class="n">Xmat_</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Xmat_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xmat_</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">categories</span><span class="p">)</span> 
            <span class="n">Xmat_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">firstcol</span><span class="p">,</span><span class="n">X</span><span class="p">[</span><span class="n">firstcol</span><span class="p">])</span> 
            <span class="n">XmatMB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xmat_</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">firstcol</span><span class="o">=</span><span class="n">x</span>
            <span class="n">FirstOne</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">Xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xmat</span><span class="p">)</span>
    <span class="n">Xmat</span><span class="o">=</span><span class="n">Xmat</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Xmat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xmat</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">Xcat</span><span class="p">)</span> 
    <span class="n">Xmat</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">firstcol</span><span class="p">,</span><span class="n">X</span><span class="p">[</span><span class="n">firstcol</span><span class="p">])</span>      
    <span class="n">XmatMB</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">XmatMB</span><span class="p">,</span><span class="s1">&#39;blknames&#39;</span><span class="p">:</span><span class="n">blknames</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Xmat</span><span class="p">,</span><span class="n">XmatMB</span></div>


<div class="viewcode-block" id="mbpls">
<a class="viewcode-back" href="../pyphi.html#pyphi.mbpls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mbpls</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">YMB</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">md_algorithm_</span><span class="o">=</span><span class="s1">&#39;nipals&#39;</span><span class="p">,</span><span class="n">force_nipals_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cross_val_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cross_val_X_</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to calculate a Multi-Block PLS model</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    Multi-block PLS model using the approach by Westerhuis, J. Chemometrics, 12, 301–321 (1998)</span>
<span class="sd">    </span>
<span class="sd">    mbpls_obj = pyphi.mbpls(XMB,YMB,A,&lt;mcsX=True,mcsY=True,md_algorithm_=&#39;nipals&#39;,force_nipals_=False,</span>
<span class="sd">                                      shush_=False,cross_val_=0,cross_val_X_=False&gt;)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        XMB : Dictionary or PandasDataFrames one key per block of data</span>
<span class="sd">            Dictionary structure:</span>
<span class="sd">            {&#39;BlockName1&#39;:block_1_data_pd,</span>
<span class="sd">             &#39;BlockName2&#39;:block_2_data_pd}</span>
<span class="sd">    </span>
<span class="sd">        YMB : Dictionary or PandasDataFrame</span>
<span class="sd">            Dictionary structure:</span>
<span class="sd">            {&#39;BlockName1&#39;:block_1_data_pd,</span>
<span class="sd">             &#39;BlockName2&#39;:block_2_data_pd}</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        mbpls_obj: Dictionary with all the parameters of a Multi-block PLS model</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x_means</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">x_stds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">y_means</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">y_stds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Xblk_scales</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Yblk_scales</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Xcols_per_block</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Ycols_per_block</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">X_var_names</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Y_var_names</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">obsids</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">data_</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">names_</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">XMB</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">data_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XMB</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">names_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">XMB</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">data_</span><span class="p">,</span><span class="s1">&#39;blknames&#39;</span><span class="p">:</span><span class="n">names_</span><span class="p">}</span>
        
        
        <span class="n">x</span><span class="o">=</span><span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>        
        <span class="n">columns</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">obsid_column_name</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>        
        <span class="n">obsids</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">obsid_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="n">c</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>        
            <span class="n">x_</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>         
            <span class="n">columns</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">X_var_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;blknames&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">h</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mcsX</span><span class="p">:</span>
                    <span class="c1">#Mean center and autoscale  </span>
                    <span class="n">x_</span><span class="p">,</span><span class="n">x_mean_</span><span class="p">,</span><span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">x_mean_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">x_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">x_std_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">x_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">mcsX</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
                <span class="c1">#only center</span>
                <span class="n">x_</span><span class="p">,</span><span class="n">x_mean_</span><span class="p">,</span><span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mcsX</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
                <span class="c1">#only autoscale</span>
                <span class="n">x_</span><span class="p">,</span><span class="n">x_mean_</span><span class="p">,</span><span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
            <span class="n">blck_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            
            <span class="n">x_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_mean_</span><span class="p">)</span>
            <span class="n">x_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_std_</span><span class="p">)</span>                   
            <span class="n">Xblk_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blck_scale</span><span class="p">)</span>
            <span class="n">Xcols_per_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">x_</span><span class="o">=</span><span class="n">x_</span><span class="o">/</span><span class="n">blck_scale</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">X_</span><span class="o">=</span><span class="n">x_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X_</span><span class="p">,</span><span class="n">x_</span><span class="p">))</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">XMB</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">obsid_column_name</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>        
        <span class="n">obsids</span><span class="o">=</span><span class="n">XMB</span><span class="p">[</span><span class="n">obsid_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>            
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">X_var_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">x_</span><span class="o">=</span><span class="n">XMB</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcsX</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">x_</span><span class="p">,</span><span class="n">x_mean_</span><span class="p">,</span><span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">x_mean_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">x_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">x_std_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">x_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcsX</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">x_</span><span class="p">,</span><span class="n">x_mean_</span><span class="p">,</span><span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcsX</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">x_</span><span class="p">,</span><span class="n">x_mean_</span><span class="p">,</span><span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        <span class="n">blck_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">x_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_mean_</span><span class="p">)</span>
        <span class="n">x_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_std_</span><span class="p">)</span>                   
        <span class="n">Xblk_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blck_scale</span><span class="p">)</span>
        <span class="n">Xcols_per_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x_</span><span class="o">=</span><span class="n">x_</span><span class="o">/</span><span class="n">blck_scale</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">x_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">YMB</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">data_</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">names_</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">YMB</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">data_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">YMB</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">names_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">YMB</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">data_</span><span class="p">,</span><span class="s1">&#39;blknames&#39;</span><span class="p">:</span><span class="n">names_</span><span class="p">}</span>
        
        <span class="n">c</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">YMB</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>        
            <span class="n">y_</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">Y_var_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mcsY</span><span class="p">:</span>
                    <span class="c1">#Mean center and autoscale  </span>
                    <span class="n">y_</span><span class="p">,</span><span class="n">y_mean_</span><span class="p">,</span><span class="n">y_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">y_mean_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">y_std_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">mcsY</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
                <span class="c1">#only center</span>
                <span class="n">y_</span><span class="p">,</span><span class="n">y_mean_</span><span class="p">,</span><span class="n">y_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mcsY</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
                <span class="c1">#only autoscale</span>
                <span class="n">y_</span><span class="p">,</span><span class="n">y_mean_</span><span class="p">,</span><span class="n">y_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
            <span class="n">blck_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            
            <span class="n">y_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_mean_</span><span class="p">)</span>
            <span class="n">y_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_std_</span><span class="p">)</span>                   
            <span class="n">Yblk_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blck_scale</span><span class="p">)</span>
            <span class="n">Ycols_per_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">y_</span><span class="o">=</span><span class="n">y_</span><span class="o">/</span><span class="n">blck_scale</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">Y_</span><span class="o">=</span><span class="n">y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Y_</span><span class="p">,</span><span class="n">y_</span><span class="p">))</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>    
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">YMB</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">y_</span><span class="o">=</span><span class="n">YMB</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">YMB</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">Y_var_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mcsY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mcsY</span><span class="p">:</span>
                <span class="c1">#Mean center and autoscale  </span>
                <span class="n">y_</span><span class="p">,</span><span class="n">y_mean_</span><span class="p">,</span><span class="n">y_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">y_mean_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">y_std_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">mcsY</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
            <span class="c1">#only center</span>
            <span class="n">y_</span><span class="p">,</span><span class="n">y_mean_</span><span class="p">,</span><span class="n">y_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mcsY</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;autoscale&#39;</span><span class="p">:</span>
            <span class="c1">#only autoscale</span>
            <span class="n">y_</span><span class="p">,</span><span class="n">y_mean_</span><span class="p">,</span><span class="n">y_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="n">mcs</span><span class="o">=</span><span class="s1">&#39;autoscale&#39;</span><span class="p">)</span>
        <span class="n">blck_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">y_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_mean_</span><span class="p">)</span>
        <span class="n">y_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_std_</span><span class="p">)</span>                   
        <span class="n">Yblk_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blck_scale</span><span class="p">)</span>
        <span class="n">Ycols_per_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y_</span><span class="o">=</span><span class="n">y_</span><span class="o">/</span><span class="n">blck_scale</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">y_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        
        
    <span class="n">X_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">X_var_names</span><span class="p">)</span>
    <span class="n">X_pd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">obsid_column_name</span><span class="p">,</span><span class="n">obsids</span><span class="p">)</span>

    <span class="n">Y_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">Y_var_names</span><span class="p">)</span>
    <span class="n">Y_pd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">obsid_column_name</span><span class="p">,</span><span class="n">obsids</span><span class="p">)</span>

    <span class="n">pls_obj_</span><span class="o">=</span><span class="n">pls</span><span class="p">(</span><span class="n">X_pd</span><span class="p">,</span><span class="n">Y_pd</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">md_algorithm</span><span class="o">=</span><span class="n">md_algorithm_</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="n">force_nipals_</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="n">shush_</span><span class="p">,</span><span class="n">cross_val</span><span class="o">=</span><span class="n">cross_val_</span><span class="p">,</span><span class="n">cross_val_X</span><span class="o">=</span><span class="n">cross_val_X_</span><span class="p">)</span>          
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;mbpls&#39;</span>
    <span class="c1">#Calculate block loadings, scores, weights</span>
    <span class="n">Wsb</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Wb</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Tb</span><span class="o">=</span><span class="p">[]</span>
     
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Xcols_per_block</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">start_index</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">end_index</span><span class="o">=</span><span class="n">c</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xcols_per_block</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
            <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">c</span>

        <span class="n">wsb_</span><span class="o">=</span><span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">wsb_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">wsb_</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">wsb_</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wsb_</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">Wsb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wsb_</span><span class="p">)</span>
        
        <span class="n">wb_</span><span class="o">=</span><span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">wb_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">wb_</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">wb_</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wb_</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">Wb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wb_</span><span class="p">)</span>
        
        <span class="n">Xb</span><span class="o">=</span><span class="n">X_</span><span class="p">[:,</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">]</span>
        <span class="n">tb</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
        <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">Xb</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
        <span class="n">TSS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>            
            <span class="n">w_</span><span class="o">=</span><span class="n">wb_</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
            <span class="n">w_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">w_</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">w_t</span> <span class="o">=</span> <span class="n">w_t</span> <span class="o">*</span> <span class="n">not_Xmiss</span>
            <span class="n">w_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_t</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>           
            <span class="n">tb_</span><span class="o">=</span><span class="p">(</span><span class="n">Xb</span> <span class="o">@</span> <span class="n">w_</span><span class="p">)</span> <span class="o">/</span> <span class="n">w_t</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">tb</span><span class="o">=</span><span class="n">tb_</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">tb</span><span class="p">,</span><span class="n">tb_</span><span class="p">))</span>
            
            <span class="n">tb_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tb_</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">tb_t</span> <span class="o">=</span> <span class="n">tb_t</span> <span class="o">*</span> <span class="n">not_Xmiss</span><span class="o">.</span><span class="n">T</span>
            <span class="n">tb_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tb_t</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pb_</span>  <span class="o">=</span> <span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">tb_</span><span class="p">)</span> <span class="o">/</span> <span class="n">tb_t</span>
            
            <span class="n">Xb</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xb</span> <span class="o">-</span> <span class="n">tb_</span> <span class="o">@</span> <span class="n">pb_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">not_Xmiss</span>
            <span class="n">r2pb_aux</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">r2pb_</span><span class="o">=</span><span class="n">r2pb_aux</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2pb_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2pb_</span><span class="p">,</span><span class="n">r2pb_aux</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">r2pbX</span><span class="o">=</span><span class="n">r2pb_</span>
        <span class="k">else</span><span class="p">:</span>            
            <span class="n">r2pbX</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r2pbX</span><span class="p">,</span><span class="n">r2pb_</span><span class="p">))</span>
        <span class="n">Tb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="n">T_a</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">u</span><span class="o">=</span><span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">][:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Xcols_per_block</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">T_a</span> <span class="o">=</span> <span class="n">Tb</span><span class="p">[</span><span class="n">i</span><span class="p">][:,[</span><span class="n">a</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">T_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span><span class="n">Tb</span><span class="p">[</span><span class="n">i</span><span class="p">][:,[</span><span class="n">a</span><span class="p">]]))</span>
        <span class="n">wt_</span><span class="o">=</span><span class="p">(</span><span class="n">T_a</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Wt</span><span class="o">=</span><span class="n">wt_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Wt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Wt</span><span class="p">,</span><span class="n">wt_</span><span class="p">))</span>
    
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;x_means&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x_means</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;x_stds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x_stds</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;y_means&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">y_means</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;y_stds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">y_stds</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Xblk_scales&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Xblk_scales</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Yblk_scales&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Yblk_scales</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Wsb&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Wsb</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Wt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Wt</span>
    <span class="n">mx_</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_means</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">mx_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mx_</span><span class="p">)</span>    
    <span class="n">sx_</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_stds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">sx_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">Xblk_scales</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sx_</span><span class="p">)</span>
    <span class="n">my_</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_means</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">my_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">my_</span><span class="p">)</span>    
    <span class="n">sy_</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_stds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">sy_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">Yblk_scales</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sy_</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
             <span class="n">r2pbX</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>     <span class="o">=</span> <span class="n">r2pbX</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span><span class="o">-</span><span class="n">r2pbX</span><span class="p">[:,[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">r2pbXc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2pbX</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
        <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;r2pbX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">r2pbX</span>
        <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;r2pbXc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">r2pbXc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
             <span class="n">r2pbX</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2pbX</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2pbX</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2pbXc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2pbX</span><span class="p">)</span>
    
        <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;r2pbX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">r2pbX</span>
        <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;r2pbXc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">r2pbXc</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Xblocknames&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;blknames&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">YMB</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">pls_obj_</span><span class="p">[</span><span class="s1">&#39;Yblocknames&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">YMB</span><span class="p">[</span><span class="s1">&#39;blknames&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pls_obj_</span></div>


<div class="viewcode-block" id="replicate_data">
<a class="viewcode-back" href="../pyphi.html#pyphi.replicate_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">replicate_data</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">num_replicates</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">as_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvm_obj</span><span class="p">:</span>
        <span class="n">pls_preds</span><span class="o">=</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">mvm_obj</span><span class="p">)</span>
        <span class="n">xhat</span><span class="o">=</span><span class="n">pls_preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span>
        <span class="n">tnew</span><span class="o">=</span><span class="n">pls_preds</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pca_preds</span><span class="o">=</span><span class="n">pca_pred</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">mvm_obj</span><span class="p">)</span>
        <span class="n">xhat</span><span class="o">=</span><span class="n">pca_preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span>
        <span class="n">tnew</span><span class="o">=</span><span class="n">pca_preds</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">]</span>
    <span class="n">xhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">xhat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">xhat</span> <span class="o">=</span> <span class="n">tnew</span> <span class="o">@</span> <span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">xmcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">data_residuals</span><span class="o">=</span><span class="n">xmcs</span><span class="o">-</span><span class="n">xhat</span>

    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">as_set</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">num_replicates</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">reps</span><span class="o">=</span><span class="n">num_replicates</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            
            <span class="n">new_set</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xhat</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">reps</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">num_replicates</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">new_set</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xhat</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">reps</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">reps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">num_replicates</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">new_set</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">new_set</span><span class="p">,</span><span class="n">xhat</span><span class="p">[:</span><span class="n">reps</span><span class="p">,:]))</span>                
        <span class="n">obsids</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">new_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">obsids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;clone&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            
    <span class="k">else</span><span class="p">:</span>            
        <span class="n">new_set</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xhat</span><span class="p">,(</span><span class="n">num_replicates</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">obsids</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">obsid_o</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_replicates</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">post_fix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_clone&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">obsids_</span><span class="o">=</span><span class="p">[</span><span class="n">m</span><span class="o">+</span><span class="n">n</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obsid_o</span><span class="p">,</span><span class="n">post_fix</span><span class="p">)]</span>
            <span class="n">obsids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obsids_</span><span class="p">)</span>
            
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data_residuals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
<span class="c1">#        plt.figure()</span>
<span class="c1">#        plt.hist(data_residuals[:,i])</span>
<span class="c1">#        plt.title(&#39;Original Residual Distribution&#39;)</span>
        <span class="n">ecdf</span> <span class="o">=</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">data_residuals</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">new_residual</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">new_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ecdf</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ecdf</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">new_residual</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_residual</span><span class="p">,</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">uncertainty_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_residual</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uncertainty_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">uncertainty_matrix</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_residual</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
    <span class="n">new_set</span><span class="o">=</span><span class="n">new_set</span><span class="o">+</span><span class="n">uncertainty_matrix</span>
    <span class="n">new_set</span><span class="o">=</span><span class="p">(</span><span class="n">new_set</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">new_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">new_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">new_set_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_set</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">new_set_pd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">obsids</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">new_set_pd</span></div>


<div class="viewcode-block" id="export_2_gproms">
<a class="viewcode-back" href="../pyphi.html#pyphi.export_2_gproms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_2_gproms</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;phi_export.txt&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to export PLS model to be build a hybrid model in gPROMS</span>
<span class="sd">     </span>
<span class="sd">     by Salvador Garcia-Munoz </span>
<span class="sd">     (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">     </span>
<span class="sd">    pyphi.export_2_gproms(mvmobj,fname=&#39;phi_export.txt&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Exports the multivariate object coded in gPROMS syntax</span>
<span class="sd">    </span>
<span class="sd">    typically one would use the variables X_NEW and Y_PRED as the Input/Output variables</span>
<span class="sd">    Args:</span>
<span class="sd">        mvmobj: A PLS model createdy with pyphi.pls</span>
<span class="sd">        fname: Name of the text file to be created</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">top_lines</span><span class="o">=</span><span class="p">[</span>     
    <span class="s1">&#39;PARAMETER&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_VARS AS ORDERED_SET&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y_VARS AS ORDERED_SET&#39;</span><span class="p">,</span>
    <span class="s1">&#39;A      AS INTEGER&#39;</span><span class="p">,</span>
    <span class="s1">&#39;VARIABLE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_MEANS as ARRAY(X_VARS)    OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_STD   AS ARRAY(X_VARS)    OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y_MEANS as ARRAY(Y_VARS)    OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y_STD   AS ARRAY(Y_VARS)    OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ws      AS ARRAY(X_VARS,A)  OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Q       AS ARRAY(Y_VARS,A)  OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;P       AS ARRAY(X_VARS,A)  OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;T       AS ARRAY(A)         OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tvar    AS ARRAY(A)         OF no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_HAT   AS ARRAY(X_VARS)    OF no_type # Mean-centered and scaled&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y_HAT   AS ARRAY(Y_VARS)    OF no_type # Mean-centered and scaled&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_PRED  AS ARRAY(X_VARS)    OF no_type # In original units&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y_PRED  AS ARRAY(Y_VARS)    OF no_type # In original units&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_NEW   AS ARRAY(X_VARS)    OF no_type # In original units&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_MCS   AS ARRAY(X_VARS)    OF no_type # Mean-centered and scaled&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HT2                         AS no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SPEX                        AS no_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SET&#39;</span><span class="p">]</span>
    
    <span class="n">x_var_line</span><span class="o">=</span><span class="s2">&quot;X_VARS:=[&#39;&quot;</span> <span class="o">+</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">x_var_line</span><span class="o">=</span><span class="n">x_var_line</span><span class="o">+</span><span class="s2">&quot;,&#39;&quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span>
    <span class="n">x_var_line</span><span class="o">=</span><span class="n">x_var_line</span><span class="o">+</span><span class="s1">&#39;];&#39;</span>

    <span class="n">y_var_line</span><span class="o">=</span><span class="s2">&quot;Y_VARS:=[&#39;&quot;</span> <span class="o">+</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">y_var_line</span><span class="o">=</span><span class="n">y_var_line</span><span class="o">+</span><span class="s2">&quot;,&#39;&quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span>
    <span class="n">y_var_line</span><span class="o">=</span><span class="n">y_var_line</span><span class="o">+</span><span class="s1">&#39;];&#39;</span>
    

    <span class="n">top_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_var_line</span><span class="p">)</span>
    <span class="n">top_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_var_line</span><span class="p">)</span>
    <span class="n">top_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;A:=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    
    <span class="n">mid_lines</span><span class="o">=</span><span class="p">[</span>
    <span class="s1">&#39;EQUATION&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_MCS * X_STD = (X_NEW-X_MEANS);&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FOR j:=1 TO A DO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;T(j) = SIGMA(X_MCS*Ws(,j));&#39;</span><span class="p">,</span>
    <span class="s1">&#39;END&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FOR i IN Y_VARS DO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y_HAT(i) = SIGMA(T*Q(i,));&#39;</span><span class="p">,</span>
    <span class="s1">&#39;END&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FOR i IN X_VARS DO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X_HAT(i) = SIGMA(T*P(i,));&#39;</span><span class="p">,</span>
    <span class="s1">&#39;END&#39;</span><span class="p">,</span>
    <span class="s1">&#39;(X_HAT * X_STD) + X_MEANS = X_PRED;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;(Y_HAT * Y_STD) + Y_MEANS = Y_PRED;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HT2  = SIGMA ((T^2)/Tvar);&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SPEX = SIGMA ((X_MCS - X_HAT)^2);&#39;</span><span class="p">]</span>

    <span class="n">assign_lines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ASSIGN&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]):</span>     
        <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;X_MEANS(&#39;&quot;</span><span class="o">+</span><span class="n">xvar</span><span class="o">+</span><span class="s2">&quot;&#39;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]):</span>     
        <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;X_STD(&#39;&quot;</span><span class="o">+</span><span class="n">xvar</span><span class="o">+</span><span class="s2">&quot;&#39;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">yvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]):</span>     
        <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Y_MEANS(&#39;&quot;</span><span class="o">+</span><span class="n">yvar</span><span class="o">+</span><span class="s2">&quot;&#39;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">yvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]):</span>     
        <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Y_STD(&#39;&quot;</span><span class="o">+</span><span class="n">yvar</span><span class="o">+</span><span class="s2">&quot;&#39;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]):</span>     
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Ws(&#39;&quot;</span><span class="o">+</span><span class="n">xvar</span><span class="o">+</span><span class="s2">&quot;&#39;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]):</span>     
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;P(&#39;&quot;</span><span class="o">+</span><span class="n">xvar</span><span class="o">+</span><span class="s2">&quot;&#39;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">yvar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]):</span>     
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Q(&#39;&quot;</span><span class="o">+</span><span class="n">yvar</span><span class="o">+</span><span class="s2">&quot;&#39;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">tvar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">assign_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Tvar(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;) := &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tvar</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;;&quot;</span> <span class="p">)</span> 
 
    <span class="n">lines</span><span class="o">=</span><span class="n">top_lines</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mid_lines</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">assign_lines</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="unique">
<a class="viewcode-back" href="../pyphi.html#pyphi.unique">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">colid</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&#39;&#39;&#39; returns unique values in the column of a DataFrame in order of occurence</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    replacement of the np.unique routine, specifically for dataframes</span>
<span class="sd">    returns unique values in the order found in the dataframe</span>
<span class="sd">    unique_values = pyphi.unique(df,columnid)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df:     A pandas dataframe</span>
<span class="sd">        columnid:  Column identifier </span>
<span class="sd">    Returns:</span>
<span class="sd">        unique_values: List of unique values in the order they appear</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">aux</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">colid</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_entries</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">colid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">unique_entries</span></div>

    
<div class="viewcode-block" id="parse_materials">
<a class="viewcode-back" href="../pyphi.html#pyphi.parse_materials">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_materials</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">sheetname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to build R matrices for JRPLS model from linear table </span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    Routine to parse out compositions from linear table</span>
<span class="sd">    This reads an excel file with four columns:</span>
<span class="sd">        &#39;Finished Product Lot&#39;	&#39;Material Lot&#39;	&#39;Ratio or Quantity&#39;	&#39;Material&#39;</span>
<span class="sd">        </span>
<span class="sd">    where the usage per batch of finished product is recorded. e.g.</span>

<span class="sd">&#39;Finished Product Lot&#39;	&#39;Material Lot&#39;	&#39;Ratio or Quantity&#39;	&#39;Material&#39;</span>
<span class="sd">        A001                 A                0.75             Drug</span>
<span class="sd">        A001                 B                0.25             Drug</span>
<span class="sd">        A001                 Z                1.0              Excipient</span>
<span class="sd">        .                    .                 .                 .</span>
<span class="sd">        .                    .                 .                 .</span>
<span class="sd">        .                    .                 .                 .</span>
<span class="sd">    Args:</span>
<span class="sd">        filename: Name of excel workbook containing the data</span>
<span class="sd">        sheetname: Name of the sheet in the workbook with the data</span>
<span class="sd">    Returns:</span>
<span class="sd">        JR = Joint R matrix of material consumption, list of dataframes</span>
<span class="sd">        materials_used = Names of materials </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">materials</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">sheetname</span><span class="p">)</span>

    <span class="n">ok</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">for</span> <span class="n">lot</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">(</span><span class="n">materials</span><span class="p">,</span><span class="s1">&#39;Finished Product Lot&#39;</span><span class="p">):</span>
        <span class="n">this_lot</span><span class="o">=</span><span class="n">materials</span><span class="p">[</span><span class="n">materials</span><span class="p">[</span><span class="s2">&quot;Finished Product Lot&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">lot</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mt</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">this_lot</span><span class="p">[</span><span class="s1">&#39;Material&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">this_lot</span><span class="p">[</span><span class="s1">&#39;Material Lot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                   <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lot &#39;</span><span class="o">+</span><span class="n">lot</span><span class="o">+</span><span class="s1">&#39; has no Material Lot for &#39;</span><span class="o">+</span><span class="n">mt</span><span class="p">)</span>
                   <span class="n">ok</span><span class="o">=</span><span class="kc">False</span>
                   <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">d</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lot :&#39;</span><span class="o">+</span><span class="n">lot</span><span class="o">+</span><span class="s1">&#39; ratio/qty adds to &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">this_lot</span><span class="p">[</span><span class="s1">&#39;Ratio or Quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="p">))</span>
    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>    
        <span class="n">JR</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">materials_used</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">materials</span><span class="p">,</span><span class="s1">&#39;Material&#39;</span><span class="p">)</span>
        <span class="n">fp_lots</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">materials</span><span class="p">,</span><span class="s1">&#39;Finished Product Lot&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">materials_used</span><span class="p">:</span>
            <span class="n">r_mat</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">mat_lots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="s1">&#39;Material Lot&#39;</span><span class="p">][</span><span class="n">materials</span><span class="p">[</span><span class="s1">&#39;Material&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">lot</span> <span class="ow">in</span> <span class="n">fp_lots</span><span class="p">:</span>
                <span class="n">rvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat_lots</span><span class="p">))</span>
                <span class="n">this_lot_this_mat</span><span class="o">=</span><span class="n">materials</span><span class="p">[(</span><span class="n">materials</span><span class="p">[</span><span class="s2">&quot;Finished Product Lot&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">lot</span><span class="p">)</span> <span class="o">&amp;</span>
                                            <span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="s1">&#39;Material&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">m</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">this_lot_this_mat</span><span class="p">[</span><span class="s1">&#39;Material Lot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                               <span class="n">this_lot_this_mat</span><span class="p">[</span><span class="s1">&#39;Ratio or Quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                    <span class="n">rvec</span><span class="p">[</span><span class="n">mat_lots</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span><span class="o">=</span><span class="n">r</span>
                <span class="n">r_mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rvec</span><span class="p">)</span>    
            <span class="n">r_mat_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_mat</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">mat_lots</span><span class="p">)</span>
            <span class="n">r_mat_pd</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;FPLot&#39;</span><span class="p">,</span><span class="n">fp_lots</span><span class="p">)</span>    
            <span class="n">JR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_mat_pd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JR</span><span class="p">,</span> <span class="n">materials_used</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data needs revision&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span><span class="kc">False</span></div>

    
<div class="viewcode-block" id="isin_ordered_col0">
<a class="viewcode-back" href="../pyphi.html#pyphi.isin_ordered_col0">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">isin_ordered_col0</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">alist</span><span class="p">):</span>
    <span class="n">df_</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">alist</span><span class="p">)]</span>
    <span class="n">df_</span><span class="o">=</span><span class="n">df_</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">df_</span><span class="o">=</span><span class="n">df_</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">alist</span><span class="p">)</span>
    <span class="n">df_</span><span class="o">=</span><span class="n">df_</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df_</span></div>

    
<div class="viewcode-block" id="reconcile_rows">
<a class="viewcode-back" href="../pyphi.html#pyphi.reconcile_rows">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reconcile_rows</span><span class="p">(</span><span class="n">df_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to reconcile observations across multiple dataframes</span>
<span class="sd">     </span>
<span class="sd">     by Salvador Garcia-Munoz </span>
<span class="sd">     (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">     </span>
<span class="sd">     df_list_reconciled = pyphi.reconcile_rows(df_list)</span>
<span class="sd">    </span>
<span class="sd">    Routine to reconcile the observation names in a list of dataframes</span>
<span class="sd">    The returned list of df&#39;s has exacly the same observation names in the same order</span>
<span class="sd">    handy when analyzing  data for TPLS, LPLS and JRPLS</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">all_rows</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">:</span>
        <span class="n">all_rows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">all_rows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_rows</span><span class="p">)</span>    
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">:</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">rows_</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">rows_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">all_rows</span><span class="o">=</span><span class="n">rows_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_df_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">:</span>
        <span class="n">df</span><span class="o">=</span><span class="n">isin_ordered_col0</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">all_rows</span><span class="p">)</span>
        <span class="n">new_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_df_list</span></div>

    
<div class="viewcode-block" id="reconcile_rows_to_columns">
<a class="viewcode-back" href="../pyphi.html#pyphi.reconcile_rows_to_columns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reconcile_rows_to_columns</span><span class="p">(</span><span class="n">df_list_r</span><span class="p">,</span><span class="n">df_list_c</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to reconcile the rows of the dataframes in df_list_r with the</span>
<span class="sd">     columns in the list of dataframes df_list_r</span>
<span class="sd">     </span>
<span class="sd">     by Salvador Garcia-Munoz </span>
<span class="sd">     (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd"> </span>
<span class="sd">     df_list_reconciled_r,df_list_reconciled_c = pyphi.reconcile_rows_to_columns(df_list_r,df_list_c)</span>
<span class="sd">    </span>
<span class="sd">    handy to align X - R datasets for TPLS, LPLS and JRPLS</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    
    <span class="n">df_list_r_o</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">df_list_c_o</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">allids</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">dfr</span><span class="p">,</span><span class="n">dfc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_list_r</span><span class="p">,</span><span class="n">df_list_c</span> <span class="p">):</span>
        <span class="n">all_ids</span>  <span class="o">=</span> <span class="n">dfc</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">all_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dfr</span><span class="p">[</span><span class="n">dfr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">all_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)</span>
        
        <span class="n">all_ids_</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">dfr</span><span class="p">[</span><span class="n">dfr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">dfc</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">all_ids_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">all_ids</span><span class="o">=</span><span class="p">[]</span>         
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_ids_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">all_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                
        <span class="n">dfr_</span> <span class="o">=</span><span class="n">isin_ordered_col0</span><span class="p">(</span><span class="n">dfr</span><span class="p">,</span><span class="n">all_ids</span><span class="p">)</span>
        
        <span class="n">dfc_</span><span class="o">=</span><span class="n">dfc</span><span class="p">[</span><span class="n">all_ids</span><span class="p">]</span>
        <span class="n">dfc_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dfc</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dfc</span><span class="p">[</span><span class="n">dfc</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">df_list_r_o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfr_</span><span class="p">)</span>
        <span class="n">df_list_c_o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfc_</span><span class="p">)</span>
        <span class="n">allids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_list_r_o</span><span class="p">,</span><span class="n">df_list_c_o</span></div>

    
<span class="k">def</span><span class="w"> </span><span class="nf">_Ab_btbinv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">A_not_nan_map</span><span class="p">):</span>
    <span class="c1"># project c = Ab/b&#39;b</span>
    <span class="c1"># A = [i x j]  b=[j x 1] c = [i x 1]</span>
    <span class="n">b_mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">b_mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">b_mat</span><span class="o">*</span><span class="n">A_not_nan_map</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>    

<div class="viewcode-block" id="lpls">
<a class="viewcode-back" href="../pyphi.html#pyphi.lpls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lpls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; LPLS Algorithm per Muteki et. al Chemom.Intell.Lab.Syst.85(2007) 186 – 194</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    lpls_obj = pyphi.lpls(X,R,Y,A)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">         X = [ m x p ] Phys. Prop. DataFrame of             materials x mat. properties</span>
<span class="sd">         R = [ b x m ] Blending ratios DataFrame of         blends    x materials</span>
<span class="sd">         Y = [ b x n ] Product characteristics DataFrame of blends    x prod. properties</span>
<span class="sd">        first column of all dataframes is the observation identifier</span>
<span class="sd">         A = Number of components</span>
<span class="sd">    Returns:</span>
<span class="sd">        lspls_obj: A dictionary with all the LPLS parameters</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidX</span> <span class="o">=</span> <span class="n">obsidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidX</span> <span class="o">=</span> <span class="n">varidX</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">obsidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>    
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">R_</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidR</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidR</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">R_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidR</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidR</span> <span class="o">=</span> <span class="n">obsidR</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidR</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidR</span> <span class="o">=</span> <span class="n">varidR</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidR</span> <span class="o">=</span> <span class="n">varidR</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  
        
    <span class="n">X_</span><span class="p">,</span><span class="n">x_mean</span><span class="p">,</span><span class="n">x_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">R_</span><span class="p">,</span><span class="n">r_mean</span><span class="p">,</span><span class="n">r_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
    
    <span class="c1">#Generate Missing Data Map    </span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">R_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
    <span class="n">not_Rmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">R_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>

    <span class="c1">#use nipals</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.lpls using NIPALS executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>
    <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">Xhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Y_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">R_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">1E-9</span>
    <span class="n">maxit</span><span class="o">=</span><span class="mi">2000</span>

    <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">TSSR</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSRpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#T=[];</span>
    <span class="c1">#P=[];</span>
    <span class="c1">#r2=[];</span>
    <span class="c1">#r2pv=[];</span>
    <span class="c1">#numIT=[];</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="c1"># Select column with largest variance in Y as initial guess</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">Y_</span><span class="p">[:,[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">Y_</span><span class="p">))]]</span>
        <span class="n">Converged</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">num_it</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">Converged</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            
     <span class="c1"># _Ab_btbinv(A,b,A_not_nan_map):</span>
     <span class="c1">#  project c = Ab/b&#39;b</span>

             <span class="c1">#Step 1. h=R&#39;u/u&#39;u</span>
             <span class="n">hi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 1&#39;)</span>
             
             <span class="c1">#Step 2. s = X&#39;h/(h&#39;h)</span>
             <span class="n">si</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 2&#39;)</span>
                   
             <span class="c1">#Normalize s to unit length.</span>
             <span class="n">si</span><span class="o">=</span><span class="n">si</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
             
             <span class="c1">#Step 3. ri= (Xs)/(s&#39;s)</span>
             <span class="n">ri</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 3&#39;)</span>
             <span class="c1">#Step 4. t = Rr/(r&#39;r)</span>
             <span class="n">ti</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 4&#39;)</span>
             <span class="c1">#Step 5 q=Y&#39;t/t&#39;t</span>
             <span class="n">qi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Y_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Ymiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
             
             <span class="c1">#Step 5 un=(Yq)/(q&#39;q)</span>
             <span class="n">un</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">qi</span><span class="p">,</span><span class="n">not_Ymiss</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 5&#39;)</span>
             
             <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">un</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                 
             <span class="k">if</span> <span class="n">num_it</span> <span class="o">&gt;</span> <span class="n">maxit</span><span class="p">:</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                 
             <span class="k">if</span> <span class="n">Converged</span><span class="p">:</span>
                 <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# Iterations for LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num_it</span><span class="p">))</span>
                 <span class="c1"># Calculate P&#39;s for deflation p=R&#39;t/(t&#39;t) </span>
                 <span class="n">pi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 <span class="c1"># Calculate v&#39;s for deflation v=Xr/(r&#39;r) </span>
                 <span class="n">vi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 
                 <span class="c1"># Deflate X leaving missing as zeros (important!)</span>
                 <span class="n">R_</span><span class="o">=</span><span class="p">(</span><span class="n">R_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Rmiss</span>
                 <span class="n">X_</span><span class="o">=</span><span class="p">(</span><span class="n">X_</span><span class="o">-</span> <span class="n">ri</span> <span class="o">@</span> <span class="n">vi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
                 <span class="n">Y_</span><span class="o">=</span><span class="p">(</span><span class="n">Y_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
                 
                 <span class="n">Xhat</span> <span class="o">=</span> <span class="n">Xhat</span> <span class="o">+</span> <span class="n">ri</span> <span class="o">@</span> <span class="n">vi</span><span class="o">.</span><span class="n">T</span>
                 <span class="c1">#print(R_.shape)</span>
                 <span class="c1">#print(X_.shape)</span>
                 <span class="c1">#print(Y_.shape)</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">T</span><span class="o">=</span><span class="n">ti</span>
                     <span class="n">P</span><span class="o">=</span><span class="n">pi</span>
                     <span class="n">S</span><span class="o">=</span><span class="n">si</span>
                     <span class="n">U</span><span class="o">=</span><span class="n">un</span>
                     <span class="n">Q</span><span class="o">=</span><span class="n">qi</span>
                     <span class="n">H</span><span class="o">=</span><span class="n">hi</span>
                     <span class="n">V</span><span class="o">=</span><span class="n">vi</span>
                     <span class="n">Rscores</span> <span class="o">=</span> <span class="n">ri</span>
                     
                     <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                     <span class="n">r2Xpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                     <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                     <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                     <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2R</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSR</span>
                     <span class="n">r2Rpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSRpv</span>
                     <span class="n">r2Rpv</span> <span class="o">=</span> <span class="n">r2Rpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                                 
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                     <span class="n">U</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">un</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                     <span class="n">P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">pi</span><span class="p">))</span>   
                     <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span><span class="n">qi</span><span class="p">))</span>
                     <span class="n">S</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">S</span><span class="p">,</span><span class="n">si</span><span class="p">))</span>
                     <span class="n">H</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">hi</span><span class="p">))</span>
                     <span class="n">V</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">V</span><span class="p">,</span><span class="n">vi</span><span class="p">))</span>
                     <span class="n">Rscores</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Rscores</span><span class="p">,</span><span class="n">ri</span> <span class="p">))</span>
                        
                     <span class="n">r2X_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                     <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span>
                     <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2X</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="n">r2X_</span><span class="p">))</span>
                     <span class="n">r2Xpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">r2Xpv_</span><span class="p">))</span>
       
                     <span class="n">r2Y_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                     <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                     <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="n">r2Ypv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2Y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="n">r2Y_</span><span class="p">))</span>
                     <span class="n">r2Ypv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">r2Ypv_</span><span class="p">))</span>
                     
                     <span class="n">r2R_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSR</span>
                     <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSRpv</span>
                     <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="n">r2Rpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2R</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2R</span><span class="p">,</span><span class="n">r2R_</span><span class="p">))</span>
                     <span class="n">r2Rpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Rpv</span><span class="p">,</span><span class="n">r2Rpv_</span><span class="p">))</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">num_it</span> <span class="o">=</span> <span class="n">num_it</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="n">ui</span> <span class="o">=</span> <span class="n">un</span>
            
        <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">numIT</span><span class="o">=</span><span class="n">num_it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numIT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">numIT</span><span class="p">,</span><span class="n">num_it</span><span class="p">))</span>
    <span class="n">Xhat</span><span class="o">=</span><span class="n">Xhat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_std</span><span class="p">,(</span><span class="n">Xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_mean</span><span class="p">,(</span><span class="n">Xhat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>      
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2R</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Rpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Rpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Rpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">)</span>
    <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
    <span class="n">r2rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2R</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LV #     Eig       R2X       sum(R2X)   R2R       sum(R2R)   R2Y       sum(R2Y)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2R</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2rc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d3</span><span class="o">=</span><span class="n">r2rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d4</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2X</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2R</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>   
        
    <span class="n">lpls_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="n">S</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">:</span><span class="n">V</span><span class="p">,</span><span class="s1">&#39;Rscores&#39;</span><span class="p">:</span><span class="n">Rscores</span><span class="p">,</span>
              <span class="s1">&#39;r2x&#39;</span><span class="p">:</span><span class="n">r2X</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2Xpv</span><span class="p">,</span><span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">,</span>
              <span class="s1">&#39;r2y&#39;</span><span class="p">:</span><span class="n">r2Y</span><span class="p">,</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">:</span><span class="n">r2Ypv</span><span class="p">,</span><span class="s1">&#39;my&#39;</span><span class="p">:</span><span class="n">y_mean</span><span class="p">,</span><span class="s1">&#39;sy&#39;</span><span class="p">:</span><span class="n">y_std</span><span class="p">,</span>
              <span class="s1">&#39;r2r&#39;</span><span class="p">:</span><span class="n">r2R</span><span class="p">,</span><span class="s1">&#39;r2rpv&#39;</span><span class="p">:</span><span class="n">r2Rpv</span><span class="p">,</span><span class="s1">&#39;mr&#39;</span><span class="p">:</span><span class="n">r_mean</span><span class="p">,</span><span class="s1">&#39;sr&#39;</span><span class="p">:</span><span class="n">r_std</span><span class="p">,</span>
              <span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">Xhat</span><span class="p">}</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
        <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidY</span>
       <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidY</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidR</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidR&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidR</span>
       <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;varidR&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidR</span>  
          
    <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">lpls_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
    <span class="n">n</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
    <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>     
    <span class="n">speX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">speX_lim95</span><span class="p">,</span><span class="n">speX_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speX</span><span class="p">)</span>
    <span class="n">speY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">speY_lim95</span><span class="p">,</span><span class="n">speY_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speY</span><span class="p">)</span>
    <span class="n">speR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">speR_lim95</span><span class="p">,</span><span class="n">speR_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speR</span><span class="p">)</span>
    
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">T2</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim99</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim95</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speX</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim99</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim95</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speY&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speY</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim99</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim95</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speR&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speR</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speR_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speR_lim99</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;speR_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speR_lim95</span>
    
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;Ss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">)</span> <span class="c1">#trick to plot the LPLS does not really have Ws</span>
    <span class="c1">#Ws=W @ np.linalg.pinv(P.T @ W)</span>
    <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;lpls&#39;</span>
    <span class="k">return</span> <span class="n">lpls_obj</span>       </div>

    
<div class="viewcode-block" id="lpls_pred">
<a class="viewcode-back" href="../pyphi.html#pyphi.lpls_pred">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lpls_pred</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">lpls_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to evaluate a new observation for LPLS</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    Do a prediction with an LPLS model</span>
<span class="sd">    pred = pyphi.lpls_pred(rnew,lpls_obj)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        rnew: np.array, list or dataframe with elements of rnew</span>
<span class="sd">              if multiple rows are passed, then multiple predictions are done</span>
<span class="sd">        </span>
<span class="sd">        lpls_obj: LPLS object built with pyphi.lpls routine</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        pred: A dictionary {&#39;Tnew&#39;:tnew,&#39;Yhat&#39;:yhat,&#39;speR&#39;:sper}   </span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">rnew__</span><span class="o">=</span><span class="p">[</span><span class="n">rnew</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">rnew__</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rnew</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">rnew__</span><span class="o">=</span><span class="n">rnew</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">tnew</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sper</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">rnew_</span> <span class="ow">in</span> <span class="n">rnew__</span><span class="p">:</span>
        <span class="n">rnew_</span><span class="o">=</span><span class="p">(</span><span class="n">rnew_</span><span class="o">-</span><span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;mr&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;sr&#39;</span><span class="p">]</span>
        <span class="n">rnew_</span><span class="o">=</span><span class="n">rnew_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ti</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ti_</span> <span class="o">=</span><span class="p">(</span> <span class="n">rnew_</span><span class="o">.</span><span class="n">T</span><span class="nd">@lpls_obj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span><span class="o">/</span>             
                 <span class="p">(</span><span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="nd">@lpls_obj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]))</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ti_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux</span><span class="o">=</span><span class="n">ti_</span><span class="o">*</span><span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span>
            <span class="n">rnew_</span><span class="o">=</span><span class="n">rnew_</span><span class="o">-</span><span class="n">aux</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tnew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span>
        <span class="n">sper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rnew_</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">tnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tnew</span><span class="p">)</span>
    <span class="n">sper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sper</span><span class="p">)</span>
    <span class="n">yhat</span> <span class="o">=</span> <span class="n">tnew</span><span class="nd">@lpls_obj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">yhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">yhat</span> <span class="o">*</span> <span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">lpls_obj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">]</span>
    <span class="n">preds</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span><span class="s1">&#39;Yhat&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">,</span><span class="s1">&#39;speR&#39;</span><span class="p">:</span><span class="n">sper</span><span class="p">}</span>     
    <span class="k">return</span> <span class="n">preds</span></div>


<div class="viewcode-block" id="jrpls">
<a class="viewcode-back" href="../pyphi.html#pyphi.jrpls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">jrpls</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span><span class="n">Ri</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;    JRPLS Algorithm per Garcia-Munoz Chemom.Intel.Lab.Syst., 133, pp.49-62.</span>

<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    jrpls_obj = pyphi.jrpls(Xi,Ri,Y,A)</span>
<span class="sd">    Args:</span>
<span class="sd">         X =  Phys. Prop. dictionary of Dataframes of materials_i x mat. properties</span>
<span class="sd">             X = {&#39;MatA&#39;:df_with_props_for_mat_A (one row per lot of MatA, one col per property),</span>
<span class="sd">                  &#39;MatB&#39;:df_with_props_for_mat_B (one row per lot of MatB, one col per property)}</span>
<span class="sd">             </span>
<span class="sd">         R = Blending ratios dictionary of Dataframes of  blends x materials_i</span>
<span class="sd">             R = {&#39;MatA&#39;: df_with_ratios_of_lots_of_A_used_per_blend,</span>
<span class="sd">                  &#39;MatB&#39;: df_with_ratios_of_lots_of_B_used_per_blend,</span>
<span class="sd">                  } </span>
<span class="sd">         Rows of X[i] must correspond to Columns of R[i] </span>
<span class="sd">             </span>
<span class="sd">         Y = [ b x n ]   Product characteristics dataframe of blends x prod. properties</span>
<span class="sd">         </span>
<span class="sd">         first column of all dataframes is the observation identifier</span>
<span class="sd">     </span>
<span class="sd">    Returns:</span>
<span class="sd">        jrpls_obj: A dictionary with all the parameters for the JRPLS model </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">X</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">varidX</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">obsidX</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">materials</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">Xi</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Xi</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">Xaux</span><span class="o">=</span><span class="n">Xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>   
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xaux</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="n">Xaux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">obsidX_</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xaux</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xaux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">obsidX_</span> <span class="o">=</span> <span class="n">Xaux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">obsidX_</span> <span class="o">=</span> <span class="n">obsidX_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="n">Xaux</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="n">varidX_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="n">varidX_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">varidX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidX_</span><span class="p">)</span>
        <span class="n">obsidX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obsidX_</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">obsidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>    
 
    <span class="n">R</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">varidR</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">obsidR</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">:</span>  
        <span class="n">Raux</span><span class="o">=</span><span class="n">Ri</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Raux</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">R_</span><span class="o">=</span><span class="n">Raux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">obsidR_</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Raux</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">R_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Raux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">obsidR_</span> <span class="o">=</span> <span class="n">Raux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">obsidR_</span> <span class="o">=</span> <span class="n">obsidR_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="n">Raux</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="n">varidR_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="n">varidR_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidR_</span><span class="p">)</span>
        <span class="n">obsidR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obsidR_</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        
    <span class="n">x_mean</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_std</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jr_scale</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_mean</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_std</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">not_Rmiss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Xhat</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSX</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSXpv</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSR</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSRpv</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X__</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">R__</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">X_i</span><span class="p">,</span><span class="n">R_i</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">R</span><span class="p">):</span>
        <span class="n">X_</span><span class="p">,</span> <span class="n">x_mean_</span><span class="p">,</span> <span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_i</span><span class="p">)</span>
        <span class="n">R_</span><span class="p">,</span> <span class="n">r_mean_</span><span class="p">,</span> <span class="n">r_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">R_i</span><span class="p">)</span>
        
        <span class="n">jr_scale_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">jr_scale_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">X_</span> <span class="o">/</span> <span class="n">jr_scale_</span>
        
        <span class="n">x_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_mean_</span> <span class="p">)</span>
        <span class="n">x_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">x_std_</span>  <span class="p">)</span>
        <span class="n">jr_scale</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">jr_scale_</span><span class="p">)</span>
        <span class="n">r_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">r_mean_</span> <span class="p">)</span>
        <span class="n">r_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">r_std_</span>  <span class="p">)</span>
        
        <span class="n">X_nan_map</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss_</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">R_nan_map</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        <span class="n">not_Rmiss_</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">R_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">not_Xmiss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_Xmiss_</span><span class="p">)</span>
        <span class="n">not_Rmiss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_Rmiss_</span><span class="p">)</span>
        
        <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">R_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        <span class="n">Xhat_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">X__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">R__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        <span class="n">Xhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xhat_</span><span class="p">)</span>
        
        <span class="n">TSSX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>       <span class="p">)</span>
        <span class="n">TSSXpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">TSSR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>       <span class="p">)</span>
        <span class="n">TSSRpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
       
    <span class="n">X</span><span class="o">=</span><span class="n">X__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">R</span><span class="o">=</span><span class="n">R__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Y_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#use nipals</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.jrpls using NIPALS executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>

    <span class="n">epsilon</span><span class="o">=</span><span class="mf">1E-9</span>
    <span class="n">maxit</span><span class="o">=</span><span class="mi">2000</span>    

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="c1"># Select column with largest variance in Y as initial guess</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">Y_</span><span class="p">[:,[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">Y_</span><span class="p">))]]</span>
        <span class="n">Converged</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">num_it</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">Converged</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            
     <span class="c1"># _Ab_btbinv(A,b,A_not_nan_map):</span>
     <span class="c1">#  project c = Ab/b&#39;b</span>

             <span class="c1">#Step 1. h=R&#39;u/u&#39;u</span>
             <span class="n">hi</span><span class="o">=</span><span class="p">[]</span>
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">R_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                 <span class="n">hi_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 <span class="n">hi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hi_</span><span class="p">)</span>                 
             <span class="c1">#print(&#39;step 1&#39;)</span>
             <span class="n">si</span><span class="o">=</span><span class="p">[]</span>
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">X_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                 <span class="c1">#Step 2. s = X&#39;h/(h&#39;h) </span>
                 <span class="n">si_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 <span class="n">si</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si_</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 2&#39;)</span>
             
             <span class="c1">#Normalize joint s to unit length.</span>
             <span class="n">js</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">si</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>  <span class="c1">#flattening list of lists</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">si</span><span class="p">)):</span>
                 <span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>      

             <span class="n">ri</span><span class="o">=</span><span class="p">[]</span>
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">X_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                 <span class="c1">#Step 3. ri= (Xs)/(s&#39;s)</span>
                 <span class="n">ri_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                 <span class="n">ri</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ri_</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 3&#39;)</span>

             <span class="c1">#Calculating the Joint-r and Joint-R (hence the name of the method)</span>
             <span class="n">jr</span><span class="o">=</span><span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ri</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
             <span class="n">jr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
             
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">R_</span><span class="o">=</span><span class="n">r_</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">R_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R_</span><span class="p">,</span><span class="n">r_</span><span class="p">))</span>
                     
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r_miss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">not_Rmiss</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">not_Rmiss_</span><span class="o">=</span><span class="n">r_miss</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">not_Rmiss_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">not_Rmiss_</span><span class="p">,</span><span class="n">r_miss</span><span class="p">))</span>
                             
             <span class="c1">#Step 4. t = Rr/(r&#39;r)</span>
             <span class="n">ti</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="p">,</span><span class="n">jr</span><span class="p">,</span><span class="n">not_Rmiss_</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 4&#39;)</span>
             
             <span class="c1">#Step 5 q=Y&#39;t/t&#39;t</span>
             <span class="n">qi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Y_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Ymiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
             
             <span class="c1">#Step 5 un=(Yq)/(q&#39;q)</span>
             <span class="n">un</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">qi</span><span class="p">,</span><span class="n">not_Ymiss</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 5&#39;)</span>
             
             <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">un</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                 
             <span class="k">if</span> <span class="n">num_it</span> <span class="o">&gt;</span> <span class="n">maxit</span><span class="p">:</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                 
             <span class="k">if</span> <span class="n">Converged</span><span class="p">:</span>
                 <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# Iterations for LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num_it</span><span class="p">))</span>
                 <span class="n">pi</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">R_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                     <span class="c1"># Calculate P&#39;s for deflation p=R&#39;t/(t&#39;t) </span>
                     <span class="n">pi_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                     <span class="n">pi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi_</span><span class="p">)</span>
                 <span class="n">vi</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">X_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                     <span class="c1"># Calculate v&#39;s for deflation v=Xr/(r&#39;r) </span>
                     <span class="n">vi_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                     <span class="n">vi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vi_</span><span class="p">)</span>
                 
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>    
                     <span class="c1"># Deflate X leaving missing as zeros (important!)</span>
                     <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Rmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                     <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">vi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                     <span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">vi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                 <span class="n">Y_</span><span class="o">=</span><span class="p">(</span><span class="n">Y_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
                 
                 
                 <span class="c1">#print(R_.shape)</span>
                 <span class="c1">#print(X_.shape)</span>
                 <span class="c1">#print(Y_.shape)</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">T</span><span class="o">=</span><span class="n">ti</span>
                     <span class="n">P</span><span class="o">=</span><span class="n">pi</span>
                     <span class="n">S</span><span class="o">=</span><span class="n">si</span>
                     <span class="n">U</span><span class="o">=</span><span class="n">un</span>
                     <span class="n">Q</span><span class="o">=</span><span class="n">qi</span>
                     <span class="n">H</span><span class="o">=</span><span class="n">hi</span>
                     <span class="n">V</span><span class="o">=</span><span class="n">vi</span>
                     <span class="n">Rscores</span> <span class="o">=</span> <span class="n">ri</span>
                     
                     <span class="n">r2X</span><span class="o">=</span><span class="p">[]</span>
                     <span class="n">r2Xpv</span><span class="o">=</span><span class="p">[]</span>
                     <span class="n">r2R</span><span class="o">=</span><span class="p">[]</span>
                     <span class="n">r2Rpv</span><span class="o">=</span><span class="p">[]</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
                         <span class="n">r2X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                         <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Xpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                         <span class="n">r2R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSR</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                         <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSRpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Rpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">r2Rpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                                          
                     <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                     <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                     <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     

                                 
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                     <span class="n">U</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">un</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                     <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span><span class="n">qi</span><span class="p">))</span>
                     
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)):</span>
                         <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> 
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)):</span>    
                         <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)):</span>    
                         <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">hi</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">)):</span>    
                         <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vi</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Rscores</span><span class="p">)):</span>    
                         <span class="n">Rscores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Rscores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>

                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>   
                         <span class="n">r2X_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                         <span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2X_</span><span class="p">))</span>
                         <span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2Xpv_</span><span class="p">))</span>
                         
                         <span class="n">r2R_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSRpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="n">r2Rpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                         <span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2R_</span><span class="p">))</span>
                         <span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2Rpv_</span><span class="p">))</span>
                         
       
                     <span class="n">r2Y_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                     <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                     <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="n">r2Ypv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2Y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="n">r2Y_</span><span class="p">))</span>
                     <span class="n">r2Ypv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">r2Ypv_</span><span class="p">))</span>
                     

             <span class="k">else</span><span class="p">:</span>
                 <span class="n">num_it</span> <span class="o">=</span> <span class="n">num_it</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="n">ui</span> <span class="o">=</span> <span class="n">un</span>
            
        <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">numIT</span><span class="o">=</span><span class="n">num_it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numIT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">numIT</span><span class="p">,</span><span class="n">num_it</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xhat</span><span class="p">)):</span>        
        <span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_std</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_mean</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>      
 
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r2xc</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">r2rc</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>    
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r2Xpv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">r2xpv_all</span><span class="o">=</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2xpv_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r2xpv_all</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

    
        <span class="n">r2xc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">r2rc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    
    <span class="n">eigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
    <span class="n">r2rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2rc</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2xc</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r2x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2X</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> 
    <span class="n">r2r</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2R</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> 
    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LV #     Eig       R2X       sum(R2X)   R2R       sum(R2R)   R2Y       sum(R2Y)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eigs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2x</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2r</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2rc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">d1</span><span class="o">=</span><span class="n">eigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d2</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d3</span><span class="o">=</span><span class="n">r2rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d4</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:6.3f}</span><span class="s2">    </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">r2x</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span><span class="n">r2r</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>   
        
    <span class="n">jrpls_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="n">S</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">:</span><span class="n">V</span><span class="p">,</span><span class="s1">&#39;Rscores&#39;</span><span class="p">:</span><span class="n">Rscores</span><span class="p">,</span>
              <span class="s1">&#39;r2xi&#39;</span><span class="p">:</span><span class="n">r2X</span><span class="p">,</span><span class="s1">&#39;r2xpvi&#39;</span><span class="p">:</span><span class="n">r2Xpv</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2xpv_all</span><span class="p">,</span>
              <span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">,</span>
              <span class="s1">&#39;r2y&#39;</span><span class="p">:</span><span class="n">r2Y</span><span class="p">,</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">:</span><span class="n">r2Ypv</span><span class="p">,</span><span class="s1">&#39;my&#39;</span><span class="p">:</span><span class="n">y_mean</span><span class="p">,</span><span class="s1">&#39;sy&#39;</span><span class="p">:</span><span class="n">y_std</span><span class="p">,</span>
              <span class="s1">&#39;r2ri&#39;</span><span class="p">:</span><span class="n">r2R</span><span class="p">,</span><span class="s1">&#39;r2rpvi&#39;</span><span class="p">:</span><span class="n">r2Rpv</span><span class="p">,</span><span class="s1">&#39;mr&#39;</span><span class="p">:</span><span class="n">r_mean</span><span class="p">,</span><span class="s1">&#39;sr&#39;</span><span class="p">:</span><span class="n">r_std</span><span class="p">,</span>
              <span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">Xhat</span><span class="p">,</span><span class="s1">&#39;materials&#39;</span><span class="p">:</span><span class="n">materials</span><span class="p">}</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidXi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
        <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;varidXi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
    
    <span class="n">varidXall</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">materials</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">varidXall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">materials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidXall</span>    
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidR</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidRi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidR</span>
       <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;varidRi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidR</span>  
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidY</span>
       <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidY</span>    
       
    <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">jrpls_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
    <span class="n">n</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
    <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>    
    
    <span class="n">speX</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speR</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speX_lim95</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speX_lim99</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speR_lim95</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speR_lim99</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">speX</span> <span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">aux_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speX_lim95_</span><span class="p">,</span><span class="n">speX_lim99_</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">aux_</span><span class="p">)</span>
        <span class="n">speX_lim95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speX_lim95_</span><span class="p">)</span>
        <span class="n">speX_lim99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speX_lim99_</span><span class="p">)</span>
        
        <span class="n">speR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">aux_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speR_lim95_</span><span class="p">,</span><span class="n">speR_lim99_</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">aux_</span><span class="p">)</span>
        <span class="n">speR_lim95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speR_lim95_</span><span class="p">)</span>
        <span class="n">speR_lim99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speR_lim99_</span><span class="p">)</span>
        
    <span class="n">speY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">speY_lim95</span><span class="p">,</span><span class="n">speY_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speY</span><span class="p">)</span>
    
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">T2</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim99</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim95</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speX</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim99</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim95</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speY&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speY</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim99</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim95</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speR&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speR</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speR_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speR_lim99</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;speR_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speR_lim95</span>
    
    <span class="n">Wsi</span><span class="o">=</span> <span class="p">[]</span>
    <span class="n">Ws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)):</span>
        <span class="n">Wsi</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Ws</span><span class="o">=</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ws</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ws</span><span class="p">,</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>    
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;Ssi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Wsi</span> <span class="c1">#trick to plot the JRPLS/LPLS does not really have Ws</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;Ss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ws</span> <span class="c1">#trick to plot the JRPLS/LPLS does not really have Ws</span>
    <span class="c1">#Ws=W @ np.linalg.pinv(P.T @ W)</span>
    <span class="n">jrpls_obj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;jrpls&#39;</span>
    <span class="k">return</span> <span class="n">jrpls_obj</span>       </div>


     
<div class="viewcode-block" id="jrpls_pred">
<a class="viewcode-back" href="../pyphi.html#pyphi.jrpls_pred">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">jrpls_pred</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">jrplsobj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Routine to produce the prediction for a new observation of Ri in a JRPLS model</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    </span>
<span class="sd">    preds = pyphi.jrpls_pred(rnew,jrplsobj)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        rnew: A dictionary with the format: </span>
<span class="sd">            rnew={ </span>
<span class="sd">                &#39;matid&#39;:[(lotid,rvalue )],</span>
<span class="sd">                </span>
<span class="sd">                }</span>
<span class="sd">            </span>
<span class="sd">            for example, a prediction for the scenario:</span>
<span class="sd">                </span>
<span class="sd">        material    lot to use  rvalue       </span>
<span class="sd">        API	        A0129	    0.5</span>
<span class="sd">        Lactose	    Lac0003   	0.1</span>
<span class="sd">        Lactose     Lac1010     0.2</span>
<span class="sd">        MgSt	        M0012	    0.02</span>
<span class="sd">        MCC      	MCC0017	    0.18</span>
<span class="sd">        </span>
<span class="sd">        would be encoded like:</span>
<span class="sd">            </span>
<span class="sd">        rnew={</span>
<span class="sd">            &#39;API&#39;:[(&#39;A0129&#39;,0.5)],</span>
<span class="sd">            &#39;Lactose&#39;:[(&#39;Lac0003&#39;,0.1 ),(&#39;Lac1010&#39;,0.2 )],</span>
<span class="sd">            &#39;MgSt&#39;:[(&#39;M0012&#39;,0.02)],</span>
<span class="sd">            &#39;MCC&#39;:[(&#39;MCC0017&#39;,0.18)],</span>
<span class="sd">            }    </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        preds a dictionary of the form:</span>
<span class="sd">            </span>
<span class="sd">            preds ={&#39;Tnew&#39;:tnew,&#39;Yhat&#39;:yhat,&#39;speR&#39;:sper} </span>
<span class="sd">            </span>
<span class="sd">            where speR has the speR per each material</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">ok</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="c1">#check dimensions</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>     
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">mr</span><span class="p">,</span><span class="n">sr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;mr&#39;</span><span class="p">],</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;sr&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">ok</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">rnew_</span><span class="o">=</span><span class="n">r</span>
                <span class="n">mr_</span><span class="o">=</span><span class="n">mr</span>
                <span class="n">sr_</span><span class="o">=</span><span class="n">sr</span>
                <span class="n">Rscores</span> <span class="o">=</span> <span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">P</span>       <span class="o">=</span> <span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rnew_</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rnew_</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>    
                <span class="n">mr_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mr_</span><span class="p">,</span><span class="n">mr</span><span class="p">))</span>
                <span class="n">sr_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">sr_</span><span class="p">,</span><span class="n">sr</span><span class="p">))</span>
                <span class="n">Rscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Rscores</span><span class="p">,</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>
                <span class="n">P</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="c1">#re-arrange </span>
        <span class="n">ok</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">rnew_</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;*&#39;</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rnew</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">ri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;mr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">rnew</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;varidRi&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">ri</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">=</span><span class="n">r</span>
            <span class="n">rnew_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ri</span>
        
        <span class="n">preds</span><span class="o">=</span><span class="n">jrpls_pred</span><span class="p">(</span><span class="n">rnew_</span><span class="p">,</span><span class="n">jrplsobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preds</span>
         
    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>  
        <span class="n">bkzeros</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">selmat</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">]):</span>
            <span class="n">frontzeros</span><span class="o">=</span><span class="n">Rscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">bkzeros</span><span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bkzeros</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span> <span class="n">frontzeros</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
            <span class="n">bkzeros</span><span class="o">+=</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">selmat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
        <span class="n">tnew</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">sper</span><span class="o">=</span><span class="p">[]</span>
       
        <span class="n">rnew_</span><span class="o">=</span><span class="p">(</span><span class="n">rnew_</span><span class="o">-</span><span class="n">mr_</span><span class="p">)</span><span class="o">/</span><span class="n">sr_</span>
        <span class="n">rnew_</span><span class="o">=</span><span class="n">rnew_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ti</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="n">ti_</span> <span class="o">=</span><span class="p">(</span> <span class="n">rnew_</span><span class="o">.</span><span class="n">T</span><span class="nd">@Rscores</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">/</span>             
                 <span class="p">(</span><span class="n">Rscores</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="nd">@Rscores</span><span class="p">[:,</span><span class="n">a</span><span class="p">]))</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ti_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux</span><span class="o">=</span><span class="n">ti_</span><span class="o">*</span><span class="n">P</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span>
            <span class="n">rnew_</span><span class="o">=</span><span class="n">rnew_</span><span class="o">-</span><span class="n">aux</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span>
        <span class="n">sper</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">selmat</span><span class="p">:</span>
            <span class="n">sper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rnew_</span><span class="p">[</span><span class="n">row</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">tnew</span><span class="nd">@jrplsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">yhat</span> <span class="o">*</span> <span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">jrplsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">]</span>
        <span class="n">preds</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span><span class="s1">&#39;Yhat&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">,</span><span class="s1">&#39;speR&#39;</span><span class="p">:</span><span class="n">sper</span><span class="p">}</span>     
        <span class="k">return</span> <span class="n">preds</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;dimensions of rnew did not macth model&#39;</span></div>

    
<div class="viewcode-block" id="tpls">
<a class="viewcode-back" href="../pyphi.html#pyphi.tpls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tpls</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span><span class="n">Ri</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; TPLS Algorithm per Garcia-Munoz Chemom.Intel.Lab.Syst., 133, pp.49-62.</span>

<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>

<span class="sd">     tpls_obj = pyphi.tpls(Xi,Ri,Z,Y,A)</span>
<span class="sd">    Args:</span>
<span class="sd">         X = Phys. Prop. dictionary of Dataframes of materials_i x mat. properties</span>
<span class="sd">             X = {&#39;MatA&#39;:df_with_props_for_mat_A (one row per lot of MatA, one col per property),</span>
<span class="sd">                  &#39;MatB&#39;:df_with_props_for_mat_B (one row per lot of MatB, one col per property)}</span>
<span class="sd">             </span>
<span class="sd">         R =  Blending ratios dictionary of Dataframes of  blends x materials_i</span>
<span class="sd">             R = {&#39;MatA&#39;: df_with_ratios_of_lots_of_A_used_per_blend,</span>
<span class="sd">                  &#39;MatB&#39;: df_with_ratios_of_lots_of_B_used_per_blend,</span>
<span class="sd">                  } </span>
<span class="sd">         Rows of X[i] must correspond to Columns of R[i] </span>
<span class="sd">             </span>
<span class="sd">         Y = [ b x n ]   Product characteristics dataframe of blends x prod. properties</span>
<span class="sd">         </span>
<span class="sd">         Z = [b x p]  Process conditions dataframe of  blends x process variables</span>
<span class="sd">         </span>
<span class="sd">         first column of all dataframes is the observation identifier</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tpls_obj: A dictionary with all the parameters for the TPLS model</span>
<span class="sd">         </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">X</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">varidX</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">obsidX</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">materials</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">Xi</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Xi</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">Xaux</span><span class="o">=</span><span class="n">Xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>   
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xaux</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="n">Xaux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">obsidX_</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Xaux</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xaux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">obsidX_</span> <span class="o">=</span> <span class="n">Xaux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">obsidX_</span> <span class="o">=</span> <span class="n">obsidX_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="n">Xaux</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="n">varidX_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">varidX_</span> <span class="o">=</span> <span class="n">varidX_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">varidX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidX_</span><span class="p">)</span>
        <span class="n">obsidX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obsidX_</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidY</span> <span class="o">=</span> <span class="n">obsidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidY</span> <span class="o">=</span> <span class="n">varidY</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>    

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Z_</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obsidZ</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">varidZ</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Z_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">obsidZ</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">obsidZ</span> <span class="o">=</span> <span class="n">obsidZ</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidZ</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">varidZ</span> <span class="o">=</span> <span class="n">varidZ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">varidZ</span> <span class="o">=</span> <span class="n">varidZ</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>      
    
    <span class="n">R</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">varidR</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">obsidR</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">materials</span><span class="p">:</span>  
        <span class="n">Raux</span><span class="o">=</span><span class="n">Ri</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Raux</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">R_</span><span class="o">=</span><span class="n">Raux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">obsidR_</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Raux</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">R_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Raux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">obsidR_</span> <span class="o">=</span> <span class="n">Raux</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">obsidR_</span> <span class="o">=</span> <span class="n">obsidR_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="n">Raux</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="n">varidR_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">varidR_</span> <span class="o">=</span> <span class="n">varidR_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">varidR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varidR_</span><span class="p">)</span>
        <span class="n">obsidR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obsidR_</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        
    <span class="n">x_mean</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_std</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jr_scale</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_mean</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_std</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">not_Rmiss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Xhat</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSX</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSXpv</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSR</span>      <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TSSRpv</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X__</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">R__</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">X_i</span><span class="p">,</span><span class="n">R_i</span> <span class="ow">in</span> <span class="nb">zip</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">R</span><span class="p">):</span>
        <span class="n">X_</span><span class="p">,</span> <span class="n">x_mean_</span><span class="p">,</span> <span class="n">x_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">X_i</span><span class="p">)</span>
        <span class="n">R_</span><span class="p">,</span> <span class="n">r_mean_</span><span class="p">,</span> <span class="n">r_std_</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">R_i</span><span class="p">)</span>
        
        <span class="n">jr_scale_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">jr_scale_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">X_</span> <span class="o">=</span> <span class="n">X_</span> <span class="o">/</span> <span class="n">jr_scale_</span>
        
        <span class="n">x_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_mean_</span> <span class="p">)</span>
        <span class="n">x_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">x_std_</span>  <span class="p">)</span>
        <span class="n">jr_scale</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">jr_scale_</span><span class="p">)</span>
        <span class="n">r_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">r_mean_</span> <span class="p">)</span>
        <span class="n">r_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">r_std_</span>  <span class="p">)</span>
        
        <span class="n">X_nan_map</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">not_Xmiss_</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">R_nan_map</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        <span class="n">not_Rmiss_</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">R_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">not_Xmiss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_Xmiss_</span><span class="p">)</span>
        <span class="n">not_Rmiss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_Rmiss_</span><span class="p">)</span>
        
        <span class="n">X_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">R_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        <span class="n">Xhat_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">X__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
        <span class="n">R__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_</span><span class="p">)</span>
        <span class="n">Xhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xhat_</span><span class="p">)</span>
        
        <span class="n">TSSX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>       <span class="p">)</span>
        <span class="n">TSSXpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">TSSR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>       <span class="p">)</span>
        <span class="n">TSSRpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
       
    <span class="n">X</span><span class="o">=</span><span class="n">X__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">R</span><span class="o">=</span><span class="n">R__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">Y_</span><span class="p">,</span><span class="n">y_mean</span><span class="p">,</span><span class="n">y_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">Y_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Y_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Y_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
    <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">Z_</span><span class="p">,</span><span class="n">z_mean</span><span class="p">,</span><span class="n">z_std</span> <span class="o">=</span> <span class="n">meancenterscale</span><span class="p">(</span><span class="n">Z_</span><span class="p">)</span>
    <span class="n">Z_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Z_</span><span class="p">)</span>
    <span class="n">not_Zmiss</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">Z_nan_map</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Z_</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Z_</span><span class="p">)</span>
    <span class="n">TSSZ</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSZpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#use nipals</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi.tpls using NIPALS executed on: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="p">)</span>

    <span class="n">epsilon</span><span class="o">=</span><span class="mf">1E-9</span>
    <span class="n">maxit</span><span class="o">=</span><span class="mi">2000</span>    

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="c1"># Select column with largest variance in Y as initial guess</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">Y_</span><span class="p">[:,[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">std</span><span class="p">(</span><span class="n">Y_</span><span class="p">))]]</span>
        <span class="n">Converged</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">num_it</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">Converged</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            
     <span class="c1"># _Ab_btbinv(A,b,A_not_nan_map):</span>
     <span class="c1">#  project c = Ab/b&#39;b</span>

             <span class="c1">#Step 2. h=R&#39;u/u&#39;u</span>
             <span class="n">hi</span><span class="o">=</span><span class="p">[]</span>
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">R_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                 <span class="n">hi_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 <span class="n">hi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hi_</span><span class="p">)</span>                 
             <span class="c1">#print(&#39;step 2&#39;)</span>
             <span class="n">si</span><span class="o">=</span><span class="p">[]</span>
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">X_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                 <span class="c1">#Step 3. s = X&#39;h/(h&#39;h) </span>
                 <span class="n">si_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 <span class="n">si</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si_</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 3&#39;)</span>
             
             <span class="c1">#Step 4 Normalize joint s to unit length.</span>
             <span class="n">js</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">si</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>  <span class="c1">#flattening list of lists</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">si</span><span class="p">)):</span>
                 <span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>      

             <span class="c1">#Step 5</span>
             <span class="n">ri</span><span class="o">=</span><span class="p">[]</span>
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">X_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                 <span class="c1">#Step 5. ri= (Xs)/(s&#39;s)</span>
                 <span class="n">ri_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                 <span class="n">ri</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ri_</span><span class="p">)</span>
             
             <span class="c1">#Step 6  </span>
             <span class="c1">#Calculating the Joint-r and Joint-R (hence the name of the method)</span>
             <span class="n">jr</span><span class="o">=</span><span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ri</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
             <span class="n">jr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
             
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">R_</span><span class="o">=</span><span class="n">r_</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">R_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R_</span><span class="p">,</span><span class="n">r_</span><span class="p">))</span>
                     
             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r_miss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">not_Rmiss</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">not_Rmiss_</span><span class="o">=</span><span class="n">r_miss</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">not_Rmiss_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">not_Rmiss_</span><span class="p">,</span><span class="n">r_miss</span><span class="p">))</span>
                             
             <span class="n">t_rx</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="p">,</span><span class="n">jr</span><span class="p">,</span><span class="n">not_Rmiss_</span><span class="p">)</span>
             <span class="c1">#print(&#39;step 6&#39;)</span>
             
             <span class="c1">#Step 7</span>
             <span class="c1">#Now the process matrix</span>
             <span class="n">wi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Z_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">not_Zmiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
             
             <span class="c1">#Step 8</span>
             <span class="n">wi</span> <span class="o">=</span> <span class="n">wi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wi</span><span class="p">)</span>
        
             <span class="c1">#Step 9</span>
             <span class="n">t_z</span> <span class="o">=</span>  <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Z_</span><span class="p">,</span><span class="n">wi</span><span class="p">,</span><span class="n">not_Zmiss</span><span class="p">)</span>
             
             <span class="c1">#Step 10</span>
             <span class="n">Taux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">t_rx</span><span class="p">,</span><span class="n">t_z</span><span class="p">))</span>
             <span class="n">plsobj_</span><span class="o">=</span><span class="n">pls</span><span class="p">(</span><span class="n">Taux</span><span class="p">,</span> <span class="n">Y_</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mcsX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mcsY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="n">wt_i</span> <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
             <span class="n">qi</span>   <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span>
             <span class="n">un</span>   <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>   
             <span class="n">ti</span>   <span class="o">=</span> <span class="n">plsobj_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
             
             
             <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">un</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ui</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                 
             <span class="k">if</span> <span class="n">num_it</span> <span class="o">&gt;</span> <span class="n">maxit</span><span class="p">:</span>
                 <span class="n">Converged</span><span class="o">=</span><span class="kc">True</span>
                 
             <span class="k">if</span> <span class="n">Converged</span><span class="p">:</span>
                 <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# Iterations for LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num_it</span><span class="p">))</span>
                 <span class="n">pi</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">R_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                     <span class="c1"># Calculate P&#39;s for deflation p=R&#39;t/(t&#39;t) </span>
                     <span class="n">pi_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">R_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Rmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                     <span class="n">pi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi_</span><span class="p">)</span>
                 <span class="n">vi</span><span class="o">=</span><span class="p">[]</span>
                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">X_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                     <span class="c1"># Calculate v&#39;s for deflation v=Xr/(r&#39;r) </span>
                     <span class="n">vi_</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                     <span class="n">vi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vi_</span><span class="p">)</span>
                 
                 <span class="n">pzi</span> <span class="o">=</span> <span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Z_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Zmiss</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                 
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>    
                     <span class="c1"># Deflate X leaving missing as zeros (important!)</span>
                     <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Rmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                     <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">vi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                     <span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">vi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                     
                 <span class="n">Y_</span><span class="o">=</span><span class="p">(</span><span class="n">Y_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
                 <span class="n">Z_</span><span class="o">=</span><span class="p">(</span><span class="n">Z_</span><span class="o">-</span> <span class="n">ti</span> <span class="o">@</span> <span class="n">pzi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Zmiss</span> 
                 
                 <span class="c1">#print(R_.shape)</span>
                 <span class="c1">#print(X_.shape)</span>
                 <span class="c1">#print(Y_.shape)</span>
                 <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                     <span class="n">T</span><span class="o">=</span><span class="n">ti</span>
                     <span class="n">P</span><span class="o">=</span><span class="n">pi</span>
                     <span class="n">Pz</span><span class="o">=</span><span class="n">pzi</span>
                     <span class="n">S</span><span class="o">=</span><span class="n">si</span>
                     <span class="n">U</span><span class="o">=</span><span class="n">un</span>
                     <span class="n">Q</span><span class="o">=</span><span class="n">qi</span>
                     <span class="n">H</span><span class="o">=</span><span class="n">hi</span>
                     <span class="n">V</span><span class="o">=</span><span class="n">vi</span>
                     <span class="n">Rscores</span> <span class="o">=</span> <span class="n">ri</span>
                     <span class="n">W</span><span class="o">=</span><span class="n">wi</span>
                     <span class="n">Wt</span><span class="o">=</span><span class="n">wt_i</span>
                     
                     <span class="n">r2X</span><span class="o">=</span><span class="p">[]</span>
                     <span class="n">r2Xpv</span><span class="o">=</span><span class="p">[]</span>
                     <span class="n">r2R</span><span class="o">=</span><span class="p">[]</span>
                     <span class="n">r2Rpv</span><span class="o">=</span><span class="p">[]</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
                         <span class="n">r2X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                         <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Xpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                         <span class="n">r2R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSR</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                         <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSRpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Rpv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">r2Rpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                                          
                     <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                     <span class="n">r2Ypv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                     <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     
                     <span class="n">r2Z</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSZ</span>
                     <span class="n">r2Zpv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSZpv</span>
                     <span class="n">r2Zpv</span> <span class="o">=</span> <span class="n">r2Zpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>              
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                     <span class="n">U</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">un</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                     <span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span><span class="n">qi</span><span class="p">))</span>
                     <span class="n">W</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">W</span><span class="p">,</span><span class="n">wi</span><span class="p">))</span>
                     <span class="n">Wt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Wt</span><span class="p">,</span><span class="n">wt_i</span><span class="p">))</span>
                     <span class="n">Pz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Pz</span><span class="p">,</span><span class="n">pzi</span> <span class="p">))</span>
                     
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)):</span>
                         <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> 
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)):</span>    
                         <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">si</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)):</span>    
                         <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">hi</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">)):</span>    
                         <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vi</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Rscores</span><span class="p">)):</span>    
                         <span class="n">Rscores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Rscores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>

                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>   
                         <span class="n">r2X_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Xpv_</span> <span class="o">=</span> <span class="n">r2Xpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                         <span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2X_</span><span class="p">))</span>
                         <span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2Xpv_</span><span class="p">))</span>
                         
                         <span class="n">r2R_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSRpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                         <span class="n">r2Rpv_</span> <span class="o">=</span> <span class="n">r2Rpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                         <span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2R_</span><span class="p">))</span>
                         <span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">r2Rpv_</span><span class="p">))</span>
                         
       
                     <span class="n">r2Y_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                     <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSYpv</span>
                     <span class="n">r2Ypv_</span> <span class="o">=</span> <span class="n">r2Ypv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">r2Y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="n">r2Y_</span><span class="p">))</span>
                     <span class="n">r2Ypv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">r2Ypv_</span><span class="p">))</span>
                     
                     <span class="n">r2Z_</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSZ</span>
                     <span class="n">r2Zpv_</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">TSSZpv</span>
                     <span class="n">r2Zpv_</span> <span class="o">=</span> <span class="n">r2Zpv_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  
                     <span class="n">r2Z</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Z</span><span class="p">,</span><span class="n">r2Z_</span><span class="p">))</span>
                     <span class="n">r2Zpv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Zpv</span><span class="p">,</span><span class="n">r2Zpv_</span><span class="p">))</span>                     

             <span class="k">else</span><span class="p">:</span>
                 <span class="n">num_it</span> <span class="o">=</span> <span class="n">num_it</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="n">ui</span> <span class="o">=</span> <span class="n">un</span>       
        <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">numIT</span><span class="o">=</span><span class="n">num_it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numIT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">numIT</span><span class="p">,</span><span class="n">num_it</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xhat</span><span class="p">)):</span>        
        <span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_std</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_mean</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="n">Xhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>      
 
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Z</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Z</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2Zpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Zpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Zpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">r2xc</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">r2rc</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>    
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Rpv</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r2Xpv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">r2xpv_all</span><span class="o">=</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2xpv_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r2xpv_all</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

    
        <span class="n">r2xc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2X</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">r2rc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2R</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    

    <span class="n">r2yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Y</span><span class="p">)</span>
    <span class="n">r2zc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r2Z</span><span class="p">)</span>
    <span class="n">r2rc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2rc</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r2xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2xc</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r2x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2X</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> 
    <span class="n">r2r</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2R</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span> 
    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LV #     R2X       sum(R2X)   R2R       sum(R2R)   R2Z       sum(R2Z)   R2Y       sum(R2Y)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r2x</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2xc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2r</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2rc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Z</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2zc</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2yc</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
         
           <span class="n">d1</span><span class="o">=</span><span class="n">r2xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d2</span><span class="o">=</span><span class="n">r2rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d3</span><span class="o">=</span><span class="n">r2zc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="n">d4</span><span class="o">=</span><span class="n">r2yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LV #&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:   </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">      </span><span class="si">{:.3f}</span><span class="s2">     </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r2x</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span><span class="n">r2r</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">r2Z</span><span class="p">,</span><span class="n">d3</span><span class="p">,</span><span class="n">r2Y</span><span class="p">,</span><span class="n">d4</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>   
        
    <span class="n">tpls_obj</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">Q</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="n">S</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="n">H</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">:</span><span class="n">V</span><span class="p">,</span><span class="s1">&#39;Rscores&#39;</span><span class="p">:</span><span class="n">Rscores</span><span class="p">,</span>
              <span class="s1">&#39;r2xi&#39;</span><span class="p">:</span><span class="n">r2X</span><span class="p">,</span><span class="s1">&#39;r2xpvi&#39;</span><span class="p">:</span><span class="n">r2Xpv</span><span class="p">,</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">:</span><span class="n">r2xpv_all</span><span class="p">,</span>
              <span class="s1">&#39;mx&#39;</span><span class="p">:</span><span class="n">x_mean</span><span class="p">,</span><span class="s1">&#39;sx&#39;</span><span class="p">:</span><span class="n">x_std</span><span class="p">,</span>
              <span class="s1">&#39;r2y&#39;</span><span class="p">:</span><span class="n">r2Y</span><span class="p">,</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">:</span><span class="n">r2Ypv</span><span class="p">,</span>
              <span class="s1">&#39;my&#39;</span><span class="p">:</span><span class="n">y_mean</span><span class="p">,</span><span class="s1">&#39;sy&#39;</span><span class="p">:</span><span class="n">y_std</span><span class="p">,</span>
              <span class="s1">&#39;r2ri&#39;</span><span class="p">:</span><span class="n">r2R</span><span class="p">,</span><span class="s1">&#39;r2rpvi&#39;</span><span class="p">:</span><span class="n">r2Rpv</span><span class="p">,</span>
              <span class="s1">&#39;mr&#39;</span><span class="p">:</span><span class="n">r_mean</span><span class="p">,</span><span class="s1">&#39;sr&#39;</span><span class="p">:</span><span class="n">r_std</span><span class="p">,</span>
              <span class="s1">&#39;r2z&#39;</span><span class="p">:</span><span class="n">r2Z</span><span class="p">,</span><span class="s1">&#39;r2zpv&#39;</span><span class="p">:</span><span class="n">r2Zpv</span><span class="p">,</span>
              <span class="s1">&#39;mz&#39;</span><span class="p">:</span><span class="n">z_mean</span><span class="p">,</span><span class="s1">&#39;sz&#39;</span><span class="p">:</span><span class="n">z_std</span><span class="p">,</span>
              <span class="s1">&#39;Xhat&#39;</span><span class="p">:</span><span class="n">Xhat</span><span class="p">,</span><span class="s1">&#39;materials&#39;</span><span class="p">:</span><span class="n">materials</span><span class="p">,</span><span class="s1">&#39;Wt&#39;</span><span class="p">:</span><span class="n">Wt</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">:</span><span class="n">W</span><span class="p">,</span><span class="s1">&#39;Pz&#39;</span><span class="p">:</span><span class="n">Pz</span><span class="p">}</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidX</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidXi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidX</span>
        <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;varidXi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidX</span>
    
    <span class="n">varidXall</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">materials</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">varidXall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">materials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">varidX</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidXall</span>    
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidR</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidRi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidR</span>
       <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;varidRi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidR</span>  
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidY</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidY</span>
       <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidY</span>    

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsidZ</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
       <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;obsidZ&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">obsidZ</span>
       <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;varidZ&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">varidZ</span>  
       
    <span class="n">T2</span> <span class="o">=</span> <span class="n">hott2</span><span class="p">(</span><span class="n">tpls_obj</span><span class="p">,</span><span class="n">Tnew</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
    <span class="n">n</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T2_lim99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
    <span class="n">T2_lim95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>    
    
    <span class="n">speX</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speR</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speX_lim95</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speX_lim99</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speR_lim95</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">speR_lim99</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">speX</span> <span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">aux_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speX_lim95_</span><span class="p">,</span><span class="n">speX_lim99_</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">aux_</span><span class="p">)</span>
        <span class="n">speX_lim95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speX_lim95_</span><span class="p">)</span>
        <span class="n">speX_lim99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speX_lim99_</span><span class="p">)</span>
        
        <span class="n">speR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">aux_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speR_lim95_</span><span class="p">,</span><span class="n">speR_lim99_</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">aux_</span><span class="p">)</span>
        <span class="n">speR_lim95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speR_lim95_</span><span class="p">)</span>
        <span class="n">speR_lim99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">speR_lim99_</span><span class="p">)</span>
        
    <span class="n">speY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">speY_lim95</span><span class="p">,</span><span class="n">speY_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speY</span><span class="p">)</span>
    
    <span class="n">speZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Z_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">speZ_lim95</span><span class="p">,</span><span class="n">speZ_lim99</span> <span class="o">=</span> <span class="n">spe_ci</span><span class="p">(</span><span class="n">speZ</span><span class="p">)</span>
    
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">T2</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim99&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim99</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;T2_lim95&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">T2_lim95</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speX</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim99</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speX_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speX_lim95</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speY&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speY</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim99</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speY_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speY_lim95</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speR&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speR</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speR_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speR_lim99</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speR_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speR_lim95</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speZ&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">speZ</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speZ_lim99&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speZ_lim99</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;speZ_lim95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speZ_lim95</span>
    
    <span class="n">Wsi</span><span class="o">=</span> <span class="p">[]</span>
    <span class="n">Ws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)):</span>
        <span class="n">Wsi</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Ws</span><span class="o">=</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ws</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Ws</span><span class="p">,</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>    
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;Ssi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Wsi</span> <span class="c1">#trick to plot the JRPLS/LPLS does not really have Ws</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;Ss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ws</span> <span class="c1">#trick to plot the JRPLS/LPLS does not really have Ws</span>
    <span class="c1">#Ws=W @ np.linalg.pinv(P.T @ W)</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;tpls&#39;</span>
    
    <span class="n">Ws</span><span class="o">=</span><span class="n">W</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Pz</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W</span><span class="p">)</span>
    <span class="n">tpls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Ws</span>
    <span class="k">return</span> <span class="n">tpls_obj</span>       </div>


<div class="viewcode-block" id="tpls_pred">
<a class="viewcode-back" href="../pyphi.html#pyphi.tpls_pred">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tpls_pred</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">znew</span><span class="p">,</span><span class="n">tplsobj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Routine to produce the prediction for a new observation of Ri using a TPLS model</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>

<span class="sd">    preds = pyphi.tpls_pred(rnew,znew,tplsobj)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        rnew: A dictionary with the format: </span>
<span class="sd">            rnew={ </span>
<span class="sd">                &#39;matid&#39;:[(lotid,rvalue )],</span>
<span class="sd">                </span>
<span class="sd">                }</span>
<span class="sd">            </span>
<span class="sd">            for example, a prediction for the scenario:</span>
<span class="sd">                </span>
<span class="sd">        material    lot to use  rvalue       </span>
<span class="sd">        API	        A0129	    0.5</span>
<span class="sd">        Lactose	    Lac0003   	0.1</span>
<span class="sd">        Lactose     Lac1010     0.2</span>
<span class="sd">        MgSt	        M0012	    0.02</span>
<span class="sd">        MCC      	MCC0017	    0.18</span>
<span class="sd">        </span>
<span class="sd">        use:</span>
<span class="sd">            </span>
<span class="sd">        rnew={</span>
<span class="sd">            &#39;API&#39;:[(&#39;A0129&#39;,0.5)],</span>
<span class="sd">            &#39;Lactose&#39;:[(&#39;Lac0003&#39;,0.1 ),(&#39;Lac1010&#39;,0.2 )],</span>
<span class="sd">            &#39;MgSt&#39;:[(&#39;M0012&#39;,0.02)],</span>
<span class="sd">            &#39;MCC&#39;:[(&#39;MCC0017&#39;,0.18)],</span>
<span class="sd">            }    </span>
<span class="sd">        </span>
<span class="sd">        znew: Dataframe or numpy with new observation</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        preds a dictionary of the form:</span>
<span class="sd">            </span>
<span class="sd">            preds ={&#39;Tnew&#39;:tnew,&#39;Yhat&#39;:yhat,&#39;speR&#39;:sper,&#39;speZ&#39;:spez} </span>
<span class="sd">            </span>
<span class="sd">            where speR has the speR per each material</span>
<span class="sd">            </span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">ok</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="c1">#check dimensions</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>     
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">mr</span><span class="p">,</span><span class="n">sr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;mr&#39;</span><span class="p">],</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;sr&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">ok</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">rnew_</span><span class="o">=</span><span class="n">r</span>
                <span class="n">mr_</span><span class="o">=</span><span class="n">mr</span>
                <span class="n">sr_</span><span class="o">=</span><span class="n">sr</span>
                <span class="n">Rscores</span> <span class="o">=</span> <span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">P</span>       <span class="o">=</span> <span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rnew_</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rnew_</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>    
                <span class="n">mr_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mr_</span><span class="p">,</span><span class="n">mr</span><span class="p">))</span>
                <span class="n">sr_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">sr_</span><span class="p">,</span><span class="n">sr</span><span class="p">))</span>
                <span class="n">Rscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Rscores</span><span class="p">,</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>
                <span class="n">P</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnew</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="c1">#re-arrange </span>
        <span class="n">ok</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">rnew_</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;*&#39;</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rnew</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">ri</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;mr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">rnew</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;varidRi&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">ri</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">=</span><span class="n">r</span>
            <span class="n">rnew_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ri</span>
        
        <span class="n">preds</span><span class="o">=</span><span class="n">tpls_pred</span><span class="p">(</span><span class="n">rnew_</span><span class="p">,</span><span class="n">znew</span><span class="p">,</span><span class="n">tplsobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preds</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">znew</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">znew_</span><span class="o">=</span><span class="n">znew</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">znew</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">znew_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">znew</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">znew</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">znew_</span><span class="o">=</span><span class="n">znew</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">znew_</span><span class="p">)</span><span class="o">==</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
   
    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>  
        <span class="n">bkzeros</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">selmat</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;Rscores&#39;</span><span class="p">]):</span>
            <span class="n">frontzeros</span><span class="o">=</span><span class="n">Rscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">bkzeros</span><span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">bkzeros</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span> <span class="n">frontzeros</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
            <span class="n">bkzeros</span><span class="o">+=</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">selmat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
        <span class="n">tnew</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">sper</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">spez</span><span class="o">=</span><span class="p">[]</span>
       
        <span class="n">rnew_</span><span class="o">=</span><span class="p">(</span><span class="n">rnew_</span><span class="o">-</span><span class="n">mr_</span><span class="p">)</span><span class="o">/</span><span class="n">sr_</span>
        <span class="n">rnew_</span><span class="o">=</span><span class="n">rnew_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">znew_</span><span class="o">=</span><span class="p">(</span><span class="n">znew_</span><span class="o">-</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;sz&#39;</span><span class="p">]</span>
        <span class="n">znew_</span><span class="o">=</span><span class="n">znew_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        
        <span class="n">tnew</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="n">ti_rx_</span> <span class="o">=</span><span class="p">(</span> <span class="n">rnew_</span><span class="o">.</span><span class="n">T</span><span class="nd">@Rscores</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">/</span>             
                 <span class="p">(</span><span class="n">Rscores</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="nd">@Rscores</span><span class="p">[:,</span><span class="n">a</span><span class="p">]))</span>
            
            <span class="n">ti_z_</span> <span class="o">=</span> <span class="n">znew_</span><span class="o">.</span><span class="n">T</span><span class="nd">@tplsobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span>
            
            
            <span class="n">ti_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ti_rx_</span><span class="p">,</span><span class="n">ti_z_</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="nd">@tplsobj</span><span class="p">[</span><span class="s1">&#39;Wt&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span>
            
            <span class="n">tnew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ti_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux</span><span class="o">=</span><span class="n">ti_</span><span class="o">*</span><span class="n">P</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span>
            <span class="n">rnew_</span><span class="o">=</span><span class="n">rnew_</span><span class="o">-</span><span class="n">aux</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">auxz</span><span class="o">=</span><span class="n">ti_</span><span class="o">*</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;Pz&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span>
            <span class="n">znew_</span><span class="o">=</span><span class="n">znew_</span><span class="o">-</span><span class="n">auxz</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            
        
        <span class="n">sper</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">selmat</span><span class="p">:</span>
            <span class="n">sper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rnew_</span><span class="p">[</span><span class="n">row</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">spez</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">znew_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tnew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tnew</span><span class="p">)</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">tnew</span><span class="nd">@tplsobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="p">(</span><span class="n">yhat</span> <span class="o">*</span> <span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">tplsobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">]</span>
        <span class="n">preds</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;Tnew&#39;</span><span class="p">:</span><span class="n">tnew</span><span class="p">,</span><span class="s1">&#39;Yhat&#39;</span><span class="p">:</span><span class="n">yhat</span><span class="p">,</span><span class="s1">&#39;speR&#39;</span><span class="p">:</span><span class="n">sper</span><span class="p">,</span><span class="s1">&#39;speZ&#39;</span><span class="p">:</span><span class="n">spez</span><span class="p">}</span>     
        <span class="k">return</span> <span class="n">preds</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;dimensions of rnew or znew did not macth model&#39;</span></div>

    
<div class="viewcode-block" id="varimax_">
<a class="viewcode-back" href="../pyphi.html#pyphi.varimax_">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">varimax_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">):</span>
    <span class="n">p</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">d</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="n">d_</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">Lambda</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">vh</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">asarray</span><span class="p">(</span><span class="n">Lambda</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="n">gamma</span><span class="o">/</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">Lambda</span><span class="p">,</span> <span class="n">diag</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">Lambda</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Lambda</span><span class="p">))))))</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">vh</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d_</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">d</span><span class="o">/</span><span class="n">d_</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span></div>


<div class="viewcode-block" id="varimax_rotation">
<a class="viewcode-back" href="../pyphi.html#pyphi.varimax_rotation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">varimax_rotation</span><span class="p">(</span><span class="n">mvm_obj</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Function to do a Varimax Rotation on a PCA or PLS model</span>
<span class="sd">    by Salvador Garcia-Munoz </span>
<span class="sd">    (sgarciam@ic.ac.uk ,salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    </span>
<span class="sd">    Routine to perform a VariMax rotation on a PCA or PLS model</span>
<span class="sd">    (I have also tested it with MBPLS models)</span>
<span class="sd">    </span>
<span class="sd">    rotated_model=varimax_rotation(model_object,X,&lt;Y=Ydata&gt;)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        model_object: A PCA or PLS or MBPLS model object</span>
<span class="sd">    Returns:</span>
<span class="sd">        rotated_model: The same model after VariMax rotation, scores and loadings are all rotated</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">mvmobj</span><span class="o">=</span><span class="n">mvm_obj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y_</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            
    <span class="n">X_</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],(</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">not_Xmiss</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">X_</span><span class="p">,</span><span class="n">Xmap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">TSSX</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">TSSXpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="n">Y_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;my&#39;</span><span class="p">],(</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sy&#39;</span><span class="p">],(</span><span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">not_Ymiss</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y_</span><span class="p">))</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">Y_</span><span class="p">,</span><span class="n">Ymap</span><span class="o">=</span><span class="n">n2z</span><span class="p">(</span><span class="n">Y_</span><span class="p">)</span>
        <span class="n">TSSY</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">TSSYpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="n">A</span><span class="o">=</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">:</span>
        <span class="n">Wrot</span><span class="o">=</span><span class="n">varimax_</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])</span>
        <span class="n">Trot</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">Prot</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">Qrot</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">Urot</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
            <span class="n">ti</span><span class="o">=</span><span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span> <span class="n">Wrot</span><span class="p">[:,</span><span class="n">a</span><span class="p">],</span> <span class="n">not_Xmiss</span><span class="p">)</span>
            <span class="n">pi</span><span class="o">=</span><span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Xmiss</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span>
            <span class="n">qi</span><span class="o">=</span><span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Y_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ti</span><span class="p">,</span><span class="n">not_Ymiss</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span>
            <span class="n">ui</span><span class="o">=</span><span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">Y_</span><span class="p">,</span><span class="n">qi</span><span class="p">,</span><span class="n">not_Ymiss</span> <span class="p">)</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span> <span class="o">-</span> <span class="n">ti</span><span class="nd">@pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_</span> <span class="o">-</span> <span class="n">ti</span><span class="nd">@qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Ymiss</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TSSXpv</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                
                <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                <span class="n">r2Xpv</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   
                                
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TSSYpv</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span>
                <span class="n">r2Ypv</span><span class="p">[</span><span class="n">TSSYpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">TSSYpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">TSSYpv</span><span class="p">[</span><span class="n">TSSYpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>                   
                
            <span class="k">else</span><span class="p">:</span>
                
                <span class="n">r2X</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TSSXpv</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">aux_</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
                                
                <span class="n">r2Y</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Y</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSY</span><span class="p">))</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TSSYpv</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">aux_</span><span class="p">[</span><span class="n">TSSYpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">TSSYpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">TSSYpv</span><span class="p">[</span><span class="n">TSSYpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Ypv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Ypv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>


            <span class="n">Trot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span>
            <span class="n">Prot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">Qrot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qi</span><span class="p">)</span>
            <span class="n">Urot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
                            
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Y</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Ypv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Trot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Trot</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Prot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Prot</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Qrot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Qrot</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Urot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Urot</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Trot</span><span class="o">=</span><span class="n">Trot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Prot</span><span class="o">=</span><span class="n">Prot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Qrot</span><span class="o">=</span><span class="n">Qrot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Urot</span><span class="o">=</span><span class="n">Urot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Wsrot</span><span class="o">=</span><span class="n">Wrot</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Prot</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Wrot</span><span class="p">)</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Wrot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Trot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Prot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Qrot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Urot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Wsrot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2x&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">r2X</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2y&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">r2Y</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Ypv</span>
              
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Prot</span><span class="o">=</span><span class="n">varimax_</span><span class="p">(</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
        <span class="n">Trot</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
            <span class="n">ti</span><span class="o">=</span><span class="n">_Ab_btbinv</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span> <span class="n">Prot</span><span class="p">[:,</span><span class="n">a</span><span class="p">],</span> <span class="n">not_Xmiss</span><span class="p">)</span>
            <span class="n">Trot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span>
            <span class="n">pi</span><span class="o">=</span><span class="n">Prot</span><span class="p">[:,[</span><span class="n">a</span><span class="p">]]</span>
            <span class="n">X_</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_</span> <span class="o">-</span> <span class="n">ti</span><span class="nd">@pi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">not_Xmiss</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>                
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TSSXpv</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                
                <span class="n">r2X</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span>
                <span class="n">r2Xpv</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r2X</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2X</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">TSSX</span><span class="p">))</span>
                <span class="n">aux_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">TSSXpv</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">aux_</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">TSSXpv</span><span class="p">[</span><span class="n">TSSXpv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">aux_</span>  <span class="o">=</span> <span class="n">aux_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">r2Xpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r2Xpv</span><span class="p">,</span><span class="n">aux_</span><span class="p">))</span>
            
        <span class="n">Trot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Trot</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>     <span class="o">=</span> <span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2X</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span><span class="o">-</span><span class="n">r2Xpv</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>            
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Prot</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Trot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2x&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">r2X</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2Xpv</span>
    <span class="k">return</span> <span class="n">mvmobj</span></div>

        
        

<div class="viewcode-block" id="spectra_mean_center">
<a class="viewcode-back" href="../pyphi.html#pyphi.spectra_mean_center">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectra_mean_center</span><span class="p">(</span><span class="n">Dm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Mean centering all spectra to have mean zero. </span>
<span class="sd">    Dm: Spectra</span>

<span class="sd">    Outputs:</span>
<span class="sd">    Processed spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Dm_columns</span> <span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">Dm_values</span>  <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">spectra_mean_center</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">Dm_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">Dm_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Dm_pd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">spectra_mean</span><span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mean_centered</span> <span class="o">=</span> <span class="n">Dm</span> <span class="o">-</span> <span class="n">spectra_mean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">mean_centered</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">spectra_mean</span><span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">mean_centered</span> <span class="o">=</span> <span class="n">Dm</span> <span class="o">-</span> <span class="n">spectra_mean</span>
            <span class="k">return</span> <span class="n">mean_centered</span></div>


<div class="viewcode-block" id="spectra_autoscale">
<a class="viewcode-back" href="../pyphi.html#pyphi.spectra_autoscale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectra_autoscale</span><span class="p">(</span><span class="n">Dm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Autoscaling all spectra to have variance one. </span>
<span class="sd">    Dm: Spectra</span>

<span class="sd">    Outputs:</span>
<span class="sd">    Processed spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Dm_columns</span> <span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">Dm_values</span>  <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">spectra_autoscale</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">Dm_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">Dm_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Dm_pd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">spectra_sd</span>  <span class="o">=</span>  <span class="n">Dm</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># ddof argument to use N-1 as devisor instead of N</span>
            <span class="n">autoscaled</span> <span class="o">=</span> <span class="n">Dm</span><span class="o">/</span><span class="n">spectra_sd</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">autoscaled</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">spectra_sd</span><span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># ddof argument to use N-1 as devisor instead of N</span>
            <span class="n">autoscaled</span> <span class="o">=</span> <span class="n">Dm</span><span class="o">/</span><span class="n">spectra_sd</span>
            <span class="k">return</span> <span class="n">autoscaled</span></div>



    
<div class="viewcode-block" id="spectra_baseline_correction">
<a class="viewcode-back" href="../pyphi.html#pyphi.spectra_baseline_correction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectra_baseline_correction</span><span class="p">(</span><span class="n">Dm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shifiting all spectra to have minimum zero. </span>
<span class="sd">    Only works with pandas dataframe. </span>
<span class="sd">    Dm: Spectra</span>

<span class="sd">    Outputs:</span>
<span class="sd">    Processed spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Dm_columns</span> <span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">Dm_values</span>  <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">spectra_baseline_correction</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">Dm_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">Dm_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Dm_pd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="n">spectra_min</span><span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">shifted</span> <span class="o">=</span> <span class="n">Dm</span> <span class="o">-</span> <span class="n">spectra_min</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">shifted</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">spectra_min</span><span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> 
            <span class="n">shifted</span> <span class="o">=</span> <span class="n">Dm</span> <span class="o">-</span> <span class="n">spectra_min</span>
            <span class="k">return</span> <span class="n">shifted</span></div>


<div class="viewcode-block" id="spectra_msc">
<a class="viewcode-back" href="../pyphi.html#pyphi.spectra_msc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectra_msc</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span> <span class="n">reference_spectra</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Perform Multivariate Scatter Correction transform</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Dm_columns</span> <span class="o">=</span><span class="n">Dm</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">Dm_values</span>  <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">spectra_msc</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">Dm_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Dm_values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">Dm_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Dm_pd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Dm</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reference_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reference_spectra</span> <span class="o">=</span> <span class="n">Dm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">reference_spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">reference_spectra</span><span class="p">])</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">Dm</span><span class="nd">@V</span><span class="o">.</span><span class="n">T</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">V</span><span class="nd">@V</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">corrected_spectra</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dm</span> <span class="o">-</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span><span class="o">/</span><span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">corrected_spectra</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reference_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;msc needs a reference spectra or to be able to use the mean of many spectra&quot;</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">reference_spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">reference_spectra</span><span class="p">])</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">Dm</span><span class="nd">@V</span><span class="o">.</span><span class="n">T</span><span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">V</span><span class="nd">@V</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">corrected_spectra</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dm</span> <span class="o">-</span> <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">corrected_spectra</span></div>

        
<div class="viewcode-block" id="bootstrap_pls">
<a class="viewcode-back" href="../pyphi.html#pyphi.bootstrap_pls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bootstrap_pls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">num_latents</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a list of PLS objects to be used in prediction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Dm_values</span>  <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">boot_pls_obj</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">sample_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">Dm_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Dm_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">boot_spectra</span> <span class="o">=</span> <span class="n">Dm_values</span><span class="p">[</span><span class="n">sample_indexes</span><span class="p">]</span>
        <span class="n">boot_Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">sample_indexes</span><span class="p">]</span>
        <span class="n">boot_pls_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pls</span><span class="p">(</span><span class="n">boot_spectra</span><span class="p">,</span><span class="n">boot_Y</span><span class="p">,</span><span class="n">num_latents</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">boot_pls_obj</span></div>


<div class="viewcode-block" id="bootstrap_pls_pred">
<a class="viewcode-back" href="../pyphi.html#pyphi.bootstrap_pls_pred">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bootstrap_pls_pred</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">bootstrap_pls_obj</span><span class="p">,</span> <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the quantiles predicion using bootstrapped PLS with gaussian errors. </span>
<span class="sd">    Only works with 1d outputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">quantile</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">quantile</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">quantile</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quantiles must be between zero and one&quot;</span><span class="p">)</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pls_obj</span> <span class="ow">in</span> <span class="n">bootstrap_pls_obj</span><span class="p">:</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">X_new</span><span class="p">,</span> <span class="n">pls_obj</span><span class="p">)[</span><span class="s2">&quot;Yhat&quot;</span><span class="p">])</span>
        <span class="n">sds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">[</span><span class="s2">&quot;speY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sds</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">sds</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>
    <span class="n">ppf</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">quantile</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">quantile</span>
        <span class="n">ppf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fsolve</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">means</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">ppf</span></div>



<div class="viewcode-block" id="findstr">
<a class="viewcode-back" href="../pyphi.html#pyphi.findstr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">findstr</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">indx</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="s1">&#39;*&#39;</span> <span class="ow">or</span> <span class="n">s</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span>
           <span class="n">indx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">indx</span></div>


<div class="viewcode-block" id="evalvar">
<a class="viewcode-back" href="../pyphi.html#pyphi.evalvar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">evalvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">vname</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">actual_vname</span><span class="o">=</span><span class="n">vname</span><span class="p">[:</span><span class="n">vname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)]</span>
        <span class="n">actual_vname</span><span class="o">=</span><span class="n">actual_vname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">actual_vname</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">power</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">vname</span><span class="p">[</span><span class="n">vname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">actual_vname</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">power</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">actual_vname</span><span class="o">=</span><span class="n">vname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">actual_vname</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">actual_vname</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">return</span> <span class="n">vals</span></div>


<div class="viewcode-block" id="writeeq">
<a class="viewcode-back" href="../pyphi.html#pyphi.writeeq">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">writeeq</span><span class="p">(</span><span class="n">beta_</span><span class="p">,</span><span class="n">features_</span><span class="p">):</span>
    <span class="n">eq_str</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">beta_</span><span class="p">,</span><span class="n">features_</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_</span><span class="p">))):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">==</span><span class="s1">&#39;Bias&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">eq_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eq_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; + &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">eq_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; * &#39;</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eq_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; + &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; * &#39;</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eq_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="build_polynomial">
<a class="viewcode-back" href="../pyphi.html#pyphi.build_polynomial">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_polynomial</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">factors</span><span class="p">,</span><span class="n">response</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">bias_term</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to create linear regression models with variable selection assited by PLS</span>
<span class="sd">      </span>
<span class="sd">    Args:</span>
<span class="sd">        data : DataFrame</span>
<span class="sd">                Pandas data frame, first column is the observation id column</span>
<span class="sd">        factors : List</span>
<span class="sd">                list of factors to be included in expression. Powers, Mutliplications</span>
<span class="sd">                and divisions are allowed. Eg:</span>
<span class="sd">                    structure=[</span>
<span class="sd">                        &#39;Variable 1&#39;</span>
<span class="sd">                        &#39;Variable 1^2&#39;</span>
<span class="sd">                        &#39;Variable 2&#39;</span>
<span class="sd">                        &#39;Variable 3 * Variable 1&#39;</span>
<span class="sd">                        &#39;Variable 1^2 / Variable 4&#39;</span>
<span class="sd">                        ]</span>
<span class="sd">                    </span>
<span class="sd">        response: string</span>
<span class="sd">                Response variable in the dataset (must be a column of &#39;data&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        betasOLSlssq : Coefficients for factors`</span>
<span class="sd">        factors_out  : Factors</span>
<span class="sd">        Xaug,Y       : Numpy Arrays with X and Y data</span>
<span class="sd">        eqstr        : Full equation</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
        <span class="c1">#search for * or / operators</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1">#find all locations for * or /</span>
            <span class="n">indx</span><span class="o">=</span><span class="n">findstr</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ii</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> 
                    <span class="n">vname1</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">vname2</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vname2</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                        
                    <span class="n">vals1</span><span class="o">=</span><span class="n">evalvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">vname1</span><span class="p">)</span>
                    <span class="n">vals2</span><span class="o">=</span><span class="n">evalvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">vname2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;*&#39;</span><span class="p">:</span>
                        <span class="n">xcol</span><span class="o">=</span><span class="n">vals1</span> <span class="o">*</span> <span class="n">vals2</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span>
                        <span class="n">xcol</span><span class="o">=</span><span class="n">vals1</span> <span class="o">/</span> <span class="n">vals2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">==</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">vname</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vname</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indx</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                    <span class="n">vals</span><span class="o">=</span><span class="n">evalvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">vname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;*&#39;</span><span class="p">:</span>
                        <span class="n">xcol</span><span class="o">=</span> <span class="n">xcol</span> <span class="o">*</span> <span class="n">vals</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span>
                        <span class="n">xcol</span><span class="o">=</span> <span class="n">xcol</span> <span class="o">/</span> <span class="n">vals</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">X</span><span class="o">=</span><span class="n">xcol</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">xcol</span><span class="p">))</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">X</span><span class="o">=</span><span class="n">evalvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span><span class="o">=</span><span class="n">evalvar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
                <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">temp</span> <span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Built X from factors&#39;</span><span class="p">)</span>            
    <span class="n">X_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">factors</span><span class="p">)</span>
    <span class="n">X_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">Y_df</span><span class="o">=</span><span class="n">data</span><span class="p">[</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">response</span><span class="p">]]</span>
    <span class="n">Y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">response</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">pls_obj</span><span class="o">=</span><span class="n">pls</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span><span class="n">Y_df</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">))</span>
    <span class="n">Ypred</span><span class="o">=</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span><span class="n">pls_obj</span><span class="p">)</span>
    <span class="n">Ypred</span><span class="o">=</span><span class="n">Ypred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>
    <span class="n">RMSE</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y_df</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span><span class="n">Ypred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="p">)</span> <span class="p">)]</span>
    
    <span class="n">vip</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;r2y&#39;</span><span class="p">],(</span><span class="n">pls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vip</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#vip=np.reshape(vip,(len(vip),-1))</span>
    <span class="n">sort_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">vip</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sort_asc_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vip</span><span class="o">=</span><span class="n">vip</span><span class="p">[</span><span class="n">sort_indx</span><span class="p">]</span>
    <span class="n">sorted_factors</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sort_indx</span><span class="p">:</span>
        <span class="n">sorted_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_factors</span><span class="p">)),</span><span class="n">vip</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_factors</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">sorted_factors</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span> <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;VIP&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Factors&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="n">sorted_asc_factors</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sort_asc_indx</span><span class="p">:</span>
        <span class="n">sorted_asc_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
    <span class="n">X_df_m</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sorted_asc_factors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">!=</span><span class="n">sorted_asc_factors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">X_df_m</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pls_obj</span><span class="o">=</span><span class="n">pls</span><span class="p">(</span><span class="n">X_df_m</span><span class="p">,</span><span class="n">Y_df</span><span class="p">,</span><span class="n">X_df_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Ypred</span><span class="o">=</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">X_df_m</span><span class="p">,</span><span class="n">pls_obj</span><span class="p">)</span>
            <span class="n">Ypred</span><span class="o">=</span><span class="n">Ypred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>
            <span class="n">RMSE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y_df</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span><span class="n">Ypred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="p">)</span> <span class="p">))</span>
   
    <span class="n">sorted_asc_factors_lbl</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sort_asc_indx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">sorted_asc_factors_lbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">)),</span><span class="n">RMSE</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">sorted_asc_factors_lbl</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span> <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RMSE (&#39;</span><span class="o">+</span><span class="n">response</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Factors removed from model&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">Xaug</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="p">))</span>
    <span class="n">factors_out</span><span class="o">=</span><span class="n">factors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">factors_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Bias&#39;</span><span class="p">)</span>
    <span class="n">betasOLSlssq</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">Xaug</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">eqstr</span><span class="o">=</span><span class="n">writeeq</span><span class="p">(</span><span class="n">betasOLSlssq</span><span class="p">,</span><span class="n">factors_out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">betasOLSlssq</span><span class="p">,</span><span class="n">factors_out</span><span class="p">,</span><span class="n">Xaug</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">eqstr</span></div>


<div class="viewcode-block" id="cca">
<a class="viewcode-back" href="../pyphi.html#pyphi.cca">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cca</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform Canonical Correlation Analysis (CCA) on two datasets, X and Y.</span>
<span class="sd">    by sgarcia@imperial.ac.uk</span>
<span class="sd">    Parameters:</span>
<span class="sd">        X (numpy.ndarray): An (n x p) matrix where n is the number of samples and p is the number of features in X.</span>
<span class="sd">        Y (numpy.ndarray): An (n x q) matrix where n is the number of samples and q is the number of features in Y.</span>
<span class="sd">        tol (float): Tolerance for convergence. Default is 1e-6.</span>
<span class="sd">        max_iter (int): Maximum number of iterations. Default is 1000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): Contains canonical correlation (float), and the canonical directions (w_x, w_y).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Center the matrices</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Compute covariance matrices</span>
    <span class="n">Sigma_XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">Sigma_YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Sigma_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    
    <span class="c1"># Initialize random vectors for w_x and w_y</span>
    <span class="n">w_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">w_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Normalize initial w_x and w_y</span>
    <span class="n">w_x</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_x</span><span class="p">)</span>
    <span class="n">w_y</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_y</span><span class="p">)</span>
    
    <span class="c1"># Iteratively update w_x and w_y</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="c1"># Save previous values to check for convergence</span>
        <span class="n">w_x_old</span> <span class="o">=</span> <span class="n">w_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">w_y_old</span> <span class="o">=</span> <span class="n">w_y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Update w_x and normalize</span>
        <span class="n">w_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sigma_XX</span><span class="p">,</span> <span class="n">Sigma_XY</span> <span class="o">@</span> <span class="n">w_y</span><span class="p">)</span>
        <span class="n">w_x</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_x</span><span class="p">)</span>
        
        <span class="c1"># Update w_y and normalize</span>
        <span class="n">w_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sigma_YY</span><span class="p">,</span> <span class="n">Sigma_XY</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">w_x</span><span class="p">)</span>
        <span class="n">w_y</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_y</span><span class="p">)</span>
        
        <span class="c1"># Calculate the correlation</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="n">w_x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sigma_XY</span> <span class="o">@</span> <span class="n">w_y</span>
        
        <span class="c1"># Check for convergence</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_x</span> <span class="o">-</span> <span class="n">w_x_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_y</span> <span class="o">-</span> <span class="n">w_y_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="n">correlation</span><span class="p">,</span> <span class="n">w_x</span><span class="p">,</span> <span class="n">w_y</span></div>




<div class="viewcode-block" id="cca_multi">
<a class="viewcode-back" href="../pyphi.html#pyphi.cca_multi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cca_multi</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">num_components</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Perform Canonical Correlation Analysis (CCA) on two datasets, X and Y, to compute multiple canonical variates.</span>
<span class="sd">    by sgarciam@imperial.ac.uk</span>
<span class="sd">    </span>
<span class="sd">    Args::</span>
<span class="sd">        X (numpy.ndarray): An (n x p) matrix where n is the number of samples and p is the number of features in X.</span>
<span class="sd">        Y (numpy.ndarray): An (n x q) matrix where n is the number of samples and q is the number of features in Y.</span>
<span class="sd">        num_components (int): Number of canonical variates (components) to compute. Default is 1.</span>
<span class="sd">        tol (float): Tolerance for convergence. Default is 1e-6.</span>
<span class="sd">        max_iter (int): Maximum number of iterations. Default is 1000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dict): Contains canonical correlations, and the canonical direction vectors for X and Y.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Center the matrices</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Initialize lists to store results</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">W_X</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">W_Y</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Deflate iteratively for each component</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_components</span><span class="p">):</span>
        <span class="c1"># Compute covariance matrices for current deflated X and Y</span>
        <span class="n">Sigma_XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="n">Sigma_YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">Sigma_XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        
        <span class="c1"># Initialize random vectors for w_x and w_y</span>
        <span class="n">w_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">w_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Normalize initial w_x and w_y</span>
        <span class="n">w_x</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_x</span><span class="p">)</span>
        <span class="n">w_y</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_y</span><span class="p">)</span>
        
        <span class="c1"># Iteratively update w_x and w_y</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
            <span class="c1"># Save previous values to check for convergence</span>
            <span class="n">w_x_old</span> <span class="o">=</span> <span class="n">w_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">w_y_old</span> <span class="o">=</span> <span class="n">w_y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="c1"># Update w_x and normalize</span>
            <span class="n">w_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sigma_XX</span><span class="p">,</span> <span class="n">Sigma_XY</span> <span class="o">@</span> <span class="n">w_y</span><span class="p">)</span>
            <span class="n">w_x</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_x</span><span class="p">)</span>
            
            <span class="c1"># Update w_y and normalize</span>
            <span class="n">w_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sigma_YY</span><span class="p">,</span> <span class="n">Sigma_XY</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">w_x</span><span class="p">)</span>
            <span class="n">w_y</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_y</span><span class="p">)</span>
            
            <span class="c1"># Calculate the correlation</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">w_x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sigma_XY</span> <span class="o">@</span> <span class="n">w_y</span>
            
            <span class="c1"># Check for convergence</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_x</span> <span class="o">-</span> <span class="n">w_x_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w_y</span> <span class="o">-</span> <span class="n">w_y_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">break</span>
        
        <span class="c1"># Store results for this component</span>
        <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
        <span class="n">W_X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_x</span><span class="p">)</span>
        <span class="n">W_Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_y</span><span class="p">)</span>
        
        <span class="c1"># Deflate X and Y by removing the variance explained by the current canonical component</span>
        <span class="n">X</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">w_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">w_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Y</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span> <span class="o">@</span> <span class="n">w_y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">w_y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
    
    <span class="c1"># Convert lists to arrays</span>
    <span class="n">W_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">W_X</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Shape (p, num_components)</span>
    <span class="n">W_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">W_Y</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Shape (q, num_components)</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span>  <span class="c1"># Shape (num_components,)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;correlations&#39;</span><span class="p">:</span> <span class="n">correlations</span><span class="p">,</span>
        <span class="s1">&#39;W_X&#39;</span><span class="p">:</span> <span class="n">W_X</span><span class="p">,</span>
        <span class="s1">&#39;W_Y&#39;</span><span class="p">:</span> <span class="n">W_Y</span>
    <span class="p">}</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Salvador Garcia Munoz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>