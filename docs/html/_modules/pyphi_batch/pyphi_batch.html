

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyphi_batch.pyphi_batch &mdash; PyPhi 4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=71af5d5d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PyPhi
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">pyphi-master</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyPhi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyphi_batch.pyphi_batch</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyphi_batch.pyphi_batch</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="sd">Created on Mon Apr 11 14:58:35 2022</span>

<span class="sd">Batch data is assumed to come in an excel file </span>
<span class="sd">with first column being batch identifier and following columns</span>
<span class="sd">being process variables.</span>
<span class="sd">Optionally the second column labeled &#39;PHASE&#39;,&#39;Phase&#39; or &#39;phase&#39; indicating</span>
<span class="sd">the phase of exceution</span>

<span class="sd">Change log:</span>
<span class="sd">* added Dec 28 2023  Titles can be sent to contribution plots via plot_title flag    </span>
<span class="sd">                     Monitoring diagnostics are also plotted against sample starting with 1</span>

<span class="sd">* added Dec 27 2023  Corrected plots to use correct xaxis starting with sample =1 </span>
<span class="sd">                     Ammended indicator variable alignment not to replace the IV with a linear sequence but to keep orginal data</span>
<span class="sd">                     </span>
<span class="sd">* added Dec 4  2023  Added a BatchVIP calculation</span>
<span class="sd">* added Apr 23 2023  Corrected a very dumb mistake I made coding when tired    </span>
<span class="sd">    </span>
<span class="sd">* added Apr 18 2023 Added descriptors routine to obtain landmarks of the batch</span>
<span class="sd">                    such as min,max,ave of a variable [during a phase if indicated so]    </span>
<span class="sd">                    Modifed plot_var_all_batches to plot against the values in a Time column</span>
<span class="sd">                    and also add the legend for the BatchID</span>
<span class="sd">                    </span>
<span class="sd">* added Apr 10 2023 Added batch contribution plots</span>
<span class="sd">                    Added build_rel_time to create a tag of relative </span>
<span class="sd">                    run time from a timestamp</span>
<span class="sd">                    </span>
<span class="sd">* added Apr 7 2023  Added alignment using indicator variable per phase</span>


<span class="sd">* added Apr 5 2023  Added the capability to monitor a variable in &quot;Soft Sensor&quot; mode</span>
<span class="sd">                    which implies there are no measurements for it (pure prediction)</span>
<span class="sd">                    as oppose to a forecast where there are new measurments coming in time.</span>
<span class="sd">                    </span>
<span class="sd">* added Jul 20 2022 Distribution of number of samples per phase plot</span>
<span class="sd">* added Aug 10 2022 refold_horizontal | clean_empty_rows | predict </span>
<span class="sd">* added Aug 12 2022 replicate_batch</span>

<span class="sd">@author: S. Garcia-Munoz sgarciam@ic.ak.uk salg@andrew.cmu.edu</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyphi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">phi</span>
<span class="c1"># Sequence of color blind friendly colors.</span>
<span class="n">cb_color_seq</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span><span class="s1">&#39;bisque&#39;</span><span class="p">,</span><span class="s1">&#39;silver&#39;</span><span class="p">,</span><span class="s1">&#39;aqua&#39;</span><span class="p">,</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span><span class="s1">&#39;gray&#39;</span><span class="p">]</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cycler</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cb_color_seq</span><span class="p">)</span> 

<div class="viewcode-block" id="unique">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.unique">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">colid</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Replacement of the np.unique routine, specifically for dataframes</span>
<span class="sd">    </span>
<span class="sd">    unique(df,colid)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df:     A pandas dataframe</span>
<span class="sd">        colid:  Column identifier </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        A list with unique values in the order found in the dataframe</span>
<span class="sd">    </span>
<span class="sd">    by Salvador Garcia (sgarciam@ic.ac.uk)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">aux</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">colid</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_entries</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">colid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">unique_entries</span></div>

    
<div class="viewcode-block" id="mean">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.mean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">axis</span><span class="p">):</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">X_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">X_nan_map</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">X_nan_map</span>       <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
        <span class="n">X_</span><span class="p">[</span><span class="n">X_nan_map</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
       
        <span class="c1">#Calculate mean without accounting for NaN&#39;</span>
        <span class="k">if</span> <span class="n">axis</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">aux</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">aux</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_nan_map</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aux</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="simple_align">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.simple_align">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">simple_align</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">nsamples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Simple alignment for bacth data using row number to linearly interpolate</span>
<span class="sd">        to the same number of samples </span>
<span class="sd">    </span>
<span class="sd">    bdata_aligned= simple_align(bdata,nsamples)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bdata is a Pandas DataFrame where 1st column is Batch Identifier</span>
<span class="sd">              and following columns are variables, each row is a new</span>
<span class="sd">              time sample. Batches are concatenated vertically.</span>
<span class="sd">          </span>
<span class="sd">        nsamples is the new number of samples to generate per batch </span>
<span class="sd">            irrespective of phase</span>
<span class="sd">     </span>
<span class="sd">    Returns:</span>
<span class="sd">        A pandas dataframe with batch data resampled to nsamples</span>
<span class="sd">        for all batches</span>
<span class="sd">    </span>
<span class="sd">    by Salvador Garcia Munoz (sgarciam@imperial.ac.uk, salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bdata_a</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">phase</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">aux</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_batches</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unique_batches</span><span class="p">:</span>
        <span class="n">data_</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">new_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nsamples</span><span class="p">)</span>
        <span class="n">bname_rs</span><span class="o">=</span><span class="p">[</span><span class="n">data_</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">nsamples</span>
        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="n">phase_list</span><span class="o">=</span><span class="n">data_</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">roundindx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">new_indx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">phase_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">roundindx</span><span class="p">:</span>
                <span class="n">phase_rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">vals_rs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsamples</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">vals_rs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_indx</span><span class="p">,</span><span class="n">indx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span><span class="n">vals</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        
        <span class="n">df_</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vals_rs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="n">df_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">phase_rs</span><span class="p">)</span>
        <span class="n">df_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bname_rs</span><span class="p">)</span>
        <span class="n">bdata_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_</span><span class="p">)</span>
    <span class="n">bdata_a</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">bdata_a</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">bdata_a</span>            </div>

            

<div class="viewcode-block" id="phase_simple_align">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.phase_simple_align">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phase_simple_align</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">nsamples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Simple batch alignment (0 to 100%) per phase</span>
<span class="sd">    </span>
<span class="sd">    bdata_aligned = phase_simple_align(bdata,nsamples)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        </span>
<span class="sd">        bdata:  is a Pandas DataFrame where 1st column is Batch Identifier</span>
<span class="sd">              the second column is a phase indicator</span>
<span class="sd">              and following columns are variables, each row is a new</span>
<span class="sd">              time sample. Batches are concatenated vertically.</span>
<span class="sd">        </span>
<span class="sd">        nsamples: if integer: Number of samples to collect per phase</span>
<span class="sd">                            </span>
<span class="sd">                  if dictionary: samples to generate per phase e.g.</span>
<span class="sd">    </span>
<span class="sd">        nsamples = {&#39;Heating&#39;:100,&#39;Reaction&#39;:200,&#39;Cooling&#39;:10}</span>
<span class="sd">        </span>
<span class="sd">        resampling is linear with respect to row number </span>
<span class="sd">     </span>
<span class="sd">    Returns:</span>
<span class="sd">        a pandas dataframe with batch data resampled (aligned)</span>
<span class="sd">    </span>
<span class="sd">    by Salvador Garcia Munoz </span>
<span class="sd">    (sgarciam@imperial.ac.uk , salvadorgarciamunoz@gmail.com)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bdata_a</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">phase</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
        <span class="n">aux</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="n">unique_batches</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unique_batches</span><span class="p">:</span>
            <span class="n">data_</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
            <span class="n">vals_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">bname_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">phase_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">firstone</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nsamples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">p_data</span><span class="o">=</span> <span class="n">data_</span><span class="p">[</span><span class="n">data_</span><span class="p">[</span><span class="n">data_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">==</span><span class="n">p</span><span class="p">]</span>
                <span class="n">samps</span><span class="o">=</span><span class="n">nsamples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                
                <span class="n">indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">new_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">samps</span><span class="p">)</span>
                <span class="n">bname_rs_</span><span class="o">=</span><span class="p">[</span><span class="n">p_data</span><span class="p">[</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">samps</span>
                <span class="n">phase_rs_</span><span class="o">=</span><span class="p">[</span><span class="n">p_data</span><span class="p">[</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">samps</span>

                <span class="n">vals</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">cols</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">vals_rs_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">samps</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_indx</span><span class="p">,</span><span class="n">indx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span><span class="n">vals</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">firstone</span><span class="p">:</span>
                    <span class="n">vals_rs</span><span class="o">=</span><span class="n">vals_rs_</span>
                    <span class="n">firstone</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vals_rs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vals_rs</span><span class="p">,</span><span class="n">vals_rs_</span><span class="p">))</span>
                <span class="n">bname_rs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bname_rs_</span><span class="p">)</span>
                <span class="n">phase_rs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">phase_rs_</span><span class="p">)</span>
                 
            <span class="n">df_</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vals_rs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
            <span class="n">df_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">phase_rs</span><span class="p">)</span>
            <span class="n">df_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bname_rs</span><span class="p">)</span>
            <span class="n">bdata_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_</span><span class="p">)</span>
        <span class="n">bdata_a</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">bdata_a</span><span class="p">)</span>    
        <span class="k">return</span> <span class="n">bdata_a</span>            </div>

    
<div class="viewcode-block" id="phase_iv_align">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.phase_iv_align">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phase_iv_align</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">nsamples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Batch alignment using an indicator variable</span>
<span class="sd">    </span>
<span class="sd">    batch_aligned_data = phase_iv_align(bdata,nsamples)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        </span>
<span class="sd">        bdata is a Pandas DataFrame where 1st column is Batch Identifier</span>
<span class="sd">              the second column is a phase indicator</span>
<span class="sd">              and following columns are variables, each row is a new</span>
<span class="sd">              time sample. Batches are concatenated vertically.</span>
<span class="sd">              </span>
<span class="sd">       nsamples:</span>
<span class="sd">                     </span>
<span class="sd">            if nsamples is a dictionary: samples to generate per phase e.g.</span>
<span class="sd">            </span>
<span class="sd">            nsamples = {&#39;Heating&#39;:100,&#39;Reaction&#39;:200,&#39;Cooling&#39;:10}</span>
<span class="sd">            </span>
<span class="sd">            * If an indicator variable is used, with known start and end values</span>
<span class="sd">            indicate it with a list like this:</span>
<span class="sd">            </span>
<span class="sd">                [IVarID,num_samples,start_value,end_value]    </span>
<span class="sd">            </span>
<span class="sd">            example:</span>
<span class="sd">                </span>
<span class="sd">            nsamples = {&#39;Heating&#39;:[&#39;TIC101&#39;,100,30,50],&#39;Reaction&#39;:200,&#39;Cooling&#39;:10}</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">                During the &#39;Heating&#39; phase use TIC101 as an indicator variable</span>
<span class="sd">                take 100 samples equidistant from TIC101=30 to TIC101=50 </span>
<span class="sd">                and align against that variable as a measure of batch evolution (instead of time)</span>
<span class="sd">                </span>
<span class="sd">            * If an indicator variable is used, with unknown start but known end values</span>
<span class="sd">            indicate it with a list like this:</span>
<span class="sd">            </span>
<span class="sd">                [IVarID,num_samples,end_value]    </span>
<span class="sd">            </span>
<span class="sd">            example:</span>
<span class="sd">                </span>
<span class="sd">            nsamples = {&#39;Heating&#39;:[&#39;TIC101&#39;,100,50],&#39;Reaction&#39;:200,&#39;Cooling&#39;:10}</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">                During the &#39;Heating&#39; phase use TIC101 as an indicator variable</span>
<span class="sd">                take 100 samples equidistant from the value of TIC101 at the start of the phase</span>
<span class="sd">                to the point when TIC101=50 and align against that variable as a measure </span>
<span class="sd">                of batch evolution (instead of time)    </span>
<span class="sd">                </span>
<span class="sd">                If no IV is sent, the resampling is linear with respect to row number per phase</span>

<span class="sd">             </span>
<span class="sd">    Returns:</span>
<span class="sd">            A pandas dataframe with batch data resampled (aligned)</span>
<span class="sd">    </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk  salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bdata_a</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">phase</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
        <span class="n">aux</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="n">unique_batches</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unique_batches</span><span class="p">:</span>
            <span class="n">data_</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
            <span class="n">vals_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">bname_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">phase_rs</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">firstone</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nsamples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">p_data</span><span class="o">=</span> <span class="n">data_</span><span class="p">[</span><span class="n">data_</span><span class="p">[</span><span class="n">data_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">==</span><span class="n">p</span><span class="p">]</span>
                <span class="n">samps</span><span class="o">=</span><span class="n">nsamples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span> <span class="c1">#Linear alignment</span>
                    <span class="n">indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">new_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">samps</span><span class="p">)</span>
                    <span class="n">bname_rs_</span><span class="o">=</span><span class="p">[</span><span class="n">p_data</span><span class="p">[</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">samps</span>
                    <span class="n">phase_rs_</span><span class="o">=</span><span class="p">[</span><span class="n">p_data</span><span class="p">[</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">samps</span>
    
                    <span class="n">vals</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="n">cols</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="n">vals_rs_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">samps</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">x_</span><span class="o">=</span><span class="n">indx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                        <span class="n">y_</span><span class="o">=</span><span class="n">vals</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                        <span class="n">x_</span><span class="o">=</span><span class="n">x_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>
                        <span class="n">y_</span><span class="o">=</span><span class="n">y_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>                        
                        <span class="c1">#vals_rs_[:,i]=np.interp(new_indx,indx.astype(&#39;float&#39;),vals[:,i].astype(&#39;float&#39;))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_indx</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="c1">#align this phase with IV</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">samps</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
                        <span class="n">iv_id</span><span class="o">=</span><span class="n">samps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">nsamp</span><span class="o">=</span><span class="n">samps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">start</span><span class="o">=</span><span class="n">samps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">end</span>  <span class="o">=</span><span class="n">samps</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">new_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">nsamp</span><span class="p">)</span>
                        <span class="n">iv</span> <span class="o">=</span> <span class="n">p_data</span><span class="p">[</span><span class="n">iv_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">samps</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span>    <span class="p">:</span>
                        <span class="n">iv_id</span>    <span class="o">=</span> <span class="n">samps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">nsamp</span>    <span class="o">=</span> <span class="n">samps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">end</span>      <span class="o">=</span> <span class="n">samps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="nb">dict</span><span class="p">))</span>
                           <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">firstone</span><span class="p">)):</span>
                            <span class="c1">#end is  model to estimate the end value based on previous trajectory</span>
                            <span class="n">cols</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="n">fakebatch</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vals_rs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
                            <span class="n">fakebatch</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;phase&#39;</span><span class="p">,[</span><span class="n">p</span><span class="p">]</span><span class="o">*</span><span class="n">vals_rs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">fakebatch</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;BatchID&#39;</span><span class="p">,[</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="n">vals_rs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">preds</span><span class="o">=</span><span class="n">predict</span><span class="p">(</span><span class="n">fakebatch</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                            <span class="n">end_hat</span><span class="o">=</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">][</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                     
                            <span class="n">iv</span> <span class="o">=</span> <span class="n">p_data</span><span class="p">[</span><span class="n">iv_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                            <span class="n">end_hat</span> <span class="o">=</span> <span class="n">end_hat</span> <span class="o">+</span> <span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">new_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">end_hat</span><span class="p">,</span><span class="n">nsamp</span><span class="p">)</span>                        
                        <span class="k">else</span><span class="p">:</span>    
                            <span class="n">iv</span> <span class="o">=</span> <span class="n">p_data</span><span class="p">[</span><span class="n">iv_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                            <span class="n">new_indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">end</span><span class="p">,</span><span class="n">nsamp</span><span class="p">)</span>                        
                    
                    <span class="n">cols</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="c1">#indx_2_iv=cols.index(iv_id)</span>
                    <span class="n">bname_rs_</span><span class="o">=</span><span class="p">[</span><span class="n">p_data</span><span class="p">[</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">nsamp</span>
                    <span class="n">phase_rs_</span><span class="o">=</span><span class="p">[</span><span class="n">p_data</span><span class="p">[</span><span class="n">p_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">nsamp</span>      
                    
                    <span class="c1">#Check monotonicity</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)):</span>
                        <span class="n">indx</span><span class="o">=</span><span class="n">iv</span>                                          
                        <span class="n">vals</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>                              
                        <span class="c1">#replace the IV with a linear variable (time surrogate)</span>
                        <span class="c1">#linear_indx=np.arange(vals.shape[0])</span>
                        <span class="c1">#vals[:,indx_2_iv]=linear_indx</span>
                        <span class="n">vals_rs_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsamp</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> 
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">x_</span><span class="o">=</span><span class="n">indx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                            <span class="n">y_</span><span class="o">=</span><span class="n">vals</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                            <span class="n">x_</span><span class="o">=</span><span class="n">x_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>
                            <span class="n">y_</span><span class="o">=</span><span class="n">y_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>                        
                            <span class="c1">#vals_rs_[:,i]=np.interp(new_indx,indx.astype(&#39;float&#39;),vals[:,i].astype(&#39;float&#39;))</span>
                            <span class="c1">#vals_rs_[:,i]=np.interp(new_indx,indx                ,vals[:,i].astype(&#39;float&#39;),left=np.nan,right=np.nan)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="k">else</span><span class="p">:</span>                            
                                <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_indx</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                            
                        
                    <span class="k">else</span><span class="p">:</span> <span class="c1">#if monotonicity fails try to remove non-monotonic vals</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Indicator variable &#39;</span><span class="o">+</span><span class="n">iv_id</span><span class="o">+</span><span class="s1">&#39; for batch &#39;</span><span class="o">+</span> <span class="n">b</span> <span class="o">+</span><span class="s1">&#39; is not monotinic&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this is not ideal, maybe rethink your IV&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trying to remove non-monotonic samples&#39;</span><span class="p">)</span>  
                        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
                        <span class="n">m</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">iv</span><span class="o">-</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                      
                        <span class="c1">#if iv[0]-iv[-1] &gt; 0 :</span>
                        <span class="k">if</span> <span class="n">m</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>    
                            <span class="n">expected_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#decreasing IV</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">expected_direction</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#increasing IV                            </span>
                        <span class="n">vals</span><span class="o">=</span><span class="n">p_data</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>                        
                        <span class="n">new_vals</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
                        <span class="n">prev_iv</span><span class="o">=</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">mon_iv</span><span class="o">=</span><span class="p">[</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">prev_iv</span><span class="p">)</span> <span class="o">*</span> <span class="n">expected_direction</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#monotonic</span>
                                <span class="n">new_vals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">new_vals</span><span class="p">,</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
                                <span class="n">prev_iv</span><span class="o">=</span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">mon_iv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>                        
                        <span class="n">indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mon_iv</span><span class="p">)</span>    
                        <span class="n">vals</span><span class="o">=</span><span class="n">new_vals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="c1">#replace the IV with a linear variable (time surrogate)</span>
                        <span class="c1">#linear_indx=np.arange(vals.shape[0])</span>
                        <span class="c1">#vals[:,indx_2_iv]=linear_indx</span>
                        <span class="n">vals_rs_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsamp</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> 
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">x_</span><span class="o">=</span><span class="n">indx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                            <span class="n">y_</span><span class="o">=</span><span class="n">vals</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                            <span class="n">x_</span><span class="o">=</span><span class="n">x_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>
                            <span class="n">y_</span><span class="o">=</span><span class="n">y_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>                               
                            <span class="c1">#vals_rs_[:,i]=np.interp(new_indx,indx,vals[:,i].astype(&#39;float&#39;),left=np.nan,right=np.nan)    </span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">vals_rs_</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_indx</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>                                                
                <span class="k">if</span> <span class="n">firstone</span><span class="p">:</span>
                    <span class="n">vals_rs</span><span class="o">=</span><span class="n">vals_rs_</span>
                    <span class="n">firstone</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vals_rs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vals_rs</span><span class="p">,</span><span class="n">vals_rs_</span><span class="p">))</span>
                <span class="n">bname_rs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bname_rs_</span><span class="p">)</span>
                <span class="n">phase_rs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">phase_rs_</span><span class="p">)</span>
                 
                
            <span class="n">df_</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vals_rs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
            <span class="n">df_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">phase_rs</span><span class="p">)</span>
            <span class="n">df_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bname_rs</span><span class="p">)</span>
            <span class="n">bdata_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_</span><span class="p">)</span>
        <span class="n">bdata_a</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">bdata_a</span><span class="p">)</span>    
        <span class="k">return</span> <span class="n">bdata_a</span>    </div>

    
<div class="viewcode-block" id="plot_var_all_batches">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.plot_var_all_batches">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_var_all_batches</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">which_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">plot_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">mkr_style</span><span class="o">=</span><span class="s1">&#39;.-&#39;</span><span class="p">,</span>
                         <span class="n">phase_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">alpha_</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">timecolumn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lot_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Plotting routine for batch data plot data for all batches in a dataset</span>
<span class="sd">    </span>
<span class="sd">    plot_var_all_batches(bdata,*,which_var=False,plot_title=&#39;&#39;,mkr_style=&#39;.-&#39;,</span>
<span class="sd">                             phase_samples=False,alpha_=0.2,timecolumn=False,lot_legend=False):</span>

<span class="sd">    Args:</span>
<span class="sd">        bdata: Batch data organized as: column[0] = Batch Identifier column name is unrestricted</span>
<span class="sd">                                        column[1] = Phase information per sample must be called &#39;Phase&#39;,&#39;phase&#39;, or &#39;PHASE&#39;</span>
<span class="sd">                                                    this information is optional</span>
<span class="sd">                                        column[2:]= Variables measured throughout the batch</span>
<span class="sd">                                        </span>
<span class="sd">                                        The data for each batch is one on top of the other in a vertical matrix</span>
<span class="sd">        which_var:     Which variables are to be plotted, if not sent, all are.</span>
<span class="sd">        plot_title:    Optional text to be used as the title of all figures</span>
<span class="sd">        phase_samples: information used to align the batch, so that phases are marked in the plot</span>
<span class="sd">        alpha_:        Transparency for the phase dividing line</span>
<span class="sd">        timecolumn:    Name of the column that indicates time, if given all data is plotted against time</span>
<span class="sd">        lot_legend:    Flag to add a legend for the batch identifiers</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">var_list</span><span class="o">=</span><span class="n">which_var</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>    
            <span class="n">var_list</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">var_list</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
         <span class="n">var_list</span><span class="o">=</span><span class="p">[</span><span class="n">var_list</span><span class="p">]</span>    
         
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">timecolumn</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">bdata</span><span class="p">[[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">timecolumn</span><span class="p">,</span><span class="n">v</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">dat</span><span class="o">=</span><span class="n">bdata</span><span class="p">[[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
            <span class="n">data_</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">timecolumn</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
                <span class="n">tim</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">timecolumn</span><span class="p">][</span><span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lot_legend</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">mkr_style</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">mkr_style</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">timecolumn</span><span class="p">)</span>                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lot_legend</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">mkr_style</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">mkr_style</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lot_legend</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
            <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>                    
                    <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha_</span><span class="p">)</span>
                <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>                                    
                    <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span>  
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="plot_batch">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.plot_batch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_batch</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">which_batch</span><span class="p">,</span><span class="n">which_var</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">include_mean_exc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">include_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">phase_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">single_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">plot_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Plotting routine for batch data</span>
<span class="sd">    </span>
<span class="sd">    plot_batch(bdata,which_batch,which_var,*,include_mean_exc=False,include_set=False,</span>
<span class="sd">                   phase_samples=False,single_plot=False,plot_title=&#39;&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Args:  </span>
<span class="sd">        bdata: Batch data organized as: column[0] = Batch Identifier column name is unrestricted</span>
<span class="sd">                                        column[1] = Phase information per sample must be called &#39;Phase&#39;,&#39;phase&#39;, or &#39;PHASE&#39;</span>
<span class="sd">                                                    this information is optional</span>
<span class="sd">                                        column[2:]= Variables measured throughout the batch</span>
<span class="sd">                                        </span>
<span class="sd">                                        The data for each batch is one on top of the other in a vertical matrix</span>
<span class="sd">        </span>
<span class="sd">        which_batch:      Which batches to plot</span>
<span class="sd">        which_var:        Which variables are to be plotted, if not sent, all are.       </span>
<span class="sd">        include_mean_exc: Include the mean trajectory of the set EXCLUDING the one batch being plotted</span>
<span class="sd">        include_set:      Include all other trajectories (will be colored in light gray)</span>
<span class="sd">        phase_samples:    Information used to align the batch, so that phases are marked in the plot</span>
<span class="sd">        single_plot:      If True =&gt; Plot everything in a single axis</span>
<span class="sd">        plot_title:       Optional text to be added to the title of all figures</span>
<span class="sd">        </span>
<span class="sd">        by Salvador Garcia Munoz</span>
<span class="sd">        sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_batch</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">which_batch</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
        <span class="n">which_batch</span><span class="o">=</span><span class="p">[</span><span class="n">which_batch</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
        <span class="n">which_var</span><span class="o">=</span><span class="p">[</span><span class="n">which_var</span><span class="p">]</span>    
    <span class="k">if</span> <span class="n">single_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">first_pass</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">which_batch</span><span class="p">:</span>
        <span class="n">this_batch</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">all_others</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">which_var</span><span class="p">:</span>
            <span class="n">this_var_this_batch</span><span class="o">=</span><span class="n">this_batch</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">single_plot</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">x_axis</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">this_var_this_batch</span> <span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">this_var_this_batch</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_mean_exc</span> <span class="ow">or</span> <span class="n">include_set</span><span class="p">:</span>
                <span class="n">this_var_all_others</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">max_obs</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_others</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                    <span class="n">this_var_all_others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_others</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">all_others</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">bb</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_others</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">all_others</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">bb</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_obs</span><span class="p">:</span>
                        <span class="n">max_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_others</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">all_others</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">bb</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="p">)</span>
                <span class="n">this_var_all_others_</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_others</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                    <span class="n">_to_append</span><span class="o">=</span><span class="n">all_others</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">all_others</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">bb</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">this_len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_to_append</span><span class="p">)</span>
                    <span class="n">_to_append</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_to_append</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">max_obs</span><span class="o">-</span><span class="n">this_len</span><span class="p">))</span>
                    <span class="n">this_var_all_others_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_to_append</span><span class="p">)</span>
                <span class="n">this_var_all_others_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">this_var_all_others_</span><span class="p">)</span>    
                <span class="n">x_axis</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_obs</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">single_plot</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">include_set</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">this_var_all_others</span><span class="p">:</span>
                            <span class="n">x_axis</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">this_var_all_others</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;rest of set&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">include_mean_exc</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mean</span><span class="p">(</span><span class="n">this_var_all_others_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean without &#39;</span><span class="o">+</span><span class="n">b</span> <span class="p">)</span>  
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">first_pass</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">include_set</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">this_var_all_others_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">this_var_all_others_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;rest of set&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">include_mean_exc</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mean</span><span class="p">(</span><span class="n">this_var_all_others_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean without &#39;</span><span class="o">+</span><span class="n">b</span> <span class="p">)</span>
                        <span class="n">first_pass</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
                <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>                    
                        <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>                   
                    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>                                    
                        <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>     
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">plot_title</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="unfold_horizontal">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.unfold_horizontal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unfold_horizontal</span><span class="p">(</span><span class="n">bdata</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">phase</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">firstone</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">clbl</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bid</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">aux</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_batches</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unique_batches</span><span class="p">:</span>
        <span class="n">data_</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">cols</span><span class="o">=</span><span class="n">data_</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">row_</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">firstone_c</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            
           <span class="n">r_</span><span class="o">=</span> <span class="n">vals</span><span class="p">[:,[</span><span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">firstone</span><span class="p">:</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">r_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                   <span class="n">clbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                   <span class="n">bid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="p">)</span>
           <span class="k">if</span> <span class="n">firstone_c</span><span class="p">:</span>
               <span class="n">row_</span><span class="o">=</span><span class="n">r_</span>
               <span class="n">firstone_c</span><span class="o">=</span><span class="kc">False</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="n">row_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">row_</span><span class="p">,</span><span class="n">r_</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">firstone</span><span class="p">:</span>
           <span class="n">bdata_hor</span><span class="o">=</span><span class="n">row_</span>    
           <span class="n">firstone</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">bdata_hor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bdata_hor</span><span class="p">,</span><span class="n">row_</span><span class="p">))</span>     
    <span class="n">bdata_hor</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bdata_hor</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">clbl</span><span class="p">)</span>
    <span class="n">bdata_hor</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">unique_batches</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bdata_hor</span><span class="p">,</span><span class="n">clbl</span><span class="p">,</span><span class="n">bid</span></div>

            
<div class="viewcode-block" id="refold_horizontal">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.refold_horizontal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">refold_horizontal</span><span class="p">(</span><span class="n">xuf</span><span class="p">,</span><span class="n">nvars</span><span class="p">,</span><span class="n">nsamples</span><span class="p">):</span>
    <span class="c1">#xuf is strictly numberical</span>
    <span class="n">Xb</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xuf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">r</span><span class="o">=</span><span class="n">xuf</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
            <span class="n">var</span><span class="o">=</span><span class="n">r</span><span class="p">[:</span><span class="n">nsamples</span><span class="p">]</span>
            <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">&lt;</span><span class="p">(</span><span class="n">nvars</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="n">nsamples</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">var</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Xb</span><span class="o">=</span><span class="n">batch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Xb</span><span class="p">,</span><span class="n">batch</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Xb</span>       </div>

 
<span class="k">def</span><span class="w"> </span><span class="nf">_uf_l</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">):</span>
    <span class="n">first_</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">col_</span><span class="o">=</span><span class="n">L</span><span class="p">[:,[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">s_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">spb</span> <span class="p">)</span>
        <span class="n">first_flag</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vpb</span><span class="p">):</span>
            <span class="n">s_2use</span><span class="o">=</span><span class="p">(</span><span class="n">s_</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">spb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_flag</span><span class="p">:</span>
                <span class="n">col_rearranged</span><span class="o">=</span><span class="n">col_</span><span class="p">[</span><span class="n">s_2use</span><span class="p">]</span>
                <span class="n">first_flag</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_rearranged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col_rearranged</span><span class="p">,</span><span class="n">col_</span><span class="p">[</span><span class="n">s_2use</span><span class="p">]))</span>
        <span class="n">col_rearranged</span> <span class="o">=</span> <span class="n">col_rearranged</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_</span><span class="p">:</span>
            <span class="n">L_uf_hor_mon</span> <span class="o">=</span> <span class="n">col_rearranged</span><span class="o">.</span><span class="n">T</span>
            <span class="n">first_</span>       <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_uf_hor_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">L_uf_hor_mon</span><span class="p">,</span><span class="n">col_rearranged</span><span class="o">.</span><span class="n">T</span> <span class="p">))</span>
    <span class="k">return</span> <span class="n">L_uf_hor_mon</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_uf_hor_mon_loadings</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">):</span>
    <span class="n">spb</span> <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span>
    <span class="n">vpb</span> <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span>
    <span class="n">is_pls</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mvmobj</span><span class="p">:</span>
        <span class="n">is_pls</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">ninit</span><span class="o">=</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">is_pls</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ninit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">z_ws</span>   <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">,:]</span>
            <span class="n">z_w</span>    <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">,:]</span>
            <span class="n">z_p</span>    <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">,:]</span>
            <span class="n">z_mx</span>   <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">]</span>
            <span class="n">z_sx</span>   <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">]</span>
            
            <span class="n">x_ws</span>   <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:,:]</span>
            <span class="n">x_w</span>    <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:,:]</span>
            <span class="n">x_p</span>    <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:,:]</span>
            <span class="n">x_mx</span>   <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:]</span>
            <span class="n">x_sx</span>   <span class="o">=</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:]</span>
            <span class="n">Ws_ufm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">z_ws</span><span class="p">,</span><span class="n">_uf_l</span><span class="p">(</span><span class="n">x_ws</span><span class="p">,</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)))</span>
            <span class="n">W_ufm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">z_w</span> <span class="p">,</span><span class="n">_uf_l</span><span class="p">(</span><span class="n">x_w</span> <span class="p">,</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)))</span>
            <span class="n">P_ufm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">z_p</span> <span class="p">,</span><span class="n">_uf_l</span><span class="p">(</span><span class="n">x_p</span><span class="p">,</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)))</span>
            <span class="n">mx_ufm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">z_mx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">_uf_l</span><span class="p">(</span> <span class="n">x_mx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span> <span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sx_ufm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">z_sx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">_uf_l</span><span class="p">(</span> <span class="n">x_sx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span> <span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">Ws_ufm</span> <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">],</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)</span>
            <span class="n">W_ufm</span>  <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)</span>
            <span class="n">P_ufm</span>  <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)</span>
            <span class="n">mx_ufm</span> <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sx_ufm</span> <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P_ufm</span>  <span class="o">=</span>  <span class="n">_uf_l</span><span class="p">(</span><span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span><span class="p">)</span>
        <span class="n">mx_ufm</span> <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sx_ufm</span> <span class="o">=</span> <span class="n">_uf_l</span><span class="p">(</span> <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spb</span><span class="p">,</span><span class="n">vpb</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">is_pls</span><span class="p">:</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;Ws_ufm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ws_ufm</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;W_ufm&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">W_ufm</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P_ufm&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">P_ufm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;P_ufm&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">P_ufm</span>
    
    <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;mx_ufm&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">mx_ufm</span>
    <span class="n">mvmobj</span><span class="p">[</span><span class="s1">&#39;sx_ufm&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sx_ufm</span>
    
    <span class="k">return</span> <span class="n">mvmobj</span>

<div class="viewcode-block" id="loadings">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.loadings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">loadings</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">r2_weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which_var</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Plot batch loadings for variables as a function of time/sample</span>
<span class="sd">    </span>
<span class="sd">    loadings(mmvm_obj,dim,*,r2_weighted=False,which_var=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mmvm_obj:    Multiway PCA or PLS object</span>
<span class="sd">        dim:         What component or latent variable to plot</span>
<span class="sd">        r2_weighted: If True =&gt; weight the loading by the R2pv</span>
<span class="sd">        which_var:   Variable for which the plot is done, if not sent all are plotted</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span>
    
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">])</span>
            
            <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="n">vars_to_plot</span><span class="o">=</span><span class="p">[</span><span class="n">which_var</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">which_var</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">dim</span><span class="p">][</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$W^* * R^2$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$W^*$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:,</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:,</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span> <span class="p">)</span>
                <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                <span class="n">phase_samples</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
                    <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                            <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>                    
                            <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> 
                        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                       <span class="c1"># ylim_=[mmvm_obj[&#39;Ws&#39;][dim,:].min()*1.2,mmvm_obj[&#39;Ws&#39;][dim,:].max()*1.2  ]</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                            <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>                                    
                            <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_loadings</span><span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">])]</span>
            <span class="n">r2pvz</span>     <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]),:]</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">z_loadings</span> <span class="o">=</span> <span class="n">z_loadings</span> <span class="o">*</span><span class="n">r2pvz</span>
                
            <span class="n">zvars</span>     <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">zvars</span><span class="p">,</span><span class="n">z_loadings</span><span class="p">[:,</span><span class="n">dim</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$W^* * R^2$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$W^*$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Loadings for Initial Conditions&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            
            <span class="n">rows_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
            <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="n">vars_to_plot</span><span class="o">=</span><span class="p">[</span><span class="n">which_var</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">which_var</span>
                    
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">dim</span><span class="p">][</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$W^* * R^2$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$W^*$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:,</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:,</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span> <span class="p">)</span>
                <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                <span class="n">phase_samples</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
                    <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                            <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>                    
                            <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> 
                        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                       <span class="c1"># ylim_=[mmvm_obj[&#39;Ws&#39;][dim,:].min()*1.2,mmvm_obj[&#39;Ws&#39;][dim,:].max()*1.2  ]</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                            <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>                                    
                            <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>            
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
            <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
            
        <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="p">[</span><span class="n">which_var</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">which_var</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">dim</span><span class="p">][</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dat</span> <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;P * $R^2$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;P [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][:,</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][:,</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span> <span class="p">)</span>
            <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">phase_samples</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
                <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>                    
                        <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> 
                    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="c1">#ylim_=[mmvm_obj[&#39;P&#39;][dim,:].min()*1.2,mmvm_obj[&#39;P&#39;][dim,:].max()*1.2 ]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>                                    
                        <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   </div>

            
<div class="viewcode-block" id="loadings_abs_integral">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.loadings_abs_integral">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">loadings_abs_integral</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">r2_weighted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">addtitle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Plot the integral of the absolute value of loadings for a batch</span>
<span class="sd">    </span>
<span class="sd">    loadings_abs_integral(mmvm_obj,*,r2_weighted=False,addtitle=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mmvm_obj: A multiway PCA or PLS model</span>
<span class="sd">        r2_weighted: Boolean flag, if True then in weights the loading by the R2pv</span>
<span class="sd">        addtitle: Text to place in the title of the figure</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">])</span>
            
            <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rows_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
            <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
            
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">aux_vname</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)):</span>                
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">integral_of_loadings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux_vname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">integral_of_loadings</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">aux_vname</span><span class="p">,</span><span class="n">integral_of_loadings</span><span class="p">[:,</span><span class="n">a</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sum (|W^*| * R^2$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;])&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sum (|W^*|$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;])&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">addtitle</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
                
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
            <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
            
        <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
       
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">aux_vname</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)):</span>                  
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">integral_of_loadings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux_vname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">integral_of_loadings</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">aux_vname</span><span class="p">,</span><span class="n">integral_of_loadings</span><span class="p">[:,</span><span class="n">a</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sum (|P| * R^2$ [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;])&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sum$ (|P| [&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;])&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">addtitle</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   </div>


<div class="viewcode-block" id="batch_vip">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.batch_vip">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">batch_vip</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">addtitle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; plot the summation across componets of the integral of the absolute value of loadings for a batch</span>
<span class="sd">    multiplied by the R2 [which kinda mimicks the VIP]</span>
<span class="sd">    </span>
<span class="sd">    batch_vip(mmvm_obj,*,addtitle=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mmvm_obj: A multiway PCA or PLS model</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r2_weighted</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2y&#39;</span><span class="p">],(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">])</span>
            
            <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rows_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
            <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
            
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">aux_vname</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)):</span>                
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">integral_of_loadings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux_vname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">integral_of_loadings</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">aux_vname</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">integral_of_loadings</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Batch VIP&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">addtitle</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
                
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r2_weighted</span><span class="p">:</span>
            <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>
            
        <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
       
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">aux_vname</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)):</span>                  
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">integral_of_loadings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">aux_vname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">integral_of_loadings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">integral_of_loadings</span><span class="p">)</span>
        

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">aux_vname</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">integral_of_loadings</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sum_</span><span class="si">{a}</span><span class="s1"> \sum (|P| * R^2$&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">addtitle</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   </div>

            

<div class="viewcode-block" id="r2pv">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.r2pv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">r2pv</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">which_var</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Plot batch r2 for variables as a function of time/sample</span>
<span class="sd">    </span>
<span class="sd">    r2pv(mmvm_obj,*,which_var=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mmvm_obj:    Multiway PCA or PLS object</span>
<span class="sd">        which_var:   Variable for which the plot is done, if not sent all are plotted</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">])</span>
        <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="p">[</span><span class="n">which_var</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">which_var</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">):</span>
            
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mi">100</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>               
            <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="p">,</span><span class="n">dat</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dat</span><span class="p">[:,</span><span class="n">a</span><span class="p">],</span><span class="n">dat</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$R^2$pvX (%)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>                
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">phase_samples</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
                 <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
                 <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
                 <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                         <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                     <span class="k">else</span><span class="p">:</span>                    
                         <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> 
                     <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                     <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                         <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                     <span class="k">else</span><span class="p">:</span>                                    
                         <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>    
            <span class="n">r2pvy</span> <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>    
            <span class="c1">#yvars=mmvm_obj[&#39;varidY&#39;]</span>
            <span class="n">lbls</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">lbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                
            <span class="n">r2pvy_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r2pvy</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">lbls</span><span class="p">)</span>
            <span class="n">fig1</span><span class="p">,</span><span class="n">ax1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">r2pvy_pd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>            
            <span class="c1">#ax.set_xticks(rotation=90)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$R^2$pvY&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$R^2$ per LV for Y-Space&#39;</span><span class="p">)</span>
            <span class="n">fig1</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r2pvz</span>     <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]),:]</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">zvars</span>     <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]]</span>
        <span class="n">lbls</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">lbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">r2pvz_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r2pvz</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">zvars</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">lbls</span><span class="p">)</span>
        <span class="n">fig2</span><span class="p">,</span><span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">r2pvz_pd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>                    
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$R^2$pvZ&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$R^2$ Initial Conditions&#39;</span><span class="p">)</span>
        <span class="n">fig2</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="n">rows_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>
        <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">][</span><span class="n">rows_</span><span class="p">,:]</span> <span class="p">)</span>
        <span class="n">aux_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">aux_df</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="p">[</span><span class="n">which_var</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_var</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">vars_to_plot</span><span class="o">=</span><span class="n">which_var</span>
                
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">):</span>
            
            <span class="n">dat</span><span class="o">=</span><span class="n">aux_df</span><span class="p">[</span><span class="n">aux_df</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mi">100</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>               
            <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span> <span class="p">,</span><span class="n">dat</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dat</span><span class="p">[:,</span><span class="n">a</span><span class="p">],</span><span class="n">dat</span><span class="p">[:,</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$R^2$pvX (%)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>                
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="n">phase_samples</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
                 <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
                 <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
                 <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                         <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                     <span class="k">else</span><span class="p">:</span>                    
                         <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> 
                     <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                     <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                         <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                     <span class="k">else</span><span class="p">:</span>                                    
                         <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
            
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>
            <span class="n">r2pvy</span> <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;r2ypv&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>    
            <span class="c1">#yvars=mmvm_obj[&#39;varidY&#39;]</span>
            <span class="n">lbls</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">lbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LV #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                
            <span class="n">r2pvy_pd</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r2pvy</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">lbls</span><span class="p">)</span>
            <span class="n">fig1</span><span class="p">,</span><span class="n">ax1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">r2pvy_pd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>            
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$R^2$pvY&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;$R^2$ per LV for Y-Space&#39;</span><span class="p">)</span>
            <span class="n">fig1</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>            </div>

    
<div class="viewcode-block" id="mpca">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.mpca">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mpca</span><span class="p">(</span><span class="n">xbatch</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">unfolding</span><span class="o">=</span><span class="s1">&#39;batch wise&#39;</span><span class="p">,</span><span class="n">phase_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cross_val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Multi-way PCA for batch analysis</span>
<span class="sd">    </span>
<span class="sd">    mpca_obj= mpca(xbatch,a,*,unfolding=&#39;batch wise&#39;,phase_samples=False,cross_val=0)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        xbatch: Pandas dataframe with aligned batch data it is assumed </span>
<span class="sd">                 that all batches have the same number of samples</span>
<span class="sd">                </span>
<span class="sd">        a:      Number of PC&#39;s to fit</span>
<span class="sd">        </span>
<span class="sd">        unfolding: &#39;batch wise&#39; or &#39;variable wise&#39;</span>
<span class="sd">        </span>
<span class="sd">        phase_samples: information about samples per phase [optional]</span>
<span class="sd">        cross_val: percent of elements for cross validation (defult is 0 = no cross val)</span>

<span class="sd">    Returns:</span>
<span class="sd">        mpca_obj: A Dictionary with all the parameters for the MPCA model</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">    sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="n">xbatch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="n">xbatch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">nbatches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>    
    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">xbatch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">nbatches</span>
    
    <span class="k">if</span> <span class="n">unfolding</span><span class="o">==</span><span class="s1">&#39;batch wise&#39;</span><span class="p">:</span>        
        <span class="c1"># remove low variance columns keeping record of the original order</span>
        <span class="n">x_uf_</span><span class="p">,</span><span class="n">colnames</span><span class="p">,</span><span class="n">bid_o</span> <span class="o">=</span> <span class="n">unfold_horizontal</span><span class="p">(</span><span class="n">xbatch</span><span class="p">)</span>  <span class="c1"># colnames is original set of columns</span>
        <span class="n">x_uf</span><span class="p">,</span><span class="n">colsrem</span>         <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">clean_low_variances</span><span class="p">(</span><span class="n">x_uf_</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># colsrem are columns removed</span>
        <span class="n">mx_rem</span><span class="o">=</span><span class="n">x_uf_</span><span class="p">[</span><span class="n">colsrem</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">mx_rem</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mx_rem</span><span class="p">)</span>
        <span class="n">mpca_obj</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">x_uf</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">cross_val</span><span class="o">=</span><span class="n">cross_val</span><span class="p">)</span>    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colsrem</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">xtra_col</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="mi">1</span> <span class="p">))</span>    
            <span class="n">xtra_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">xtra_cols</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xtra_col</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">colsrem</span><span class="p">)))</span> 
            <span class="n">xtra_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mx_rem</span>
            <span class="n">aux</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">],</span><span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">],</span><span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">aux</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">aux</span><span class="p">,</span><span class="n">xtra_cols</span><span class="p">))</span>
            <span class="n">all_cols</span>    <span class="o">=</span> <span class="n">x_uf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">all_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">colsrem</span><span class="p">)</span>
            <span class="n">aux_pd</span>     <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">all_cols</span><span class="p">)</span>
            <span class="n">aux_pd</span>     <span class="o">=</span> <span class="n">aux_pd</span><span class="p">[</span><span class="n">colnames</span><span class="p">]</span>
            <span class="n">aux_new</span>    <span class="o">=</span> <span class="n">aux_pd</span><span class="o">.</span><span class="n">values</span>
            
            <span class="n">sx_</span>               <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">sx_</span>
            <span class="n">mx_</span>               <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">mx_</span>
            <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">2</span><span class="p">:,:]</span>
            <span class="n">p_</span>                <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">p_</span><span class="o">.</span><span class="n">T</span> 
            <span class="n">r2xpv_</span>            <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2xpv_</span><span class="o">.</span><span class="n">T</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">colnames</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">bid_o</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;uf&#39;</span><span class="p">]</span>    <span class="o">=</span><span class="s1">&#39;batch wise&#39;</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_samples</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nvars</span><span class="p">)</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;nbatches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbatches</span><span class="p">)</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">a</span>
            
    <span class="k">elif</span> <span class="n">unfolding</span><span class="o">==</span><span class="s1">&#39;variable wise&#39;</span><span class="p">:</span>
       
        <span class="k">if</span>  <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>    
             <span class="n">xbatch_</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
             <span class="n">xbatch_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">xbatch_</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xbatch_</span><span class="p">,</span><span class="n">colsrem</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">clean_low_variances</span><span class="p">(</span><span class="n">xbatch_</span><span class="p">)</span> <span class="c1"># colsrem are columns removed</span>
        <span class="n">xbatch_</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">clean_empty_rows</span><span class="p">(</span><span class="n">xbatch_</span><span class="p">)</span>
        <span class="n">mpca_obj</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">xbatch_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>        
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;uf&#39;</span><span class="p">]</span>            <span class="o">=</span><span class="s1">&#39;variable wise&#39;</span>
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_samples</span>
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">nvars</span>
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;nbatches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbatches</span>
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsamples</span>
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mpca_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">a</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mpca_obj</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">return</span> <span class="n">mpca_obj</span></div>

            
<span class="k">def</span><span class="w"> </span><span class="nf">_mimic_monitoring</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">,</span><span class="n">bdata</span><span class="p">,</span><span class="n">which_batch</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">soft_sensor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>   \
        <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Model and data do not correspond&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">T_mon</span>     <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ht2_mon</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spe_mon</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spei_mon</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cont_spei</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cont_spe</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cont_ht2</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">forecast</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj_f</span><span class="p">:</span>
            <span class="n">forecast_y</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">this_batch</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">which_batch</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
            <span class="n">colnames</span><span class="o">=</span><span class="n">this_batch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colnames</span><span class="o">=</span><span class="n">this_batch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            
        <span class="n">ss_indx</span><span class="o">=</span><span class="p">[]</span>    
        <span class="c1">#Make soft_sensor var all missing data</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">soft_sensor</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">soft_sensor</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">soft_sensor</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Soft sensor &#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39; is not a variable in this dataset&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ss_indx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">soft_sensor</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">soft_sensor</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Soft sensor &#39;</span><span class="o">+</span><span class="n">soft_sensor</span><span class="o">+</span><span class="s1">&#39; is not a variable in this dataset&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ss_indx</span><span class="o">=</span><span class="p">[</span><span class="n">colnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">soft_sensor</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">this_z</span> <span class="o">=</span> <span class="n">zinit</span><span class="p">[</span><span class="n">zinit</span><span class="p">[</span><span class="n">zinit</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">which_batch</span><span class="p">]</span>
            <span class="n">vals_z</span> <span class="o">=</span> <span class="n">this_z</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">cols_z</span> <span class="o">=</span> <span class="n">this_z</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">vals_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals_z</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">vals_z</span> <span class="o">=</span> <span class="n">vals_z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">this_batch</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">this_batch</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>

            
        <span class="n">vals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss_indx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[:,</span><span class="n">ss_indx</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running batch: &#39;</span><span class="o">+</span><span class="n">which_batch</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj_f</span><span class="p">:</span>
            <span class="n">forecast_y</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">forecast_y_</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]):</span>
            <span class="n">x_uf_k</span>   <span class="o">=</span> <span class="n">vals</span><span class="p">[:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
            <span class="n">x_uf_k</span>   <span class="o">=</span> <span class="n">x_uf_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">num_nans</span> <span class="o">=</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">)</span>
            <span class="n">x_uf_k</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="n">num_nans</span> <span class="p">)</span>
            <span class="n">x_uf_k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj_f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">x_2_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">vals_z</span><span class="p">,</span><span class="n">x_uf_k</span><span class="p">))</span>
                    <span class="n">preds</span>    <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">x_2_pred</span><span class="p">,</span> <span class="n">mmvm_obj_f</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>    
                    <span class="n">preds</span>    <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">,</span> <span class="n">mmvm_obj_f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model and data do not correspond&#39;</span><span class="p">)</span>
                    <span class="n">preds</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">preds</span>    <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">pca_pred</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">,</span> <span class="n">mmvm_obj_f</span><span class="p">)</span>
            
            <span class="n">T_mon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Tnew&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ht2_mon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1">#spe_mon.append(preds[&#39;speX&#39;][0])</span>
            
      
            <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj_f</span><span class="p">:</span>
               <span class="n">forecast_y_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
               <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                   <span class="n">ninit</span><span class="o">=</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span>
                   <span class="n">preds_x</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">ninit</span><span class="p">:]</span>
                   <span class="n">preds_z</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:</span><span class="n">ninit</span><span class="p">]</span>
                   <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preds_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
                   <span class="n">forecast</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_df</span><span class="p">)</span>    
                   <span class="n">inst_preds</span> <span class="o">=</span> <span class="n">preds_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
                   <span class="n">inst_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_preds</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:]</span> <span class="p">)</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:]</span>
                   <span class="c1">#mean center current sample and current prediction for instantaneous SPE</span>
                   <span class="n">x_uf_k</span>     <span class="o">=</span> <span class="p">(</span><span class="n">x_uf_k</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:]</span> <span class="p">)</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][</span><span class="n">ninit</span><span class="p">:]</span> 
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
                   <span class="n">forecast</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_df</span><span class="p">)</span>        
                   <span class="n">inst_preds</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
                   <span class="n">inst_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_preds</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>
                   <span class="c1">#mean center current sample and current prediction for instantaneous SPE</span>
                   <span class="n">x_uf_k</span>     <span class="o">=</span> <span class="p">(</span><span class="n">x_uf_k</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
                <span class="n">forecast</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_df</span><span class="p">)</span>  
                <span class="n">inst_preds</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
                <span class="n">inst_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_preds</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>
                <span class="c1">#mean center current sample and current prediction for instantaneous SPE</span>
                <span class="n">x_uf_k</span>     <span class="o">=</span> <span class="p">(</span><span class="n">x_uf_k</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>
                
            <span class="n">inst_preds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">)]</span>    <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x_uf_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">)]</span>        <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">cont_ht2_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_2_pred</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cont_ht2_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_uf_k</span><span class="p">))</span>
            
            <span class="n">var_t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj_f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">x_2_pred_</span><span class="o">=</span> <span class="p">(</span><span class="n">x_2_pred</span><span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>
                        <span class="n">cont_ht2_</span><span class="o">+=</span> <span class="p">(</span><span class="n">x_2_pred_</span> <span class="o">*</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">var_t</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cont_ht2_</span><span class="o">+=</span> <span class="p">(</span><span class="n">x_uf_k</span>   <span class="o">*</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">var_t</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cont_ht2_</span><span class="o">+=</span> <span class="p">(</span><span class="n">x_uf_k</span> <span class="o">*</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][:,</span><span class="n">a</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">var_t</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">conts_ht2_z</span> <span class="o">=</span> <span class="n">cont_ht2_</span><span class="p">[:</span><span class="n">ninit</span><span class="p">]</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cont_ht2_</span><span class="p">[</span><span class="n">ninit</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>    
                <span class="n">cont_ht2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_df</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cont_ht2_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>    
                <span class="n">cont_ht2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_df</span><span class="p">)</span>
      
            <span class="n">spe_</span>       <span class="o">=</span> <span class="p">(</span><span class="n">inst_preds</span> <span class="o">-</span> <span class="n">x_uf_k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">aux_df</span>     <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">spe_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
            <span class="n">cont_spe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_df</span><span class="p">)</span>
            <span class="n">spe_mon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spe_</span><span class="p">))</span>
            
            <span class="n">inst_samp</span>  <span class="o">=</span> <span class="n">x_uf_k</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]]</span>
            <span class="n">inst_preds</span> <span class="o">=</span> <span class="n">inst_preds</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]:(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]]</span>
            <span class="n">spei_</span>      <span class="o">=</span> <span class="p">(</span><span class="n">inst_preds</span> <span class="o">-</span> <span class="n">inst_samp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            
            <span class="n">cont_spei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spei_</span><span class="p">)</span>
            <span class="n">spei_mon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spei_</span><span class="p">)</span> <span class="p">)</span>
         
        <span class="n">diags</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Batch&#39;</span><span class="p">:</span><span class="n">which_batch</span><span class="p">,</span><span class="s1">&#39;t_mon&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">T_mon</span><span class="p">),</span><span class="s1">&#39;HT2_mon&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ht2_mon</span><span class="p">),</span>
               <span class="s1">&#39;spe_mon&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spe_mon</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;cont_spe&#39;</span><span class="p">:</span><span class="n">cont_spe</span><span class="p">,</span>
               <span class="s1">&#39;spei_mon&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spei_mon</span><span class="p">),</span><span class="s1">&#39;cont_spei&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cont_spei</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">),</span>
               <span class="s1">&#39;cont_ht2&#39;</span><span class="p">:</span><span class="n">cont_ht2</span><span class="p">,</span><span class="s1">&#39;forecast&#39;</span><span class="p">:</span><span class="n">forecast</span><span class="p">}</span> 
        <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj_f</span><span class="p">:</span>
            <span class="n">forecast_y</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">forecast_y_</span><span class="p">),</span><span class="n">columns</span><span class="o">=</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span>
            <span class="n">diags</span><span class="p">[</span><span class="s1">&#39;forecast y&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">forecast_y</span>
            
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">))</span> <span class="ow">and</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">vals_z</span>  <span class="o">=</span> <span class="p">(</span><span class="n">vals_z</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">]</span> <span class="p">)</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">]</span>
                <span class="n">preds_z_</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds_z</span> <span class="o">-</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">]</span> <span class="p">)</span><span class="o">/</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][:</span><span class="n">ninit</span><span class="p">]</span>
                <span class="n">spe_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals_z</span> <span class="o">-</span> <span class="n">preds_z_</span><span class="p">)</span>
                <span class="n">cont_spe_z</span> <span class="o">=</span> <span class="n">spe_z</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">spe_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cont_spe_z</span><span class="p">)</span>
                <span class="n">cont_spe_z</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cont_spe_z</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">cols_z</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Vars&#39;</span><span class="p">])</span>
                <span class="n">conts_ht2_z</span> <span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">conts_ht2_z</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">cols_z</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Vars&#39;</span><span class="p">])</span>
                <span class="n">diags</span><span class="p">[</span><span class="s1">&#39;reconstructed z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds_z</span>
                <span class="n">diags</span><span class="p">[</span><span class="s1">&#39;spe z&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">spe_z</span>
                <span class="n">diags</span><span class="p">[</span><span class="s1">&#39;cont_spe_z&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">cont_spe_z</span>
                <span class="n">diags</span><span class="p">[</span><span class="s1">&#39;cont_ht2_z&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">conts_ht2_z</span>
        <span class="k">return</span> <span class="n">diags</span>  
   
<div class="viewcode-block" id="monitor">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.monitor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">monitor</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">,</span><span class="n">bdata</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">which_batch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">build_ci</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">soft_sensor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Routine to mimic the real-time monitoring of a batch given a model</span>
<span class="sd">    </span>
<span class="sd">    monitor(mmvm_obj,bdata,*,which_batch=False,zinit=False,build_ci=True,shush=False,soft_sensor=False):</span>
<span class="sd">     </span>
<span class="sd">  </span>
<span class="sd">     usage: 1st you need to run: monitor(mmvm_obj,bdata)  </span>
<span class="sd">                to mimic monitoring for all bdata batches and build CI</span>
<span class="sd">                these new parameters are written back to mmvm_obj</span>
<span class="sd">                </span>
<span class="sd">            Then you can run:</span>
<span class="sd">                </span>
<span class="sd">            diagnostics = monitor(mmvm_obj,bdata,which_batch=your_batchid) </span>
<span class="sd">                to mimic monitoring for your_batchid and will produce all dynamic metrics</span>
<span class="sd">                and forecasts</span>
<span class="sd">                </span>
<span class="sd">            diagnostics = monitor(mmvm_obj,bdata,which_batch=your_batchid,zinit=your_z_data)  </span>
<span class="sd">                to mimic monitoring for your_batchid  using initial conditions</span>
<span class="sd">                will produce all dynamic metrics and forecasts </span>
<span class="sd">                </span>
<span class="sd">            diagnostics = monitor(mmvm_obj,bdata,which_batch=your_batchid,soft_sensor=your_variable)  </span>
<span class="sd">                to mimic monitoring for your_batchid will produce all dynamic metrics </span>
<span class="sd">                and forecasts and produce soft-sensor predictions for your_variable</span>
<span class="sd">     Returns:</span>
<span class="sd">         </span>
<span class="sd">        diagnostics:A dictionary with all the monitoring diagnostics and contributions</span>

<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">        sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com           </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mmvm_obj_f</span>       <span class="o">=</span> <span class="n">mmvm_obj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mmvm_obj_f</span>       <span class="o">=</span> <span class="n">_uf_hor_mon_loadings</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">)</span>
    <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;mx_ufm&#39;</span><span class="p">]</span>
    <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;sx_ufm&#39;</span><span class="p">]</span>
    <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;P_ufm&#39;</span><span class="p">]</span>
    <span class="n">aux</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_batches</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>
        <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;W_ufm&#39;</span><span class="p">]</span>
        <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;Ws_ufm&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_batch</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">build_ci</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nbatches&#39;</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="p">):</span>
            <span class="n">SPE</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="n">SPEi</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">T</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nbatches&#39;</span><span class="p">]))</span>
            <span class="c1">#build confidence intervals and update model</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building real_time confidence intervals&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_batches</span><span class="p">):</span>
                <span class="n">diags</span> <span class="o">=</span> <span class="n">_mimic_monitoring</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">,</span><span class="n">bdata</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="n">zinit</span><span class="p">,</span><span class="n">soft_sensor</span><span class="o">=</span><span class="n">soft_sensor</span><span class="p">)</span>
                <span class="n">SPE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diags</span><span class="p">[</span><span class="s1">&#39;spe_mon&#39;</span><span class="p">])</span>
                <span class="n">SPEi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diags</span><span class="p">[</span><span class="s1">&#39;spei_mon&#39;</span><span class="p">])</span>
                <span class="n">T</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">diags</span><span class="p">[</span><span class="s1">&#39;t_mon&#39;</span><span class="p">]</span>
                
            <span class="c1">#calculate conf int for scores</span>
            <span class="n">t_mon_ci_95</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">t_mon_ci_99</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]):</span>
                <span class="n">t_rt_ci_95</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">t_rt_ci_99</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">t</span>          <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="n">a</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]):</span>
                    <span class="n">l95</span><span class="p">,</span><span class="n">l99</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">single_score_conf_int</span><span class="p">(</span><span class="n">t</span><span class="p">[:,[</span><span class="n">j</span><span class="p">]])</span>
                    <span class="n">t_rt_ci_95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l95</span><span class="p">)</span>
                    <span class="n">t_rt_ci_99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l99</span><span class="p">)</span>
                <span class="n">t_mon_ci_95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_rt_ci_95</span><span class="p">))</span>
                <span class="n">t_mon_ci_99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_rt_ci_99</span><span class="p">))</span>
            <span class="c1">#calculate conf. int for spe and HT2</span>
            
            <span class="c1">#HT2 limits</span>
            <span class="n">n</span>  <span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nbatches&#39;</span><span class="p">]</span>
            <span class="n">A</span><span class="o">=</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
            <span class="n">ht2_mon_ci_99</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">phi</span><span class="o">.</span><span class="n">f99</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span>
            <span class="n">ht2_mon_ci_95</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">)))</span><span class="o">*</span><span class="n">phi</span><span class="o">.</span><span class="n">f95</span><span class="p">(</span><span class="n">A</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="n">A</span><span class="p">))</span> 
  
            <span class="n">spe_mon_ci_95</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spe_mon_ci_99</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spei_mon_ci_95</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spei_mon_ci_99</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">SPE</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SPE</span><span class="p">)</span>
            <span class="n">SPEi</span>           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SPEi</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]):</span>
                <span class="n">l95</span><span class="p">,</span><span class="n">l99</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">spe_ci</span><span class="p">(</span><span class="n">SPE</span><span class="p">[:,[</span><span class="n">j</span><span class="p">]])</span>
                <span class="n">spe_mon_ci_95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l95</span><span class="p">)</span>
                <span class="n">spe_mon_ci_99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l99</span><span class="p">)</span>
                <span class="n">l95</span><span class="p">,</span><span class="n">l99</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">spe_ci</span><span class="p">(</span><span class="n">SPEi</span><span class="p">[:,[</span><span class="n">j</span><span class="p">]])</span>
                <span class="n">spei_mon_ci_95</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l95</span><span class="p">)</span>
                <span class="n">spei_mon_ci_99</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l99</span><span class="p">)</span>
                
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;t_mon_ci_95&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">t_mon_ci_95</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;t_mon_ci_99&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">t_mon_ci_99</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ht2_mon_ci_99&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">ht2_mon_ci_99</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ht2_mon_ci_95&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">ht2_mon_ci_95</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spe_mon_ci_95&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">spe_mon_ci_95</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spe_mon_ci_99&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">spe_mon_ci_99</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spei_mon_ci_95&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">spei_mon_ci_95</span>
            <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spei_mon_ci_99&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spei_mon_ci_99</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
            <span class="c1">#return mmvm_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This ain&#39;t the data this model was trained on&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;t_mon_ci_95&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No monitoring conf. int. have been calculated&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;for this model object please run: &quot;monitor(model_obj,training_data)&quot; &#39;</span><span class="p">)</span>
            <span class="n">has_ci</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_ci</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_batch</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">which_batch</span><span class="o">=</span><span class="p">[</span><span class="n">which_batch</span><span class="p">]</span>
        <span class="n">diags</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">allok</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">which_batch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="c1">#run monitoring on a batch</span>
                <span class="n">diags_</span> <span class="o">=</span><span class="n">_mimic_monitoring</span><span class="p">(</span><span class="n">mmvm_obj_f</span><span class="p">,</span><span class="n">bdata</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="n">zinit</span><span class="p">,</span><span class="n">soft_sensor</span><span class="o">=</span><span class="n">soft_sensor</span><span class="p">)</span>
                <span class="n">diags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diags_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Batch not found in data set&#39;</span><span class="p">)</span>
                <span class="n">allok</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">allok</span><span class="p">:</span>
        <span class="c1">#plot scores</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">which_batch</span><span class="p">):</span>
                    <span class="n">x_axis</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;t_mon&#39;</span><span class="p">][:,[</span><span class="n">a</span><span class="p">]]</span> <span class="p">)</span> <span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;t_mon&#39;</span><span class="p">][:,[</span><span class="n">a</span><span class="p">]],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">has_ci</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;t_mon_ci_95&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="o">-</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;t_mon_ci_95&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;t_mon_ci_99&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="o">-</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;t_mon_ci_99&#39;</span><span class="p">][</span><span class="n">a</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$t_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>     
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Real time monitoring: Score plot $t_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>                                
                <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>   

                
            <span class="c1">#plot ht2</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">which_batch</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;HT2_mon&#39;</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="n">xlim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">has_ci</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">xlim_</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ht2_mon_ci_95&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ht2_mon_ci_95&#39;</span><span class="p">]],</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">xlim_</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ht2_mon_ci_99&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ht2_mon_ci_99&#39;</span><span class="p">]],</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Hotelling&#39;s $T^2$&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Real time monitoring: Hotelling&#39;s $T^2$&quot;</span><span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>             
            
            <span class="c1">#plot spe</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">which_batch</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;spe_mon&#39;</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="n">xlim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">has_ci</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spe_mon_ci_95&#39;</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spe_mon_ci_99&#39;</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Global SPE&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Real time monitoring: Global SPE&quot;</span><span class="p">)</span>
            
            <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span> 
            <span class="c1">#plot spei</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">which_batch</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;spei_mon&#39;</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                <span class="n">xlim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">has_ci</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spei_mon_ci_95&#39;</span><span class="p">],</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;spei_mon_ci_99&#39;</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Instantaneous SPE&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Real time monitoring: Instantaneous SPE&quot;</span><span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span> 
            
            <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diags</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;forecast y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">which_batch</span><span class="p">):</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span><span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;forecast y&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sample&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Dynamic forecast of Y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diags</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">diags</span><span class="o">=</span><span class="n">diags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">diags</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;error batch not found&#39;</span></div>


<div class="viewcode-block" id="mpls">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.mpls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mpls</span><span class="p">(</span><span class="n">xbatch</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">phase_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">mb_each_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cross_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cross_val_X</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Multi-way PLS for batch analysis</span>
<span class="sd">    </span>
<span class="sd">    mpls_obj = mpls(xbatch,y,a,*,zinit=False,phase_samples=False,mb_each_var=False,cross_val=0,cross_val_X=False):</span>

<span class="sd">    Args:</span>
<span class="sd">        xbatch: Pandas dataframe with aligned batch data it is assumed </span>
<span class="sd">                 that all batches have the same number of samples</span>
<span class="sd">                 </span>
<span class="sd">        y     : Response to predict, one row per batch</span>
<span class="sd">                </span>
<span class="sd">        a:      Number of PC&#39;s to fit</span>
<span class="sd">        </span>
<span class="sd">        zinit: Initial conditions &lt;optional&gt;</span>
<span class="sd">        </span>
<span class="sd">        phase_samples: alignment information</span>
<span class="sd">        </span>
<span class="sd">        mb_each_var: if &quot;True&quot; will make each variable measured a block</span>
<span class="sd">                     otherwise zinit is one block and xbatch another</span>
<span class="sd">    Returns:</span>
<span class="sd">        mpls_obj: A dictionary with all the parameters of the MPLS model</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">        sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com   </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="n">xbatch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="n">xbatch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">nbatches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>    
    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">xbatch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">nbatches</span>
    
    <span class="c1"># remove low variance columns keeping record of the original order</span>
    <span class="n">x_uf_</span><span class="p">,</span><span class="n">colnames</span><span class="p">,</span><span class="n">bid_o</span> <span class="o">=</span> <span class="n">unfold_horizontal</span><span class="p">(</span><span class="n">xbatch</span><span class="p">)</span>  <span class="c1"># colnames is original set of columns</span>
    <span class="n">x_uf</span><span class="p">,</span><span class="n">colsrem</span>        <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">clean_low_variances</span><span class="p">(</span><span class="n">x_uf_</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># colsrem are columns removed</span>
    <span class="n">mx_rem</span><span class="o">=</span><span class="n">x_uf_</span><span class="p">[</span><span class="n">colsrem</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">mx_rem</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mx_rem</span><span class="p">)</span>
    <span class="n">aux</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colnames</span><span class="p">,</span><span class="n">bid_o</span><span class="p">])</span>
    <span class="n">col_names_bid_pd</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aux</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;col name&#39;</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
    <span class="n">col_names_bid_pd_</span> <span class="o">=</span> <span class="n">col_names_bid_pd</span><span class="p">[</span><span class="n">col_names_bid_pd</span><span class="p">[</span><span class="s1">&#39;col name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_uf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>
    <span class="c1">#bid               = col_names_bid_pd_[&#39;bid&#39;].values # bid is vector indicating to what variable each col belongs </span>
    <span class="c1">#                                                   # useful in figuring out the blocks</span>
    <span class="n">aux</span><span class="o">=</span><span class="n">col_names_bid_pd_</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_bid</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>                                                   
    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="n">zinit</span><span class="p">,</span><span class="n">rc</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">clean_low_variances</span><span class="p">(</span><span class="n">zinit</span><span class="p">)</span>
        <span class="n">zcols</span><span class="o">=</span><span class="n">zinit</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">XMB</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Initial Conditions&#39;</span><span class="p">:</span><span class="n">zinit</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">XMB</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">mb_each_var</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unique_bid</span><span class="p">:</span>
           <span class="n">these_cols</span><span class="o">=</span><span class="p">[</span><span class="n">x_uf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
           <span class="n">these_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">col_names_bid_pd_</span><span class="p">[</span><span class="s1">&#39;col name&#39;</span><span class="p">][</span><span class="n">col_names_bid_pd_</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
           <span class="n">varblock</span><span class="o">=</span><span class="n">x_uf</span><span class="p">[</span><span class="n">these_cols</span><span class="p">]</span>
           <span class="n">XMB</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">varblock</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;Trajectories&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x_uf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XMB</span> <span class="o">=</span> <span class="n">x_uf</span>
            
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="nb">dict</span><span class="p">)):</span>
        <span class="n">mpls_obj</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pls</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">cross_val</span><span class="o">=</span><span class="n">cross_val</span><span class="p">,</span><span class="n">cross_val_X</span><span class="o">=</span><span class="n">cross_val_X</span><span class="p">,</span><span class="n">force_nipals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">yhat</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">mpls_obj</span><span class="p">)</span>
        <span class="n">yhat</span><span class="o">=</span><span class="n">yhat</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">mpls_obj</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">mbpls</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">cross_val_</span><span class="o">=</span><span class="n">cross_val</span><span class="p">,</span><span class="n">cross_val_X_</span><span class="o">=</span><span class="n">cross_val_X</span><span class="p">,</span><span class="n">force_nipals_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
        <span class="n">yhat</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">mpls_obj</span><span class="p">)</span>
        <span class="n">yhat</span><span class="o">=</span><span class="n">yhat</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colsrem</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>    
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">ninit_vars</span><span class="o">=</span><span class="n">zinit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">z_sx</span>   <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z_mx</span>   <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z_ws</span>   <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">),:]</span>   
            <span class="n">z_w</span>    <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">),:]</span>   
            <span class="n">z_p</span>    <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">),:]</span>   
            <span class="n">z_r2pv</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">),:]</span>   
            <span class="n">xc_</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninit_vars</span><span class="p">,</span><span class="n">x_uf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ninit_vars</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
            <span class="n">xuf_sx</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">][</span><span class="n">xc_</span><span class="p">]</span>
            <span class="n">xuf_mx</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">][</span><span class="n">xc_</span><span class="p">]</span>
            <span class="n">xuf_ws</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">][</span><span class="n">xc_</span><span class="p">,:]</span>     
            <span class="n">xuf_w</span>  <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="n">xc_</span><span class="p">,:]</span>
            <span class="n">xuf_p</span>  <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">xc_</span><span class="p">,:]</span>   
            <span class="n">xuf_r2pv</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">][</span><span class="n">xc_</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xuf_sx</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>
            <span class="n">xuf_mx</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span>
            <span class="n">xuf_ws</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span>   
            <span class="n">xuf_w</span>  <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> 
            <span class="n">xuf_p</span>  <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> 
            <span class="n">xuf_r2pv</span> <span class="o">=</span> <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span>
        

        <span class="c1">#add removed columns with mean of zero and stdev =1 and loadings = 0</span>
        <span class="n">xtra_col</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="mi">1</span> <span class="p">))</span>    
        <span class="n">xtra_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">xtra_cols</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xtra_col</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">colsrem</span><span class="p">)))</span> 
        <span class="n">xtra_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mx_rem</span>
        <span class="n">aux</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xuf_sx</span><span class="p">,</span><span class="n">xuf_mx</span><span class="p">,</span><span class="n">xuf_ws</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">xuf_w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">xuf_p</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">xuf_r2pv</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">aux</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">aux</span><span class="p">,</span><span class="n">xtra_cols</span><span class="p">))</span>
        <span class="n">all_cols</span>    <span class="o">=</span> <span class="n">x_uf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">all_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">colsrem</span><span class="p">)</span>
        <span class="n">aux_pd</span>      <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">all_cols</span><span class="p">)</span>
        <span class="n">aux_pd</span>      <span class="o">=</span> <span class="n">aux_pd</span><span class="p">[</span><span class="n">colnames</span><span class="p">]</span>
        <span class="n">aux_new</span>     <span class="o">=</span> <span class="n">aux_pd</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
             <span class="n">sx_</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">z_sx</span><span class="p">,</span><span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">sx_</span>
             <span class="n">mx_</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">z_mx</span><span class="p">,</span><span class="n">aux_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">mx_</span>
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">2</span><span class="p">:,:]</span>
             <span class="n">ws_</span>               <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">z_ws</span><span class="p">,</span><span class="n">ws_</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>         
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
             <span class="n">w_</span>                <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">z_w</span><span class="p">,</span><span class="n">w_</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>         
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
             <span class="n">p_</span>                <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">z_p</span><span class="p">,</span><span class="n">p_</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> 
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
             <span class="n">r2xpv_</span>            <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">z_r2pv</span><span class="p">,</span><span class="n">r2xpv_</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
             <span class="n">zcols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
             <span class="n">colnames</span><span class="o">=</span><span class="n">zcols</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">sx_</span>               <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">sx_</span>
             <span class="n">mx_</span>               <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;mx&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">mx_</span>
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">2</span><span class="p">:,:]</span>
             <span class="n">ws_</span>               <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;Ws&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">ws_</span><span class="o">.</span><span class="n">T</span>    
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
             <span class="n">w_</span>                <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">w_</span><span class="o">.</span><span class="n">T</span>    
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
             <span class="n">p_</span>                <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">p_</span><span class="o">.</span><span class="n">T</span>
             <span class="n">aux_new</span>           <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="n">a</span><span class="p">:,:]</span>
             <span class="n">r2xpv_</span>            <span class="o">=</span> <span class="n">aux_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">,:]</span>
             <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;r2xpv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2xpv_</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">yhat</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;varidX&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">colnames</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">bid_o</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;uf&#39;</span><span class="p">]</span>            <span class="o">=</span><span class="s1">&#39;batch wise&#39;</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nvars</span><span class="p">)</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;nbatches&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbatches</span><span class="p">)</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">a</span>
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;phase_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_samples</span>  
    <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;mb_each_var&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">mb_each_var</span>
        
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">zinit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mpls_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">mpls_obj</span>       </div>


<div class="viewcode-block" id="find">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.find">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span></div>

     
<div class="viewcode-block" id="clean_empty_rows">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.clean_empty_rows">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_empty_rows</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">shush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Cleans empty rows in batch data</span>
<span class="sd">    Input: </span>
<span class="sd">        X: Batch data to be cleaned of empty rows (all np.nan) DATAFRAME</span>
<span class="sd">    Output:</span>
<span class="sd">        X: Batch data Without observations removed</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span>  <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span> 
            <span class="n">X_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">ObsID_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">ObsID_</span> <span class="o">=</span> <span class="n">ObsID_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">X_</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">ObsID_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">ObsID_</span> <span class="o">=</span> <span class="n">ObsID_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                      
    <span class="c1">#find rows with all data missing</span>
    <span class="n">X_nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span>
    <span class="n">Xmiss</span> <span class="o">=</span> <span class="n">X_nan_map</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">Xmiss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Xmiss</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">Xmiss</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">shush</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing row from &#39;</span><span class="p">,</span> <span class="n">ObsID_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39; due to 100% missing data&#39;</span><span class="p">)</span>

        <span class="n">X_</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">X_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">X</span></div>

    
<div class="viewcode-block" id="phase_sampling_dist">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.phase_sampling_dist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phase_sampling_dist</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">time_column</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">addtitle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">use_phases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Count and plot a histogram of the distribution of  samples (or time if time_column is indicated)</span>
<span class="sd">    consumed per phase on a batch dataset</span>
<span class="sd">    </span>
<span class="sd">    phase_sampling_dist(bdata,time_column=False,addtitle=False,use_phases=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        </span>
<span class="sd">        bdata: Batch data organized as: column[0] = Batch Identifier column name is unrestricted</span>
<span class="sd">                                        column[1] = Phase information per sample must be called &#39;Phase&#39;,&#39;phase&#39;, or &#39;PHASE&#39;</span>
<span class="sd">                                                    this information is optional</span>
<span class="sd">                                        column[2:]= Variables measured throughout the batch</span>
<span class="sd">        time_column: Indicates the name of the column with time, if not sent, counting is done in terms samples</span>
<span class="sd">        </span>
<span class="sd">        add_title:  Optional text to be placed as the figure title</span>
<span class="sd">        use_phases: In case the user wants to only do counting for a subset of phases</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">        sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com   </span>
<span class="sd">        </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">if</span> <span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span> <span class="ow">or</span> <span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span> <span class="ow">or</span> <span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">:</span>        
        <span class="n">bids</span>   <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_phases</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">use_phases</span>
        
        <span class="c1">#samps_per_phase=[]</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
            <span class="n">totsamps</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">samps_</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">samps_ind</span><span class="o">=</span><span class="p">{}</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bids</span><span class="p">:</span>
              <span class="n">bdat</span><span class="o">=</span> <span class="n">bdata</span><span class="p">[</span> <span class="p">(</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">==</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">)]</span>
              <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdat</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                  <span class="n">samps_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                  <span class="n">samps_ind</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
              <span class="k">elif</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">time_column</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
                  <span class="n">samps_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bdat</span><span class="p">[</span><span class="n">time_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bdat</span><span class="p">[</span><span class="n">time_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                  <span class="n">totsamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bdata</span><span class="p">[</span><span class="n">time_column</span><span class="p">][(</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                  <span class="n">samps_ind</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">bdat</span><span class="p">[</span><span class="n">time_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bdat</span><span class="p">[</span><span class="n">time_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
              <span class="k">else</span><span class="p">:</span>    
                  <span class="n">samps_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bdat</span><span class="p">))</span>
                  <span class="n">totsamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">[(</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">)]))</span>                  
                  <span class="n">samps_ind</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bdat</span><span class="p">)</span>                  
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samps_</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">samps_ind</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">time_column</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">time_column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;# Samples&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">totsamps</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">time_column</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">time_column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;# Samples&#39;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">addtitle</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">addtitle</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>           
        <span class="k">return</span> <span class="n">data</span>            
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data is missing phase information or phase column is nor properly labeled&#39;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="predict">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.predict">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">xbatch</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">zinit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Generate predictions for a Multi-way PCA/PLS model</span>
<span class="sd">    </span>
<span class="sd">    predictions = predict(xbatch,mmvm_obj,*,zinit=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        xbatch:   Batch data with same variables and alignment as model will generate predictions for all batches</span>
<span class="sd">        mmvm_obj: Multi-way PLS or PCA</span>
<span class="sd">        zinit:    Initial conditions [if any]</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        preds: A dictionary with keys [&#39;Yhat&#39;, &#39;Xhat&#39;, &#39;Tnew&#39;, &#39;speX&#39;, &#39;T2&#39;]</span>
<span class="sd">   </span>
<span class="sd">            </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">        sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com   </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">mmvm_obj</span><span class="p">:</span>    
        <span class="n">x_uf</span><span class="p">,</span><span class="n">colnames</span><span class="p">,</span><span class="n">bid_o</span> <span class="o">=</span> <span class="n">unfold_horizontal</span><span class="p">(</span><span class="n">xbatch</span><span class="p">)</span>  <span class="c1"># colnames is original set of columns        </span>
        <span class="n">aux</span>                 <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colnames</span><span class="p">,</span><span class="n">bid_o</span><span class="p">])</span>
        <span class="n">col_names_bid_pd</span>    <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aux</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;col name&#39;</span><span class="p">,</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>        
        <span class="c1">#bid                 = col_names_bid_pd[&#39;bid&#39;].values # bid is vector indicating to what variable each col belongs </span>
        <span class="c1">#                                                    # useful in figuring out the blocks</span>
        <span class="n">aux</span><span class="o">=</span><span class="n">col_names_bid_pd</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="n">unique_bid</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>   
            
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">XMB</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Initial Conditions&#39;</span><span class="p">:</span><span class="n">zinit</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XMB</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;mb_each_var&#39;</span><span class="p">]:</span>
            
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unique_bid</span><span class="p">:</span>
               <span class="n">these_cols</span><span class="o">=</span><span class="p">[</span><span class="n">x_uf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
               <span class="n">these_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">col_names_bid_pd</span><span class="p">[</span><span class="s1">&#39;col name&#39;</span><span class="p">][</span><span class="n">col_names_bid_pd</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
               <span class="n">varblock</span><span class="o">=</span><span class="n">x_uf</span><span class="p">[</span><span class="n">these_cols</span><span class="p">]</span>
               <span class="n">XMB</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">varblock</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
                <span class="n">XMB</span><span class="p">[</span><span class="s1">&#39;Trajectories&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x_uf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">XMB</span> <span class="o">=</span> <span class="n">x_uf</span>           
        <span class="n">pred</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pls_pred</span><span class="p">(</span><span class="n">XMB</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">zinit</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">Zhat</span><span class="o">=</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">][:,:</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]]</span>            
            <span class="n">Xhat</span><span class="o">=</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">][:,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;ninit&#39;</span><span class="p">]:]</span>
            <span class="n">Xb</span><span class="o">=</span><span class="n">refold_horizontal</span><span class="p">(</span><span class="n">Xhat</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span> 
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>                
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>                
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Xb</span>
            
            
            <span class="n">Zhat_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Zhat</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">zinit</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">Zhat_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zinit</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zinit</span><span class="p">[</span><span class="n">zinit</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>    
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Zhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Zhat_df</span>
            
            <span class="n">test</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>            
            <span class="n">Y_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span>                
            <span class="n">Y_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">test</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">test</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>                
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Y_df</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xb</span><span class="o">=</span><span class="n">refold_horizontal</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span> 
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>                
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>                
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Xb</span>
            <span class="n">test</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
            <span class="n">Y_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;varidY&#39;</span><span class="p">])</span>                
            <span class="n">Y_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">test</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">test</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>                
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Yhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Y_df</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;uf&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;batch wise&#39;</span><span class="p">:</span>
            <span class="n">x_uf</span><span class="p">,</span><span class="n">colnames</span><span class="p">,</span><span class="n">bid_o</span> <span class="o">=</span> <span class="n">unfold_horizontal</span><span class="p">(</span><span class="n">xbatch</span><span class="p">)</span>              
            <span class="n">pred</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pca_pred</span><span class="p">(</span><span class="n">x_uf</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">)</span>               
            <span class="n">Xb</span><span class="o">=</span><span class="n">refold_horizontal</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">],</span><span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span> 
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>                
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>                
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Xb</span>
        <span class="k">if</span> <span class="n">mmvm_obj</span><span class="p">[</span><span class="s1">&#39;uf&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;variable wise&#39;</span><span class="p">:</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>    
                 <span class="n">xbatch_</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                 <span class="n">xbatch_</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="n">xbatch_</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>            
            <span class="n">pred</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">pca_pred</span><span class="p">(</span><span class="n">xbatch_</span><span class="p">,</span><span class="n">mmvm_obj</span><span class="p">)</span>    
            <span class="n">Xb</span><span class="o">=</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span> 
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>                
                <span class="n">Xb</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xbatch</span><span class="p">[</span><span class="n">xbatch</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>      
            <span class="n">pred</span><span class="p">[</span><span class="s1">&#39;Xhat&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Xb</span>                   
    <span class="k">return</span> <span class="n">pred</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_plot_contribs</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">ylims</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">var_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">phase_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">alpha_</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">plot_title_</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Internal routine please use : contributions</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>    
            <span class="n">var_list</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="n">var_list</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
         <span class="n">var_list</span><span class="o">=</span><span class="p">[</span><span class="n">var_list</span><span class="p">]</span>    
         
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">bdata</span><span class="p">[[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
            <span class="n">data_</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">data_</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>   
            <span class="n">s_txt</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">s_lin</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>                    
                    <span class="n">s_lin</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_lin</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha_</span><span class="p">)</span>
                <span class="n">ylim_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s_txt</span><span class="p">,</span><span class="n">ylim_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>                                    
                    <span class="n">s_txt</span><span class="o">+=</span><span class="n">phase_samples</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylims</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plot_title_</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                    

<div class="viewcode-block" id="contributions">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.contributions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">contributions</span> <span class="p">(</span><span class="n">mmvmobj</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">cont_type</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">to_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">from_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">lv_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">phase_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dyn_conts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">plot_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Plot batch contribution plots to Scores, HT2 or SPE</span>
<span class="sd">    </span>
<span class="sd">    contributions (mmvmobj,X,cont_type,*,to_obs=False,from_obs=False,</span>
<span class="sd">                       lv_space=False,phase_samples=False,dyn_conts=False,which_var=False,</span>
<span class="sd">                       plot_title=&#39;&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mmvmobj= Multiway Model</span>
<span class="sd">        X      = batch data</span>
<span class="sd">        cont_type = &#39;scores&#39; | &#39;ht2&#39; | &#39;spe&#39;</span>
<span class="sd">        to_obs    = Observation to calculate contributions to</span>
<span class="sd">        from_obs  = Relative basis to calculate contributions to [for &#39;scores&#39; and &#39;ht2&#39; only]</span>
<span class="sd">                    if not sent the origin of the model us used as the base.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        contribution_vector</span>
<span class="sd">        </span>
<span class="sd">    by Salvador Garcia Munoz</span>
<span class="sd">        sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">#translate from batch numbers to indexes</span>
    <span class="c1">#Check logic and warn user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">):</span>
        <span class="n">bvars</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bvars</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="n">allok</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_obs</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Contribution calculations need a &quot;to_obs&quot; argument at minimum&#39;</span><span class="p">)</span>
        <span class="n">allok</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">if</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;spe&#39;</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For SPE contributions the &quot;from_obs&quot; argument is ignored&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">to_obs</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_obs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">from_obs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Contributions for groups of observations will be averaged&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;scores&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lv_space</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No dimensions specified, doing contributions across all dimensions&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allok</span><span class="p">:</span>
        <span class="c1">#find indexes to batch names</span>
        <span class="n">Xuf</span><span class="p">,</span><span class="n">var1</span><span class="p">,</span><span class="n">var2</span><span class="o">=</span><span class="n">unfold_horizontal</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">bnames</span><span class="o">=</span><span class="n">Xuf</span><span class="p">[</span><span class="n">Xuf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">to_o</span><span class="o">=</span><span class="p">[</span><span class="n">bnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">to_obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_obs</span><span class="p">))]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;scores&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;ht2&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">from_obs</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
                   <span class="n">from_o</span> <span class="o">=</span> <span class="p">[</span><span class="n">bnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">from_obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">from_obs</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                    <span class="n">from_o</span> <span class="o">=</span><span class="kc">False</span>
            <span class="n">cont_vec</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">contributions</span><span class="p">(</span><span class="n">mmvmobj</span><span class="p">,</span><span class="n">Xuf</span><span class="p">,</span><span class="n">cont_type</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">from_obs</span><span class="o">=</span><span class="n">from_o</span><span class="p">,</span><span class="n">to_obs</span><span class="o">=</span><span class="n">to_o</span><span class="p">,</span><span class="n">lv_space</span><span class="o">=</span><span class="n">lv_space</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cont_type</span><span class="o">==</span><span class="s1">&#39;spe&#39;</span><span class="p">:</span>
            <span class="n">cont_vec</span><span class="o">=</span><span class="n">phi</span><span class="o">.</span><span class="n">contributions</span><span class="p">(</span><span class="n">mmvmobj</span><span class="p">,</span><span class="n">Xuf</span><span class="p">,</span><span class="n">cont_type</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">from_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">to_obs</span><span class="o">=</span><span class="n">to_o</span><span class="p">)</span>
        <span class="n">ymin</span><span class="o">=</span><span class="n">cont_vec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ymax</span><span class="o">=</span><span class="n">cont_vec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1">#Plot contributions</span>
        <span class="k">if</span> <span class="n">dyn_conts</span><span class="p">:</span>
            <span class="n">batch_contribs</span><span class="o">=</span><span class="n">refold_horizontal</span><span class="p">(</span><span class="n">cont_vec</span><span class="p">,</span> <span class="n">mmvmobj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">],</span><span class="n">mmvmobj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span>
            <span class="n">batch_contribs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">batch_contribs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">bvars</span><span class="p">)</span>
            <span class="n">oids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Batch Contributions&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">batch_contribs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">batch_contribs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;BatchID&#39;</span><span class="p">,</span><span class="n">oids</span><span class="p">)</span>
            <span class="n">_plot_contribs</span><span class="p">(</span><span class="n">batch_contribs</span><span class="p">,(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span><span class="n">phase_samples</span><span class="o">=</span><span class="n">phase_samples</span><span class="p">,</span><span class="n">var_list</span><span class="o">=</span><span class="n">which_var</span><span class="p">,</span><span class="n">plot_title_</span><span class="o">=</span><span class="n">plot_title</span><span class="p">)</span>
            
        <span class="n">batch_contribs</span><span class="o">=</span><span class="n">refold_horizontal</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cont_vec</span><span class="p">),</span> <span class="n">mmvmobj</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">],</span><span class="n">mmvmobj</span><span class="p">[</span><span class="s1">&#39;nsamples&#39;</span><span class="p">])</span>
        <span class="n">batch_contribs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_contribs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bvars</span><span class="p">,</span> <span class="n">batch_contribs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Sigma$ (|Contribution to &#39;</span><span class="o">+</span><span class="n">cont_type</span><span class="o">+</span><span class="s1">&#39;| )&#39;</span> <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="build_rel_time">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.build_rel_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_rel_time</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">time_unit</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Converts the column &#39;Timestamp&#39; into &#39;Time&#39; in time_units relative to</span>
<span class="sd">     the start of each batch</span>
<span class="sd">     </span>
<span class="sd">     bdata_new = build_rel_time(bdata,*,time_unit=&#39;min&#39;)</span>
<span class="sd">     </span>
<span class="sd">     </span>
<span class="sd">     by Salvador Garcia Munoz</span>
<span class="sd">         sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">         </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">aux</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">unique_batches</span><span class="o">=</span><span class="n">aux</span><span class="p">[</span><span class="n">aux</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">bdata_n</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unique_batches</span><span class="p">:</span>
        <span class="n">this_batch</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">=</span><span class="n">this_batch</span><span class="p">[</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">deltat</span><span class="o">=</span><span class="n">ts</span><span class="o">-</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tim</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="n">deltat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">deltat</span><span class="p">))]</span>
        <span class="n">tim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_unit</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">tim</span><span class="o">=</span><span class="n">tim</span><span class="o">/</span><span class="mi">60</span>
        <span class="k">if</span> <span class="n">time_unit</span> <span class="o">==</span> <span class="s1">&#39;hr&#39;</span><span class="p">:</span>
            <span class="n">tim</span><span class="o">=</span><span class="n">tim</span><span class="o">/</span><span class="mi">3600</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">this_batch</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">this_batch</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">),</span><span class="s1">&#39;Time (&#39;</span><span class="o">+</span><span class="n">time_unit</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="p">,</span><span class="n">tim</span><span class="p">)</span>
        <span class="n">this_batch</span><span class="o">=</span><span class="n">this_batch</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">bdata_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_batch</span><span class="p">)</span>
    <span class="n">bdata_n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">bdata_n</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bdata_n</span></div>


<div class="viewcode-block" id="descriptors">
<a class="viewcode-back" href="../../pyphi_batch.html#pyphi_batch.pyphi_batch.descriptors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">descriptors</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">which_var</span><span class="p">,</span><span class="n">desc</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">phase</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get descriptor values for a batch trajectory</span>
<span class="sd">    </span>
<span class="sd">    descriptors_df = descriptors(bdata,which_var,desc,*,phase=False)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bdata: Dataframe of batch data, first column is batch ID, second column can be phase id</span>
<span class="sd">        </span>
<span class="sd">        which_var: List of variables to get descriptors for</span>
<span class="sd">        </span>
<span class="sd">        desc: List of descriptors to calculate, options are:</span>
<span class="sd">                &#39;min&#39;</span>
<span class="sd">                &#39;max&#39;</span>
<span class="sd">                &#39;mean&#39;</span>
<span class="sd">                &#39;median&#39;</span>
<span class="sd">                &#39;std&#39;</span>
<span class="sd">                &#39;var&#39;</span>
<span class="sd">                &#39;range&#39;</span>
<span class="sd">                &#39;ave_slope&#39;</span>
<span class="sd">                </span>
<span class="sd">        phase: to specify what phases to do this for</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        descriptors: A dataframe with the descriptors per batch</span>
<span class="sd">        </span>
<span class="sd">     by Salvador Garcia Munoz</span>
<span class="sd">         sgarciam@imperial.ac.uk salvadorgarciamunoz@gmail.com</span>
<span class="sd">         </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">has_phase</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Phase&#39;</span><span class="p">)</span> <span class="ow">or</span> 
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span> <span class="ow">or</span> 
        <span class="p">(</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)):</span>
           <span class="n">has_phase</span><span class="o">=</span><span class="kc">True</span>
           <span class="n">phase_col</span><span class="o">=</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">has_phase</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot process phase flag without phase id in data&#39;</span><span class="p">)</span>
        <span class="n">phase</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">desc_val</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">desc_lbl</span><span class="o">=</span><span class="p">[]</span>    
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">this_batch</span><span class="o">=</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="p">[</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">desc_val_</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">which_var</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span> <span class="c1"># by phase</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">this_batch</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">this_batch</span><span class="p">[</span><span class="n">phase_col</span><span class="p">]</span><span class="o">==</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">))]</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>                           
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>                                                 
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;std&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;var&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;range&#39;</span><span class="p">:</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;ave_slope&#39;</span><span class="p">:</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                            <span class="n">m</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">values</span><span class="o">-</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>    
                            <span class="n">desc_lbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">p</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">d</span><span class="p">)</span>   
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="o">=</span><span class="n">this_batch</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values</span><span class="p">))]</span>                
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>                           
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>                                                 
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;std&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;var&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;range&#39;</span><span class="p">:</span>
                        <span class="n">desc_val_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;ave-slope&#39;</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                        <span class="n">m</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">values</span><span class="o">-</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">desc_val</span><span class="o">.</span><span class="n">apend</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>    
                        <span class="n">desc_lbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> 
                
        <span class="n">desc_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc_val_</span><span class="p">)</span>   
    <span class="n">bnames</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
    <span class="n">desc_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">desc_val</span><span class="p">)</span>
    <span class="n">descriptors_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">desc_val</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">desc_lbl</span> <span class="p">)</span>     
    <span class="n">descriptors_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bdata</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bnames</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">descriptors_df</span>                         </div>

                                
                        
                    
            
        
        
        
        
        
        
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Salvador Garcia Munoz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>